[
  {
    "sha": "42fbbb2a64be5efe7229a596538d4deb2c14e225",
    "filename": "service/src/integrationTest/java/uk/gov/hmcts/reform/fpl/controllers/support/MigrateCaseControllerTest.java",
    "status": "modified",
    "additions": 54,
    "deletions": 1,
    "changes": 55,
    "blob_url": "https://github.com/hmcts/fpl-ccd-configuration/blob/b4f3b5e98adeaa00dc3906a7270b97de0e67bddf/service/src/integrationTest/java/uk/gov/hmcts/reform/fpl/controllers/support/MigrateCaseControllerTest.java",
    "raw_url": "https://github.com/hmcts/fpl-ccd-configuration/raw/b4f3b5e98adeaa00dc3906a7270b97de0e67bddf/service/src/integrationTest/java/uk/gov/hmcts/reform/fpl/controllers/support/MigrateCaseControllerTest.java",
    "contents_url": "https://api.github.com/repos/hmcts/fpl-ccd-configuration/contents/service/src/integrationTest/java/uk/gov/hmcts/reform/fpl/controllers/support/MigrateCaseControllerTest.java?ref=b4f3b5e98adeaa00dc3906a7270b97de0e67bddf",
    "patch": "@@ -13,6 +13,7 @@\n import uk.gov.hmcts.reform.fpl.model.CaseData;\n import uk.gov.hmcts.reform.fpl.model.CaseNote;\n import uk.gov.hmcts.reform.fpl.model.HearingBooking;\n+import uk.gov.hmcts.reform.fpl.model.common.C2DocumentBundle;\n import uk.gov.hmcts.reform.fpl.model.common.Element;\n import uk.gov.hmcts.reform.fpl.model.order.HearingOrder;\n \n@@ -36,6 +37,59 @@\n         super(\"migrate-case\");\n     }\n \n+    @Nested\n+    class Fpla2871 {\n+        String familyManNumber = \"WR20C50015\";\n+        String migrationId = \"FPLA-2871\";\n+\n+        @Test\n+        void shouldRemoveFirstC2() {\n+\n+            Element<C2DocumentBundle> firstC2 = element(C2DocumentBundle.builder().description(\"test1\").build());\n+            Element<C2DocumentBundle> secondC2 = element(C2DocumentBundle.builder().description(\"test2\").build());\n+            CaseDetails caseDetails = asCaseDetails(CaseData.builder()\n+                .familyManCaseNumber(familyManNumber)\n+                .c2DocumentBundle(List.of(firstC2, secondC2))\n+                .build());\n+\n+            caseDetails.getData().put(\"migrationId\", migrationId);\n+\n+            CaseData extractedCaseData = extractCaseData(postAboutToSubmitEvent(caseDetails));\n+\n+            assertThat(extractedCaseData.getC2DocumentBundle()).containsOnly(secondC2);\n+        }\n+\n+        @Test\n+        void shouldDoNothingIfIncorrectFamilyNumber() {\n+            Element<C2DocumentBundle> firstC2 = element(C2DocumentBundle.builder().description(\"test1\").build());\n+            Element<C2DocumentBundle> secondC2 = element(C2DocumentBundle.builder().description(\"test2\").build());\n+\n+            CaseDetails caseDetails = asCaseDetails(CaseData.builder()\n+                .familyManCaseNumber(\"1234\")\n+                .c2DocumentBundle(List.of(firstC2, secondC2))\n+                .build());\n+\n+            caseDetails.getData().put(\"migrationId\", migrationId);\n+\n+            CaseData extractedCaseData = extractCaseData(postAboutToSubmitEvent(caseDetails));\n+\n+            assertThat(extractedCaseData.getC2DocumentBundle()).containsExactly(firstC2, secondC2);\n+        }\n+\n+        @Test\n+        void shouldThrowExceptionWhenNoC2s() {\n+            CaseDetails caseDetails = asCaseDetails(CaseData.builder()\n+                .familyManCaseNumber(familyManNumber)\n+                .build());\n+\n+            caseDetails.getData().put(\"migrationId\", migrationId);\n+\n+            assertThatThrownBy(() -> postAboutToSubmitEvent(caseDetails))\n+                .getRootCause()\n+                .hasMessage(\"No C2s on case\");\n+        }\n+    }\n+\n     @Nested\n     class Fpla2724 {\n         String familyManNumber = \"WR20C50007\";\n@@ -622,7 +676,6 @@ void shouldThrowAnExceptionIfCaseDoesNotContainDraftCaseManagementOrders() {\n                 .hasMessage(\"No draft case management orders in the case\");\n         }\n \n-\n         private CaseDetails caseDetails(String migrationId,\n                                         String familyManNumber,\n                                         List<Element<HearingOrder>> draftCaseManagementOrders,"
  },
  {
    "sha": "426545b8401836ae6c96628b0a14c84370451717",
    "filename": "service/src/main/java/uk/gov/hmcts/reform/fpl/controllers/support/MigrateCaseController.java",
    "status": "modified",
    "additions": 31,
    "deletions": 0,
    "changes": 31,
    "blob_url": "https://github.com/hmcts/fpl-ccd-configuration/blob/b4f3b5e98adeaa00dc3906a7270b97de0e67bddf/service/src/main/java/uk/gov/hmcts/reform/fpl/controllers/support/MigrateCaseController.java",
    "raw_url": "https://github.com/hmcts/fpl-ccd-configuration/raw/b4f3b5e98adeaa00dc3906a7270b97de0e67bddf/service/src/main/java/uk/gov/hmcts/reform/fpl/controllers/support/MigrateCaseController.java",
    "contents_url": "https://api.github.com/repos/hmcts/fpl-ccd-configuration/contents/service/src/main/java/uk/gov/hmcts/reform/fpl/controllers/support/MigrateCaseController.java?ref=b4f3b5e98adeaa00dc3906a7270b97de0e67bddf",
    "patch": "@@ -13,11 +13,14 @@\n import uk.gov.hmcts.reform.ccd.client.model.CaseDetails;\n import uk.gov.hmcts.reform.fpl.controllers.CallbackController;\n import uk.gov.hmcts.reform.fpl.model.CaseData;\n+import uk.gov.hmcts.reform.fpl.model.common.C2DocumentBundle;\n import uk.gov.hmcts.reform.fpl.model.common.Element;\n import uk.gov.hmcts.reform.fpl.model.order.HearingOrder;\n import uk.gov.hmcts.reform.fpl.service.document.ConfidentialDocumentsSplitter;\n import uk.gov.hmcts.reform.fpl.service.removeorder.DraftCMORemovalAction;\n \n+import java.util.List;\n+\n import static org.apache.commons.lang3.ObjectUtils.isEmpty;\n \n @Api\n@@ -55,6 +58,10 @@ public AboutToStartOrSubmitCallbackResponse handleAboutToSubmit(@RequestBody Cal\n             run2740(caseDetails);\n         }\n \n+        if (\"FPLA-2871\".equals(migrationId)) {\n+            run2871(caseDetails);\n+        }\n+\n         caseDetails.getData().remove(MIGRATION_ID_KEY);\n         return respond(caseDetails);\n     }\n@@ -99,6 +106,30 @@ private void run2705(CaseDetails caseDetails) {\n         }\n     }\n \n+    private void run2871(CaseDetails caseDetails) {\n+        CaseData caseData = getCaseData(caseDetails);\n+\n+        if (\"WR20C50015\".equals(caseData.getFamilyManCaseNumber())) {\n+            log.info(\"Attempting to remove first C2 from WR20C50015\");\n+            removeFirstC2(caseDetails);\n+            log.info(\"Successfully removed C2 from WR20C50015\");\n+        }\n+    }\n+\n+    private void removeFirstC2(CaseDetails caseDetails) {\n+        CaseData caseData = getCaseData(caseDetails);\n+        List<Element<C2DocumentBundle>> c2DocumentBundle = caseData.getC2DocumentBundle();\n+\n+        if (isEmpty(c2DocumentBundle)) {\n+            throw new IllegalArgumentException(\"No C2s on case\");\n+        }\n+\n+        c2DocumentBundle.remove(0);\n+\n+        caseDetails.getData().put(\"c2DocumentBundle\", c2DocumentBundle);\n+\n+    }\n+\n     private void removeFirstDraftCaseManagementOrder(CaseDetails caseDetails) {\n         CaseData caseData = getCaseData(caseDetails);\n "
  }
]

[
  {
    "sha": "48da3a1627bed359b062add2da2d89a584f99a1f",
    "filename": "components/application-mgt/org.wso2.carbon.identity.application.mgt/src/main/java/org/wso2/carbon/identity/application/mgt/ApplicationManagementServiceImpl.java",
    "status": "modified",
    "additions": 26,
    "deletions": 4,
    "changes": 30,
    "blob_url": "https://github.com/wso2/carbon-identity-framework/blob/0baae429b0a2b3512a3c2a1936acb4ae536bf81d/components/application-mgt/org.wso2.carbon.identity.application.mgt/src/main/java/org/wso2/carbon/identity/application/mgt/ApplicationManagementServiceImpl.java",
    "raw_url": "https://github.com/wso2/carbon-identity-framework/raw/0baae429b0a2b3512a3c2a1936acb4ae536bf81d/components/application-mgt/org.wso2.carbon.identity.application.mgt/src/main/java/org/wso2/carbon/identity/application/mgt/ApplicationManagementServiceImpl.java",
    "contents_url": "https://api.github.com/repos/wso2/carbon-identity-framework/contents/components/application-mgt/org.wso2.carbon.identity.application.mgt/src/main/java/org/wso2/carbon/identity/application/mgt/ApplicationManagementServiceImpl.java?ref=0baae429b0a2b3512a3c2a1936acb4ae536bf81d",
    "patch": "@@ -64,11 +64,13 @@\n import org.wso2.carbon.identity.application.mgt.defaultsequence.DefaultAuthSeqMgtService;\n import org.wso2.carbon.identity.application.mgt.defaultsequence.DefaultAuthSeqMgtServiceImpl;\n import org.wso2.carbon.identity.application.mgt.internal.ApplicationManagementServiceComponent;\n+import org.wso2.carbon.identity.application.mgt.internal.ApplicationManagementServiceComponentHolder;\n import org.wso2.carbon.identity.application.mgt.internal.ApplicationMgtListenerServiceComponent;\n import org.wso2.carbon.identity.application.mgt.listener.AbstractApplicationMgtListener;\n import org.wso2.carbon.identity.application.mgt.listener.ApplicationMgtListener;\n import org.wso2.carbon.identity.application.mgt.listener.ApplicationResourceManagementListener;\n import org.wso2.carbon.identity.application.mgt.validator.ApplicationValidatorManager;\n+import org.wso2.carbon.identity.claim.metadata.mgt.model.LocalClaim;\n import org.wso2.carbon.identity.core.util.IdentityConfigParser;\n import org.wso2.carbon.identity.core.util.IdentityTenantUtil;\n import org.wso2.carbon.identity.core.util.IdentityUtil;\n@@ -843,12 +845,21 @@ public IdentityProvider getIdentityProvider(String federatedIdPName, String tena\n         try {\n             startTenantFlow(tenantDomain);\n             String claimDialect = ApplicationMgtSystemConfig.getInstance().getClaimDialect();\n-            ClaimMapping[] claimMappings = CarbonContext.getThreadLocalCarbonContext().getUserRealm().getClaimManager()\n-                    .getAllClaimMappings(claimDialect);\n+\n             List<String> claimUris = new ArrayList<>();\n-            for (ClaimMapping claimMap : claimMappings) {\n-                claimUris.add(claimMap.getClaim().getClaimUri());\n+            if (UserCoreConstants.DEFAULT_CARBON_DIALECT.equalsIgnoreCase(claimDialect)) {\n+                // Local claims are retrieved via ClaimMetadataManagement service for consistency.\n+                List<LocalClaim> localClaims = ApplicationManagementServiceComponentHolder.getInstance()\n+                        .getClaimMetadataManagementService().getLocalClaims(tenantDomain);\n+                claimUris = getLocalClaimURIs(localClaims);\n+            } else {\n+                ClaimMapping[] claimMappings = CarbonContext.getThreadLocalCarbonContext().getUserRealm()\n+                        .getClaimManager().getAllClaimMappings(claimDialect);\n+                for (ClaimMapping claimMap : claimMappings) {\n+                    claimUris.add(claimMap.getClaim().getClaimUri());\n+                }\n             }\n+\n             String[] allLocalClaimUris = (claimUris.toArray(new String[claimUris.size()]));\n             if (ArrayUtils.isNotEmpty(allLocalClaimUris)) {\n                 Arrays.sort(allLocalClaimUris);\n@@ -2550,5 +2561,16 @@ private void setDisplayNamesOfLocalAuthenticators(ServiceProvider serviceProvide\n             }\n         }\n     }\n+\n+    private ArrayList<String> getLocalClaimURIs(List<LocalClaim> localClaims) {\n+\n+        // Using Java 8 streams to do the mapping will result in breaking at the axis level thus using the following\n+        // approach.\n+        ArrayList<String> localClaimsArray = new ArrayList<String>();\n+        for (LocalClaim localClaim : localClaims) {\n+            localClaimsArray.add(localClaim.getClaimURI());\n+        }\n+        return localClaimsArray;\n+    }\n }\n "
  },
  {
    "sha": "9c3434a7d233b47719e9721ff09a7961bf0f16fa",
    "filename": "components/application-mgt/org.wso2.carbon.identity.application.mgt/src/main/java/org/wso2/carbon/identity/application/mgt/internal/ApplicationManagementServiceComponent.java",
    "status": "modified",
    "additions": 19,
    "deletions": 0,
    "changes": 19,
    "blob_url": "https://github.com/wso2/carbon-identity-framework/blob/0baae429b0a2b3512a3c2a1936acb4ae536bf81d/components/application-mgt/org.wso2.carbon.identity.application.mgt/src/main/java/org/wso2/carbon/identity/application/mgt/internal/ApplicationManagementServiceComponent.java",
    "raw_url": "https://github.com/wso2/carbon-identity-framework/raw/0baae429b0a2b3512a3c2a1936acb4ae536bf81d/components/application-mgt/org.wso2.carbon.identity.application.mgt/src/main/java/org/wso2/carbon/identity/application/mgt/internal/ApplicationManagementServiceComponent.java",
    "contents_url": "https://api.github.com/repos/wso2/carbon-identity-framework/contents/components/application-mgt/org.wso2.carbon.identity.application.mgt/src/main/java/org/wso2/carbon/identity/application/mgt/internal/ApplicationManagementServiceComponent.java?ref=0baae429b0a2b3512a3c2a1936acb4ae536bf81d",
    "patch": "@@ -53,6 +53,7 @@\n import org.wso2.carbon.identity.application.mgt.listener.DefaultApplicationResourceMgtListener;\n import org.wso2.carbon.identity.application.mgt.validator.ApplicationValidator;\n import org.wso2.carbon.identity.application.mgt.validator.DefaultApplicationValidator;\n+import org.wso2.carbon.identity.claim.metadata.mgt.ClaimMetadataManagementService;\n import org.wso2.carbon.idp.mgt.listener.IdentityProviderMgtListener;\n import org.wso2.carbon.registry.core.service.RegistryService;\n import org.wso2.carbon.user.core.service.RealmService;\n@@ -338,4 +339,22 @@ private JSONObject parseCategoryMetadata(File categoryMetadataFile) {\n         categoriesObj.put(ApplicationConstants.UNCATEGORIZED, objForUncategorized);\n         return categoriesObj;\n     }\n+\n+    @Reference(\n+            name = \"claim.meta.mgt.service\",\n+            service = ClaimMetadataManagementService.class,\n+            cardinality = ReferenceCardinality.MANDATORY,\n+            policy = ReferencePolicy.DYNAMIC,\n+            unbind = \"unsetClaimMetaMgtService\"\n+    )\n+    protected void setClaimMetaMgtService(ClaimMetadataManagementService claimMetaMgtService) {\n+\n+        ApplicationManagementServiceComponentHolder.getInstance().setClaimMetadataManagementService(\n+                claimMetaMgtService);\n+    }\n+\n+    protected void unsetClaimMetaMgtService(ClaimMetadataManagementService claimMetaMgtService) {\n+\n+        ApplicationManagementServiceComponentHolder.getInstance().setClaimMetadataManagementService(null);\n+    }\n }"
  },
  {
    "sha": "2b7d631a0edbacbb49714954a20540bb6b5875de",
    "filename": "components/application-mgt/org.wso2.carbon.identity.application.mgt/src/main/java/org/wso2/carbon/identity/application/mgt/internal/ApplicationManagementServiceComponentHolder.java",
    "status": "modified",
    "additions": 14,
    "deletions": 0,
    "changes": 14,
    "blob_url": "https://github.com/wso2/carbon-identity-framework/blob/0baae429b0a2b3512a3c2a1936acb4ae536bf81d/components/application-mgt/org.wso2.carbon.identity.application.mgt/src/main/java/org/wso2/carbon/identity/application/mgt/internal/ApplicationManagementServiceComponentHolder.java",
    "raw_url": "https://github.com/wso2/carbon-identity-framework/raw/0baae429b0a2b3512a3c2a1936acb4ae536bf81d/components/application-mgt/org.wso2.carbon.identity.application.mgt/src/main/java/org/wso2/carbon/identity/application/mgt/internal/ApplicationManagementServiceComponentHolder.java",
    "contents_url": "https://api.github.com/repos/wso2/carbon-identity-framework/contents/components/application-mgt/org.wso2.carbon.identity.application.mgt/src/main/java/org/wso2/carbon/identity/application/mgt/internal/ApplicationManagementServiceComponentHolder.java?ref=0baae429b0a2b3512a3c2a1936acb4ae536bf81d",
    "patch": "@@ -19,6 +19,7 @@\n \n import org.wso2.carbon.consent.mgt.core.ConsentManager;\n import org.wso2.carbon.identity.application.mgt.AbstractInboundAuthenticatorConfig;\n+import org.wso2.carbon.identity.claim.metadata.mgt.ClaimMetadataManagementService;\n import org.wso2.carbon.registry.api.RegistryService;\n import org.wso2.carbon.user.core.service.RealmService;\n import org.wso2.carbon.utils.ConfigurationContextService;\n@@ -48,6 +49,8 @@\n \n     private ConsentManager consentManager;\n \n+    private ClaimMetadataManagementService claimMetadataManagementService;\n+\n     private ApplicationManagementServiceComponentHolder() {\n \n     }\n@@ -170,4 +173,15 @@ public ConsentManager getConsentManager() {\n \n         return consentManager;\n     }\n+\n+    public ClaimMetadataManagementService getClaimMetadataManagementService() {\n+\n+        return claimMetadataManagementService;\n+    }\n+\n+    public void setClaimMetadataManagementService(\n+            ClaimMetadataManagementService claimMetadataManagementService) {\n+\n+        this.claimMetadataManagementService = claimMetadataManagementService;\n+    }\n }"
  },
  {
    "sha": "8cd83ff65e8a93f4cf4a22f205bfec7199519553",
    "filename": "components/claim-mgt/org.wso2.carbon.identity.claim.metadata.mgt/src/main/java/org/wso2/carbon/identity/claim/metadata/mgt/ClaimMetadataManagementServiceImpl.java",
    "status": "modified",
    "additions": 6,
    "deletions": 3,
    "changes": 9,
    "blob_url": "https://github.com/wso2/carbon-identity-framework/blob/0baae429b0a2b3512a3c2a1936acb4ae536bf81d/components/claim-mgt/org.wso2.carbon.identity.claim.metadata.mgt/src/main/java/org/wso2/carbon/identity/claim/metadata/mgt/ClaimMetadataManagementServiceImpl.java",
    "raw_url": "https://github.com/wso2/carbon-identity-framework/raw/0baae429b0a2b3512a3c2a1936acb4ae536bf81d/components/claim-mgt/org.wso2.carbon.identity.claim.metadata.mgt/src/main/java/org/wso2/carbon/identity/claim/metadata/mgt/ClaimMetadataManagementServiceImpl.java",
    "contents_url": "https://api.github.com/repos/wso2/carbon-identity-framework/contents/components/claim-mgt/org.wso2.carbon.identity.claim.metadata.mgt/src/main/java/org/wso2/carbon/identity/claim/metadata/mgt/ClaimMetadataManagementServiceImpl.java?ref=0baae429b0a2b3512a3c2a1936acb4ae536bf81d",
    "patch": "@@ -34,7 +34,9 @@\n import org.wso2.carbon.identity.claim.metadata.mgt.model.LocalClaim;\n import org.wso2.carbon.identity.claim.metadata.mgt.util.ClaimConstants;\n import org.wso2.carbon.identity.core.util.IdentityTenantUtil;\n+import org.wso2.carbon.identity.core.util.IdentityUtil;\n import org.wso2.carbon.user.api.UserStoreException;\n+import org.wso2.carbon.user.core.UserCoreConstants;\n import org.wso2.carbon.utils.multitenancy.MultitenantConstants;\n \n import java.util.List;\n@@ -169,10 +171,11 @@ public void removeClaimDialect(ClaimDialect claimDialect, String tenantDomain) t\n \n         List<LocalClaim> localClaims = this.localClaimDAO.getLocalClaims(tenantId);\n \n-        // Add listener\n-\n+        // Add listener`\n \n-        return localClaims;\n+        return IdentityUtil.isGroupsVsRolesSeparationImprovementsEnabled() ? localClaims.stream().filter(\n+                localClaim -> !UserCoreConstants.ROLE_CLAIM.equals(localClaim.getClaimURI())).collect(\n+                Collectors.toList()) : localClaims;\n     }\n \n     @Override"
  },
  {
    "sha": "277aa5163f3ee47b4932d6b834785c1cf6f20831",
    "filename": "components/claim-mgt/org.wso2.carbon.identity.claim.metadata.mgt/src/main/java/org/wso2/carbon/identity/claim/metadata/mgt/DefaultClaimMetadataStore.java",
    "status": "modified",
    "additions": 25,
    "deletions": 0,
    "changes": 25,
    "blob_url": "https://github.com/wso2/carbon-identity-framework/blob/0baae429b0a2b3512a3c2a1936acb4ae536bf81d/components/claim-mgt/org.wso2.carbon.identity.claim.metadata.mgt/src/main/java/org/wso2/carbon/identity/claim/metadata/mgt/DefaultClaimMetadataStore.java",
    "raw_url": "https://github.com/wso2/carbon-identity-framework/raw/0baae429b0a2b3512a3c2a1936acb4ae536bf81d/components/claim-mgt/org.wso2.carbon.identity.claim.metadata.mgt/src/main/java/org/wso2/carbon/identity/claim/metadata/mgt/DefaultClaimMetadataStore.java",
    "contents_url": "https://api.github.com/repos/wso2/carbon-identity-framework/contents/components/claim-mgt/org.wso2.carbon.identity.claim.metadata.mgt/src/main/java/org/wso2/carbon/identity/claim/metadata/mgt/DefaultClaimMetadataStore.java?ref=0baae429b0a2b3512a3c2a1936acb4ae536bf81d",
    "patch": "@@ -481,6 +481,10 @@ public ClaimMapping getClaimMapping(String claimURI) throws UserStoreException {\n                 List<ClaimMapping> claimMappings = new ArrayList<>();\n \n                 for (LocalClaim localClaim : localClaims) {\n+                    if (isFilterableClaim(localClaim)) {\n+                        continue;\n+                    }\n+\n                     ClaimMapping claimMapping = ClaimMetadataUtils.convertLocalClaimToClaimMapping(localClaim, this\n                             .tenantId);\n                     claimMappings.add(claimMapping);\n@@ -546,6 +550,10 @@ public void updateClaimMapping(ClaimMapping claimMapping) throws UserStoreExcept\n             List<ClaimMapping> claimMappings = new ArrayList<>();\n \n             for (LocalClaim localClaim : localClaims) {\n+                if (isFilterableClaim(localClaim)) {\n+                    continue;\n+                }\n+\n                 ClaimMapping claimMapping = ClaimMetadataUtils.convertLocalClaimToClaimMapping(localClaim, this\n                         .tenantId);\n \n@@ -583,4 +591,21 @@ public void updateClaimMapping(ClaimMapping claimMapping) throws UserStoreExcept\n             throw new UserStoreException(e.getMessage(), e);\n         }\n     }\n+\n+    private boolean isFilterableClaim(LocalClaim localClaim) {\n+\n+        // Filter the local claim `role` when groups vs roles separation is enabled. This claim is\n+        // considered as a legacy claim going forward, thus `roles` and `groups` claims should be used\n+        // instead.\n+        if (IdentityUtil.isGroupsVsRolesSeparationImprovementsEnabled() && UserCoreConstants.ROLE_CLAIM.\n+                equals(localClaim.getClaimURI())) {\n+            if (log.isDebugEnabled()) {\n+                log.debug(\"Skipping the legacy role claim: \" + localClaim.getClaimURI() + \", when getting \" +\n+                        \"local claims\");\n+            }\n+            return true;\n+        }\n+\n+        return false;\n+    }\n }"
  },
  {
    "sha": "415110901bdcce1b1e42139a505b2fe9228c8595",
    "filename": "components/claim-mgt/org.wso2.carbon.identity.claim.metadata.mgt/src/main/java/org/wso2/carbon/identity/claim/metadata/mgt/dao/LocalClaimDAO.java",
    "status": "modified",
    "additions": 2,
    "deletions": 1,
    "changes": 3,
    "blob_url": "https://github.com/wso2/carbon-identity-framework/blob/0baae429b0a2b3512a3c2a1936acb4ae536bf81d/components/claim-mgt/org.wso2.carbon.identity.claim.metadata.mgt/src/main/java/org/wso2/carbon/identity/claim/metadata/mgt/dao/LocalClaimDAO.java",
    "raw_url": "https://github.com/wso2/carbon-identity-framework/raw/0baae429b0a2b3512a3c2a1936acb4ae536bf81d/components/claim-mgt/org.wso2.carbon.identity.claim.metadata.mgt/src/main/java/org/wso2/carbon/identity/claim/metadata/mgt/dao/LocalClaimDAO.java",
    "contents_url": "https://api.github.com/repos/wso2/carbon-identity-framework/contents/components/claim-mgt/org.wso2.carbon.identity.claim.metadata.mgt/src/main/java/org/wso2/carbon/identity/claim/metadata/mgt/dao/LocalClaimDAO.java?ref=0baae429b0a2b3512a3c2a1936acb4ae536bf81d",
    "patch": "@@ -26,7 +26,9 @@\n import org.wso2.carbon.identity.claim.metadata.mgt.util.ClaimConstants;\n import org.wso2.carbon.identity.claim.metadata.mgt.util.SQLConstants;\n import org.wso2.carbon.identity.core.util.IdentityDatabaseUtil;\n+import org.wso2.carbon.identity.core.util.IdentityUtil;\n import org.wso2.carbon.user.api.UserStoreException;\n+import org.wso2.carbon.user.core.UserCoreConstants;\n \n import java.sql.Connection;\n import java.sql.PreparedStatement;\n@@ -62,7 +64,6 @@\n             for (Map.Entry<Integer, Claim> claimEntry : localClaimMap.entrySet()) {\n                 int claimId = claimEntry.getKey();\n                 Claim claim = claimEntry.getValue();\n-\n                 List<AttributeMapping> attributeMappingsOfClaim = claimAttributeMappingsOfDialect.get(claimId);\n                 Map<String, String> propertiesOfClaim = claimPropertiesOfDialect.get(claimId);\n "
  },
  {
    "sha": "9b8e857c98c7bade50b637c2a34c4c14081220be",
    "filename": "components/idp-mgt/org.wso2.carbon.idp.mgt/pom.xml",
    "status": "modified",
    "additions": 5,
    "deletions": 0,
    "changes": 5,
    "blob_url": "https://github.com/wso2/carbon-identity-framework/blob/0baae429b0a2b3512a3c2a1936acb4ae536bf81d/components/idp-mgt/org.wso2.carbon.idp.mgt/pom.xml",
    "raw_url": "https://github.com/wso2/carbon-identity-framework/raw/0baae429b0a2b3512a3c2a1936acb4ae536bf81d/components/idp-mgt/org.wso2.carbon.idp.mgt/pom.xml",
    "contents_url": "https://api.github.com/repos/wso2/carbon-identity-framework/contents/components/idp-mgt/org.wso2.carbon.idp.mgt/pom.xml?ref=0baae429b0a2b3512a3c2a1936acb4ae536bf81d",
    "patch": "@@ -66,6 +66,10 @@\n             <groupId>org.json.wso2</groupId>\n             <artifactId>json</artifactId>\n         </dependency>\n+        <dependency>\n+            <groupId>org.wso2.carbon.identity.framework</groupId>\n+            <artifactId>org.wso2.carbon.identity.claim.metadata.mgt</artifactId>\n+        </dependency>\n     </dependencies>\n \n     <build>\n@@ -110,6 +114,7 @@\n                             org.wso2.carbon.identity.base;version=\"${carbon.identity.package.import.version.range}\",\n                             org.wso2.carbon.identity.role.mgt.core;version=\"${carbon.identity.package.import.version.range}\",\n                             org.wso2.carbon.identity.core.persistence;version=\"${carbon.identity.package.import.version.range}\",\n+                            org.wso2.carbon.identity.claim.metadata.mgt.*;version=\"${carbon.identity.package.import.version.range}\",\n                             org.wso2.carbon;version=\"${carbon.kernel.package.import.version.range}\",\n                             org.apache.commons.codec.binary; version=\"${commons-codec.wso2.osgi.version.range}\",\n                             org.json;version=\"${json.wso2.version.range}\","
  },
  {
    "sha": "745d71db8568e74e0ea027b1f5917561d19d9c01",
    "filename": "components/idp-mgt/org.wso2.carbon.idp.mgt/src/main/java/org/wso2/carbon/idp/mgt/IdentityProviderManagementService.java",
    "status": "modified",
    "additions": 22,
    "deletions": 12,
    "changes": 34,
    "blob_url": "https://github.com/wso2/carbon-identity-framework/blob/0baae429b0a2b3512a3c2a1936acb4ae536bf81d/components/idp-mgt/org.wso2.carbon.idp.mgt/src/main/java/org/wso2/carbon/idp/mgt/IdentityProviderManagementService.java",
    "raw_url": "https://github.com/wso2/carbon-identity-framework/raw/0baae429b0a2b3512a3c2a1936acb4ae536bf81d/components/idp-mgt/org.wso2.carbon.idp.mgt/src/main/java/org/wso2/carbon/idp/mgt/IdentityProviderManagementService.java",
    "contents_url": "https://api.github.com/repos/wso2/carbon-identity-framework/contents/components/idp-mgt/org.wso2.carbon.idp.mgt/src/main/java/org/wso2/carbon/idp/mgt/IdentityProviderManagementService.java?ref=0baae429b0a2b3512a3c2a1936acb4ae536bf81d",
    "patch": "@@ -27,12 +27,13 @@\n import org.wso2.carbon.identity.application.common.model.FederatedAuthenticatorConfig;\n import org.wso2.carbon.identity.application.common.model.IdentityProvider;\n import org.wso2.carbon.identity.application.common.model.ProvisioningConnectorConfig;\n+import org.wso2.carbon.identity.claim.metadata.mgt.exception.ClaimMetadataException;\n+import org.wso2.carbon.identity.claim.metadata.mgt.model.LocalClaim;\n import org.wso2.carbon.identity.core.util.IdentityUtil;\n+import org.wso2.carbon.idp.mgt.internal.IdpMgtServiceComponentHolder;\n import org.wso2.carbon.idp.mgt.model.IdpSearchResult;\n import org.wso2.carbon.idp.mgt.util.IdPManagementConstants;\n import org.wso2.carbon.idp.mgt.util.IdPManagementUtil;\n-import org.wso2.carbon.user.api.ClaimMapping;\n-import org.wso2.carbon.user.api.UserStoreException;\n \n import java.util.ArrayList;\n import java.util.Arrays;\n@@ -339,20 +340,18 @@ public void forceDeleteIdP(String idPName) throws IdentityProviderManagementExce\n     public String[] getAllLocalClaimUris() throws IdentityProviderManagementException {\n \n         try {\n-            String claimDialect = LOCAL_DEFAULT_CLAIM_DIALECT;\n-            ClaimMapping[] claimMappings = CarbonContext.getThreadLocalCarbonContext()\n-                    .getUserRealm().getClaimManager().getAllClaimMappings(claimDialect);\n-            List<String> claimUris = new ArrayList<String>();\n-            for (ClaimMapping claimMap : claimMappings) {\n-                claimUris.add(claimMap.getClaim().getClaimUri());\n-            }\n-            String[] allLocalClaimUris = claimUris.toArray(new String[0]);\n+            String tenantDomain = CarbonContext.getThreadLocalCarbonContext().getTenantDomain();\n+            List<LocalClaim> localClaims = IdpMgtServiceComponentHolder.getInstance()\n+                    .getClaimMetadataManagementService().getLocalClaims(tenantDomain);\n+\n+            String[] allLocalClaimUris = getLocalClaimsArray(localClaims);\n+\n             if (ArrayUtils.isNotEmpty(allLocalClaimUris)) {\n                 Arrays.sort(allLocalClaimUris);\n             }\n             return allLocalClaimUris;\n-        } catch (UserStoreException e) {\n-            String message = \"Error while reading system claims\";\n+        } catch (ClaimMetadataException e) {\n+            String message = \"Error while reading local claims\";\n             log.error(message, e);\n             throw new IdentityProviderManagementException(message, e);\n         }\n@@ -414,4 +413,15 @@ public String getResidentIDPMetadata() throws IdentityProviderManagementExceptio\n             throw idpException;\n         }\n     }\n+\n+    private String[] getLocalClaimsArray(List<LocalClaim> localClaims) {\n+\n+        // Using Java 8 streams to do the mapping will result in breaking at the axis level thus using the followng\n+        // approach.\n+        ArrayList<String> localClaimsArray = new ArrayList<String>();\n+        for (LocalClaim localClaim : localClaims) {\n+            localClaimsArray.add(localClaim.getClaimURI());\n+        }\n+        return localClaimsArray.toArray(new String[0]);\n+    }\n }"
  },
  {
    "sha": "28fd3712e4134a84818ac7aeb0e4f711619c37d3",
    "filename": "components/idp-mgt/org.wso2.carbon.idp.mgt/src/main/java/org/wso2/carbon/idp/mgt/internal/IdPManagementServiceComponent.java",
    "status": "modified",
    "additions": 18,
    "deletions": 0,
    "changes": 18,
    "blob_url": "https://github.com/wso2/carbon-identity-framework/blob/0baae429b0a2b3512a3c2a1936acb4ae536bf81d/components/idp-mgt/org.wso2.carbon.idp.mgt/src/main/java/org/wso2/carbon/idp/mgt/internal/IdPManagementServiceComponent.java",
    "raw_url": "https://github.com/wso2/carbon-identity-framework/raw/0baae429b0a2b3512a3c2a1936acb4ae536bf81d/components/idp-mgt/org.wso2.carbon.idp.mgt/src/main/java/org/wso2/carbon/idp/mgt/internal/IdPManagementServiceComponent.java",
    "contents_url": "https://api.github.com/repos/wso2/carbon-identity-framework/contents/components/idp-mgt/org.wso2.carbon.idp.mgt/src/main/java/org/wso2/carbon/idp/mgt/internal/IdPManagementServiceComponent.java?ref=0baae429b0a2b3512a3c2a1936acb4ae536bf81d",
    "patch": "@@ -35,6 +35,7 @@\n import org.wso2.carbon.base.MultitenantConstants;\n import org.wso2.carbon.identity.application.common.model.IdentityProvider;\n import org.wso2.carbon.identity.application.common.util.IdentityApplicationConstants;\n+import org.wso2.carbon.identity.claim.metadata.mgt.ClaimMetadataManagementService;\n import org.wso2.carbon.identity.core.ConnectorConfig;\n import org.wso2.carbon.identity.core.util.IdentityCoreInitializedEvent;\n import org.wso2.carbon.identity.core.util.IdentityTenantUtil;\n@@ -466,4 +467,21 @@ protected void unsetGovernanceConnector(ConnectorConfig identityConnectorConfig)\n \n         IdpMgtServiceComponentHolder.getInstance().unsetGovernanceConnector(identityConnectorConfig);\n     }\n+\n+    @Reference(\n+            name = \"claim.meta.mgt.service\",\n+            service = ClaimMetadataManagementService.class,\n+            cardinality = ReferenceCardinality.MANDATORY,\n+            policy = ReferencePolicy.DYNAMIC,\n+            unbind = \"unsetClaimMetaMgtService\"\n+    )\n+    protected void setClaimMetaMgtService(ClaimMetadataManagementService claimMetaMgtService) {\n+\n+        IdpMgtServiceComponentHolder.getInstance().setClaimMetadataManagementService(claimMetaMgtService);\n+    }\n+\n+    protected void unsetClaimMetaMgtService(ClaimMetadataManagementService claimMetaMgtService) {\n+\n+        IdpMgtServiceComponentHolder.getInstance().setClaimMetadataManagementService(null);\n+    }\n }"
  },
  {
    "sha": "631da3ba0eab9d2ecc265d575465fcd39724fdbf",
    "filename": "components/idp-mgt/org.wso2.carbon.idp.mgt/src/main/java/org/wso2/carbon/idp/mgt/internal/IdpMgtServiceComponentHolder.java",
    "status": "modified",
    "additions": 12,
    "deletions": 0,
    "changes": 12,
    "blob_url": "https://github.com/wso2/carbon-identity-framework/blob/0baae429b0a2b3512a3c2a1936acb4ae536bf81d/components/idp-mgt/org.wso2.carbon.idp.mgt/src/main/java/org/wso2/carbon/idp/mgt/internal/IdpMgtServiceComponentHolder.java",
    "raw_url": "https://github.com/wso2/carbon-identity-framework/raw/0baae429b0a2b3512a3c2a1936acb4ae536bf81d/components/idp-mgt/org.wso2.carbon.idp.mgt/src/main/java/org/wso2/carbon/idp/mgt/internal/IdpMgtServiceComponentHolder.java",
    "contents_url": "https://api.github.com/repos/wso2/carbon-identity-framework/contents/components/idp-mgt/org.wso2.carbon.idp.mgt/src/main/java/org/wso2/carbon/idp/mgt/internal/IdpMgtServiceComponentHolder.java?ref=0baae429b0a2b3512a3c2a1936acb4ae536bf81d",
    "patch": "@@ -23,6 +23,7 @@\n import org.wso2.carbon.identity.core.ConnectorConfig;\n import org.wso2.carbon.identity.core.util.IdentityTenantUtil;\n import org.wso2.carbon.identity.role.mgt.core.RoleManagementService;\n+import org.wso2.carbon.identity.claim.metadata.mgt.ClaimMetadataManagementService;\n import org.wso2.carbon.idp.mgt.IdentityProviderManagementException;\n import org.wso2.carbon.idp.mgt.dao.CacheBackedIdPMgtDAO;\n import org.wso2.carbon.idp.mgt.dao.IdPManagementDAO;\n@@ -50,6 +51,7 @@ public static IdpMgtServiceComponentHolder getInstance() {\n     private volatile List<ConnectorConfig> identityConnectorConfigList = new ArrayList<>();\n     private RegistryService registryService;\n     private RoleManagementService roleManagementService;\n+    private ClaimMetadataManagementService claimMetadataManagementService;\n \n     private List<MetadataConverter> metadataConverters = new ArrayList<>();\n \n@@ -139,4 +141,14 @@ public void setRoleManagementService(RoleManagementService roleManagementService\n \n         this.roleManagementService = roleManagementService;\n     }\n+\n+    public ClaimMetadataManagementService getClaimMetadataManagementService() {\n+\n+        return claimMetadataManagementService;\n+    }\n+\n+    public void setClaimMetadataManagementService(ClaimMetadataManagementService claimMetadataManagementService) {\n+\n+        this.claimMetadataManagementService = claimMetadataManagementService;\n+    }\n }"
  },
  {
    "sha": "ca0e627de146b30c87816e8e0adf5aefac51b86a",
    "filename": "features/claim-mgt/org.wso2.carbon.claim.mgt.server.feature/resources/conf/claim-config.xml",
    "status": "modified",
    "additions": 2,
    "deletions": 3,
    "changes": 5,
    "blob_url": "https://github.com/wso2/carbon-identity-framework/blob/0baae429b0a2b3512a3c2a1936acb4ae536bf81d/features/claim-mgt/org.wso2.carbon.claim.mgt.server.feature/resources/conf/claim-config.xml",
    "raw_url": "https://github.com/wso2/carbon-identity-framework/raw/0baae429b0a2b3512a3c2a1936acb4ae536bf81d/features/claim-mgt/org.wso2.carbon.claim.mgt.server.feature/resources/conf/claim-config.xml",
    "contents_url": "https://api.github.com/repos/wso2/carbon-identity-framework/contents/features/claim-mgt/org.wso2.carbon.claim.mgt.server.feature/resources/conf/claim-config.xml?ref=0baae429b0a2b3512a3c2a1936acb4ae536bf81d",
    "patch": "@@ -117,10 +117,9 @@\n \t\t\t</Claim>\n \t\t\t<Claim>\n \t\t\t\t<ClaimURI>http://wso2.org/claims/role</ClaimURI>\n-\t\t\t\t<DisplayName>Role</DisplayName>\n+\t\t\t\t<DisplayName>Roles and groups</DisplayName>\n \t\t\t\t<AttributeID>role</AttributeID>\n-\t\t\t\t<Description>Role</Description>\n-\t\t\t\t<SupportedByDefault/>\n+\t\t\t\t<Description>Include both userstore groups and internal roles</Description>\n \t\t\t\t<ReadOnly />\n \t\t\t</Claim>\n \t\t\t<Claim>"
  }
]

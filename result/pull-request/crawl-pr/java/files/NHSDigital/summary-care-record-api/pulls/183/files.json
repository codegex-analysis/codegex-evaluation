[
  {
    "sha": "23523f95e83eb1a6e34e5bed3994645b9f24a493",
    "filename": "docker/service/src/main/java/uk/nhs/adaptors/scr/clients/spine/SandboxSpineClient.java",
    "status": "modified",
    "additions": 58,
    "deletions": 13,
    "changes": 71,
    "blob_url": "https://github.com/NHSDigital/summary-care-record-api/blob/fbcfdbb1cf8f54d6ec6c13a3103f5971dfc9178a/docker/service/src/main/java/uk/nhs/adaptors/scr/clients/spine/SandboxSpineClient.java",
    "raw_url": "https://github.com/NHSDigital/summary-care-record-api/raw/fbcfdbb1cf8f54d6ec6c13a3103f5971dfc9178a/docker/service/src/main/java/uk/nhs/adaptors/scr/clients/spine/SandboxSpineClient.java",
    "contents_url": "https://api.github.com/repos/NHSDigital/summary-care-record-api/contents/docker/service/src/main/java/uk/nhs/adaptors/scr/clients/spine/SandboxSpineClient.java?ref=fbcfdbb1cf8f54d6ec6c13a3103f5971dfc9178a",
    "patch": "@@ -6,11 +6,18 @@\n import org.apache.http.Header;\n import org.apache.http.message.BasicHeader;\n import org.springframework.beans.factory.annotation.Autowired;\n-import org.springframework.core.io.ClassPathResource;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.core.io.Resource;\n import org.w3c.dom.Document;\n+import org.xml.sax.InputSource;\n+import org.xml.sax.SAXException;\n import uk.nhs.adaptors.scr.clients.spine.SpineHttpClient.Response;\n import uk.nhs.adaptors.scr.config.ScrConfiguration;\n import uk.nhs.adaptors.scr.models.ProcessingResult;\n+import uk.nhs.adaptors.scr.utils.XmlUtils;\n+\n+import java.io.IOException;\n+import java.io.StringReader;\n \n import static java.lang.Thread.sleep;\n import static java.nio.charset.StandardCharsets.UTF_8;\n@@ -23,17 +30,43 @@\n @RequiredArgsConstructor(onConstructor = @__(@Autowired))\n public class SandboxSpineClient implements SpineClientContract {\n \n-    private static final String ACS_SET_PERMISSION_RESPONSE = \"mock-spine/setConsent.xml\";\n-    private static final String EVENT_LIST_QUERY_RESPONSE = \"mock-spine/getScrId.xml\";\n-    private static final String EVENT_QUERY_RESPONSE = \"mock-spine/getScr.xml\";\n-    private static final String UPLOAD_SCR_POLLING_RESPONSE = \"mock-spine/uploadScrPolling.xml\";\n+    private static final String GET_SCR_ID_NHS_NUMBER_XPATH = \"//nHSNumber/value/@extension\";\n+    private static final String SET_ACS_NHS_NUMBER_XPATH =\n+        \"//*[local-name() = 'resourceContext' and @root = '2.16.840.1.113883.2.1.4.1']/@extension\";\n+\n+    private static final String EXISTING_NHS_NUMBER = \"9995000180\";\n+\n+    @Value(\"classpath:mock-spine/event-list-query/success.xml\")\n+    private Resource getScrIdSuccess;\n+\n+    @Value(\"classpath:mock-spine/event-list-query/noConsent.xml\")\n+    private Resource getScrIdNoConsent;\n+\n+    @Value(\"classpath:mock-spine/event-query/success.xml\")\n+    private Resource getScrSuccess;\n+\n+    @Value(\"classpath:mock-spine/acs/success.xml\")\n+    private Resource setAcsSuccess;\n+\n+    @Value(\"classpath:mock-spine/acs/incorrectNhsNumber.xml\")\n+    private Resource setAcsIncorrectNhsNumber;\n+\n+    @Value(\"classpath:mock-spine/upload-scr/pollingSuccess.txt\")\n+    private Resource pollingSuccess;\n \n     private final ScrConfiguration scrConfiguration;\n+    private final XmlUtils xmlUtils;\n \n     @SneakyThrows\n     @Override\n     public Response<Document> sendAcsData(String requestBody, String nhsdAsid) {\n-        return new Response(OK.value(), null, getResourceAsXmlDocument(ACS_SET_PERMISSION_RESPONSE));\n+        Document document = parseXml(requestBody);\n+        String nhsNumber = xmlUtils.getValueByXPath(document, SET_ACS_NHS_NUMBER_XPATH);\n+        if (EXISTING_NHS_NUMBER.equals(nhsNumber)) {\n+            return new Response(OK.value(), null, getResourceAsXmlDocument(setAcsSuccess));\n+        } else {\n+            return new Response(OK.value(), null, getResourceAsXmlDocument(setAcsIncorrectNhsNumber));\n+        }\n     }\n \n     @SneakyThrows\n@@ -52,22 +85,30 @@\n     public ProcessingResult getScrProcessingResult(String contentLocation, long initialWaitTime, String nhsdAsid,\n                                                    String nhsdIdentity, String nhsdSessionUrid) {\n         sleep(scrConfiguration.getSandboxDelay());\n-        String responseBody = getResourceAsString(UPLOAD_SCR_POLLING_RESPONSE);\n+        String responseBody = getResourceAsString(pollingSuccess);\n         return ProcessingResult.parseProcessingResult(responseBody);\n     }\n \n     @SneakyThrows\n     @Override\n     public Response<Document> sendGetScrId(String requestBody, String nhsdAsid) {\n         sleep(scrConfiguration.getSandboxDelay());\n-        return new Response(OK.value(), null, getResourceAsXmlDocument(EVENT_LIST_QUERY_RESPONSE));\n+        Document document = parseXml(requestBody);\n+        String nhsNumber = xmlUtils.getValueByXPath(document, GET_SCR_ID_NHS_NUMBER_XPATH);\n+\n+        switch (nhsNumber) {\n+            case EXISTING_NHS_NUMBER:\n+                return new Response(OK.value(), null, getResourceAsXmlDocument(getScrIdSuccess));\n+            default:\n+                return new Response(OK.value(), null, getResourceAsXmlDocument(getScrIdNoConsent));\n+        }\n     }\n \n     @SneakyThrows\n     @Override\n     public Response<Document> sendGetScr(String requestBody, String nhsdAsid) {\n         sleep(scrConfiguration.getSandboxDelay());\n-        return new Response(OK.value(), null, getResourceAsXmlDocument(EVENT_QUERY_RESPONSE));\n+        return new Response(OK.value(), null, getResourceAsXmlDocument(getScrSuccess));\n     }\n \n     @Override\n@@ -76,12 +117,16 @@ public ProcessingResult getScrProcessingResult(String contentLocation, long init\n     }\n \n     @SneakyThrows\n-    private static String getResourceAsString(String path) {\n-        return IOUtils.toString(new ClassPathResource(path).getInputStream(), UTF_8);\n+    private static String getResourceAsString(Resource resource) {\n+        return IOUtils.toString(resource.getInputStream(), UTF_8);\n     }\n \n     @SneakyThrows\n-    private static Document getResourceAsXmlDocument(String path) {\n-        return documentBuilder().parse(new ClassPathResource(path).getInputStream());\n+    private static Document getResourceAsXmlDocument(Resource resource) {\n+        return documentBuilder().parse(resource.getInputStream());\n+    }\n+\n+    private Document parseXml(String requestBody) throws SAXException, IOException {\n+        return documentBuilder().parse(new InputSource(new StringReader(requestBody)));\n     }\n }"
  },
  {
    "sha": "c33c71885615f9c9fe4d2cc08d78168be752bd00",
    "filename": "docker/service/src/main/java/uk/nhs/adaptors/scr/config/ScrSpringConfiguration.java",
    "status": "modified",
    "additions": 3,
    "deletions": 1,
    "changes": 4,
    "blob_url": "https://github.com/NHSDigital/summary-care-record-api/blob/fbcfdbb1cf8f54d6ec6c13a3103f5971dfc9178a/docker/service/src/main/java/uk/nhs/adaptors/scr/config/ScrSpringConfiguration.java",
    "raw_url": "https://github.com/NHSDigital/summary-care-record-api/raw/fbcfdbb1cf8f54d6ec6c13a3103f5971dfc9178a/docker/service/src/main/java/uk/nhs/adaptors/scr/config/ScrSpringConfiguration.java",
    "contents_url": "https://api.github.com/repos/NHSDigital/summary-care-record-api/contents/docker/service/src/main/java/uk/nhs/adaptors/scr/config/ScrSpringConfiguration.java?ref=fbcfdbb1cf8f54d6ec6c13a3103f5971dfc9178a",
    "patch": "@@ -13,6 +13,7 @@\n import uk.nhs.adaptors.scr.clients.spine.SpineHttpClient;\n import uk.nhs.adaptors.scr.clients.spine.SpineStringResponseHandler;\n import uk.nhs.adaptors.scr.clients.spine.SpineXmlResponseHandler;\n+import uk.nhs.adaptors.scr.utils.XmlUtils;\n \n @Configuration\n @RequiredArgsConstructor(onConstructor = @__(@Autowired))\n@@ -25,11 +26,12 @@\n     private final SpineHttpClient spineHttpClient;\n     private final SpineConfiguration spineConfiguration;\n     private final IdentityServiceConfiguration identityServiceConfiguration;\n+    private final XmlUtils xmlUtils;\n \n     @Bean\n     public SpineClientContract spineClient() {\n         if (scrConfiguration.getSandboxMode()) {\n-            return new SandboxSpineClient(scrConfiguration);\n+            return new SandboxSpineClient(scrConfiguration, xmlUtils);\n         } else {\n             return new SpineClient(spineConfiguration, spineHttpClient, stringResponseHandler, xmlResponseHandler);\n         }"
  },
  {
    "sha": "9308c414ba70ca338131858f7cbb3e3f36c782a5",
    "filename": "docker/service/src/main/resources/mock-spine/acs/incorrectNhsNumber.xml",
    "status": "added",
    "additions": 73,
    "deletions": 0,
    "changes": 73,
    "blob_url": "https://github.com/NHSDigital/summary-care-record-api/blob/fbcfdbb1cf8f54d6ec6c13a3103f5971dfc9178a/docker/service/src/main/resources/mock-spine/acs/incorrectNhsNumber.xml",
    "raw_url": "https://github.com/NHSDigital/summary-care-record-api/raw/fbcfdbb1cf8f54d6ec6c13a3103f5971dfc9178a/docker/service/src/main/resources/mock-spine/acs/incorrectNhsNumber.xml",
    "contents_url": "https://api.github.com/repos/NHSDigital/summary-care-record-api/contents/docker/service/src/main/resources/mock-spine/acs/incorrectNhsNumber.xml?ref=fbcfdbb1cf8f54d6ec6c13a3103f5971dfc9178a",
    "patch": "@@ -0,0 +1,73 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<SOAP:Envelope xmlns:SOAP=\"http://schemas.xmlsoap.org/soap/envelope/\" xmlns=\"urn:hl7-org:v3\" xmlns:crs=\"http://national.carerecords.nhs.uk/schema/crs/\" xmlns:hl7=\"urn:hl7-org:v3\" xmlns:wsa=\"http://schemas.xmlsoap.org/ws/2004/08/addressing\">\n+  <SOAP:Header>\n+    <wsa:MessageID>uuid:8083F6A2-D990-4162-9B15-19DB35A18E8D</wsa:MessageID>\n+    <wsa:Action>urn:nhs:names:services:lrs/MCCI_IN010000UK13</wsa:Action>\n+    <wsa:To />\n+    <wsa:From>\n+      <wsa:Address>https://lrs-sync.national.ncrs.nhs.uk/syncservice-lrs/acf</wsa:Address>\n+    </wsa:From>\n+    <communicationFunctionRcv typeCode=\"RCV\">\n+      <device classCode=\"DEV\" determinerCode=\"INSTANCE\">\n+        <id root=\"1.2.826.0.1285.0.2.0.107\" extension=\"200000001162\" />\n+      </device>\n+    </communicationFunctionRcv>\n+    <communicationFunctionSnd typeCode=\"SND\">\n+      <device classCode=\"DEV\" determinerCode=\"INSTANCE\">\n+        <id root=\"1.2.826.0.1285.0.2.0.107\" extension=\"655159266510\" />\n+      </device>\n+    </communicationFunctionSnd>\n+    <wsa:RelatesTo>uuid:example-request-GUID</wsa:RelatesTo>\n+  </SOAP:Header>\n+  <SOAP:Body>\n+    <setResourcePermissionsResponse>\n+      <MCCI_IN010000UK13>\n+        <id root=\"8083F6A2-D990-4162-9B15-19DB35A18E8D\" />\n+        <creationTime value=\"20210317104510\" />\n+        <versionCode code=\"V3NPfIT4.2.00\" />\n+        <interactionId root=\"2.16.840.1.113883.2.1.3.2.4.12\" extension=\"MCCI_IN010000UK13\" />\n+        <processingCode code=\"P\" />\n+        <processingModeCode code=\"T\" />\n+        <acceptAckCode code=\"NE\" />\n+        <acknowledgement typeCode=\"AE\">\n+          <messageRef>\n+            <id root=\"8083F6A2-D990-4162-9B15-19DB35A18E8D\" />\n+          </messageRef>\n+        </acknowledgement>\n+        <communicationFunctionRcv typeCode=\"RCV\">\n+          <device classCode=\"DEV\" determinerCode=\"INSTANCE\">\n+            <id root=\"1.2.826.0.1285.0.2.0.107\" extension=\"200000001162\" />\n+          </device>\n+        </communicationFunctionRcv>\n+        <communicationFunctionSnd typeCode=\"SND\">\n+          <device classCode=\"DEV\" determinerCode=\"INSTANCE\">\n+            <id root=\"1.2.826.0.1285.0.2.0.107\" extension=\"655159266510\" />\n+          </device>\n+        </communicationFunctionSnd>\n+        <ControlActEvent classCode=\"CACT\" moodCode=\"EVN\">\n+          <author1 typeCode=\"AUT\">\n+            <AgentSystemSDS classCode=\"AGNT\">\n+              <agentSystemSDS classCode=\"DEV\" determinerCode=\"INSTANCE\">\n+                <id root=\"1.2.826.0.1285.0.2.0.107\" extension=\"655159266510\" />\n+              </agentSystemSDS>\n+            </AgentSystemSDS>\n+          </author1>\n+          <reason typeCode=\"RSON\">\n+            <justifyingDetectedIssueEvent classCode=\"ALRT\" moodCode=\"EVN\">\n+              <code code=\"400\" codeSystem=\"2.16.840.1.113883.2.1.3.2.4.17.33\" displayName=\"Invalid Request\">\n+                <qualifier code=\"ER\" />\n+              </code>\n+            </justifyingDetectedIssueEvent>\n+          </reason>\n+          <reason typeCode=\"RSON\">\n+            <justifyingDetectedIssueEvent classCode=\"ALRT\" moodCode=\"EVN\">\n+              <code code=\"35160\" codeSystem=\"2.16.840.1.113883.2.1.3.2.4.17.33\" displayName=\"[PSIS-35160] - Invalid input message. Mandatory field NHS Number is missing or incorrect\">\n+                <qualifier code=\"ER\" />\n+              </code>\n+            </justifyingDetectedIssueEvent>\n+          </reason>\n+        </ControlActEvent>\n+      </MCCI_IN010000UK13>\n+    </setResourcePermissionsResponse>\n+  </SOAP:Body>\n+</SOAP:Envelope>"
  },
  {
    "sha": "2b9243dfd51e1975a50ad371314fc2904db92eb3",
    "filename": "docker/service/src/main/resources/mock-spine/acs/success.xml",
    "status": "renamed",
    "additions": 0,
    "deletions": 0,
    "changes": 0,
    "blob_url": "https://github.com/NHSDigital/summary-care-record-api/blob/fbcfdbb1cf8f54d6ec6c13a3103f5971dfc9178a/docker/service/src/main/resources/mock-spine/acs/success.xml",
    "raw_url": "https://github.com/NHSDigital/summary-care-record-api/raw/fbcfdbb1cf8f54d6ec6c13a3103f5971dfc9178a/docker/service/src/main/resources/mock-spine/acs/success.xml",
    "contents_url": "https://api.github.com/repos/NHSDigital/summary-care-record-api/contents/docker/service/src/main/resources/mock-spine/acs/success.xml?ref=fbcfdbb1cf8f54d6ec6c13a3103f5971dfc9178a",
    "previous_filename": "docker/service/src/main/resources/mock-spine/setConsent.xml"
  },
  {
    "sha": "4d334b946b891abe6072e354d77a31153e6094b4",
    "filename": "docker/service/src/main/resources/mock-spine/event-list-query/noConsent.xml",
    "status": "added",
    "additions": 76,
    "deletions": 0,
    "changes": 76,
    "blob_url": "https://github.com/NHSDigital/summary-care-record-api/blob/fbcfdbb1cf8f54d6ec6c13a3103f5971dfc9178a/docker/service/src/main/resources/mock-spine/event-list-query/noConsent.xml",
    "raw_url": "https://github.com/NHSDigital/summary-care-record-api/raw/fbcfdbb1cf8f54d6ec6c13a3103f5971dfc9178a/docker/service/src/main/resources/mock-spine/event-list-query/noConsent.xml",
    "contents_url": "https://api.github.com/repos/NHSDigital/summary-care-record-api/contents/docker/service/src/main/resources/mock-spine/event-list-query/noConsent.xml?ref=fbcfdbb1cf8f54d6ec6c13a3103f5971dfc9178a",
    "patch": "@@ -0,0 +1,76 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<SOAP-ENV:Envelope xmlns:SOAP-ENV=\"http://schemas.xmlsoap.org/soap/envelope/\" xmlns=\"urn:hl7-org:v3\" xmlns:crs=\"http://national.carerecords.nhs.uk/schema/crs/\" xmlns:hl7=\"urn:hl7-org:v3\" xmlns:wsa=\"http://schemas.xmlsoap.org/ws/2004/08/addressing\">\n+  <SOAP-ENV:Header>\n+    <wsa:MessageID>uuid:118D81EC-7B35-11EB-A8F2-F40343488B15</wsa:MessageID>\n+    <wsa:Action>urn:nhs:names:services:psisquery/QUQI_IN010000UK14</wsa:Action>\n+    <wsa:To>192.168.0.24</wsa:To>\n+    <wsa:From>\n+      <wsa:Address>https://msg.intspineservices.nhs.uk/sync-service</wsa:Address>\n+    </wsa:From>\n+    <communicationFunctionRcv typeCode=\"RCV\">\n+      <device classCode=\"DEV\" determinerCode=\"INSTANCE\">\n+        <id root=\"1.2.826.0.1285.0.2.0.107\" extension=\"200000001162\" />\n+      </device>\n+    </communicationFunctionRcv>\n+    <communicationFunctionSnd typeCode=\"SND\">\n+      <device classCode=\"DEV\" determinerCode=\"INSTANCE\">\n+        <id root=\"1.2.826.0.1285.0.2.0.107\" extension=\"655159266510\" />\n+      </device>\n+    </communicationFunctionSnd>\n+    <wsa:RelatesTo>uuid:46D5A78C-F8B4-467B-A0B4-CB2147451CBE</wsa:RelatesTo>\n+  </SOAP-ENV:Header>\n+  <SOAP-ENV:Body>\n+    <eventListQueryResponse>\n+      <QUQI_IN010000UK14>\n+        <id root=\"118D81EC-7B35-11EB-A8F2-F40343488B15\" />\n+        <creationTime value=\"20210302085542\" />\n+        <versionCode code=\"V3NPfIT4.2.00\" />\n+        <interactionId root=\"2.16.840.1.113883.2.1.3.2.4.12\" extension=\"QUQI_IN010000UK14\" />\n+        <processingCode code=\"P\" />\n+        <processingModeCode code=\"T\" />\n+        <acceptAckCode code=\"NE\" />\n+        <acknowledgement typeCode=\"AE\">\n+          <messageRef>\n+            <id root=\"46D5A78C-F8B4-467B-A0B4-CB2147451CBE\" />\n+          </messageRef>\n+        </acknowledgement>\n+        <communicationFunctionRcv typeCode=\"RCV\">\n+          <device classCode=\"DEV\" determinerCode=\"INSTANCE\">\n+            <id root=\"1.2.826.0.1285.0.2.0.107\" extension=\"200000001162\" />\n+          </device>\n+        </communicationFunctionRcv>\n+        <communicationFunctionSnd typeCode=\"SND\">\n+          <device classCode=\"DEV\" determinerCode=\"INSTANCE\">\n+            <id root=\"1.2.826.0.1285.0.2.0.107\" extension=\"655159266510\" />\n+          </device>\n+        </communicationFunctionSnd>\n+        <ControlActEvent classCode=\"CACT\" moodCode=\"EVN\">\n+          <author1 typeCode=\"AUT\">\n+            <AgentSystemSDS classCode=\"AGNT\">\n+              <agentSystemSDS classCode=\"DEV\" determinerCode=\"INSTANCE\">\n+                <id root=\"1.2.826.0.1285.0.2.0.107\" extension=\"655159266510\" />\n+              </agentSystemSDS>\n+            </AgentSystemSDS>\n+          </author1>\n+          <reason typeCode=\"RSON\">\n+            <justifyingDetectedIssueEvent classCode=\"ALRT\" moodCode=\"EVN\">\n+              <code code=\"420\" codeSystem=\"2.16.840.1.113883.2.1.3.2.4.17.33\" displayName=\"Business condition related to access control  which prevents the action being performed by PSIS\">\n+                <qualifier code=\"ER\" />\n+              </code>\n+            </justifyingDetectedIssueEvent>\n+          </reason>\n+          <reason typeCode=\"RSON\">\n+            <justifyingDetectedIssueEvent classCode=\"ALRT\" moodCode=\"EVN\">\n+              <code code=\"30418\" codeSystem=\"2.16.840.1.113883.2.1.3.2.4.17.33\" displayName=\"[PSIS-30418] - ACF does not permit access to resource\">\n+                <qualifier code=\"ER\" />\n+              </code>\n+            </justifyingDetectedIssueEvent>\n+          </reason>\n+          <queryAck type=\"QueryAck\">\n+            <queryResponseCode code=\"ID\" />\n+          </queryAck>\n+        </ControlActEvent>\n+      </QUQI_IN010000UK14>\n+    </eventListQueryResponse>\n+  </SOAP-ENV:Body>\n+</SOAP-ENV:Envelope>"
  },
  {
    "sha": "fb4768e51ae4b8376b3ef99f14eed054cb585004",
    "filename": "docker/service/src/main/resources/mock-spine/event-list-query/success.xml",
    "status": "renamed",
    "additions": 0,
    "deletions": 0,
    "changes": 0,
    "blob_url": "https://github.com/NHSDigital/summary-care-record-api/blob/fbcfdbb1cf8f54d6ec6c13a3103f5971dfc9178a/docker/service/src/main/resources/mock-spine/event-list-query/success.xml",
    "raw_url": "https://github.com/NHSDigital/summary-care-record-api/raw/fbcfdbb1cf8f54d6ec6c13a3103f5971dfc9178a/docker/service/src/main/resources/mock-spine/event-list-query/success.xml",
    "contents_url": "https://api.github.com/repos/NHSDigital/summary-care-record-api/contents/docker/service/src/main/resources/mock-spine/event-list-query/success.xml?ref=fbcfdbb1cf8f54d6ec6c13a3103f5971dfc9178a",
    "previous_filename": "docker/service/src/main/resources/mock-spine/getScrId.xml"
  },
  {
    "sha": "00afacf3a1df7d7f7ea9d77c23f2746ad8f79897",
    "filename": "docker/service/src/main/resources/mock-spine/event-query/success.xml",
    "status": "renamed",
    "additions": 1,
    "deletions": 1,
    "changes": 2,
    "blob_url": "https://github.com/NHSDigital/summary-care-record-api/blob/fbcfdbb1cf8f54d6ec6c13a3103f5971dfc9178a/docker/service/src/main/resources/mock-spine/event-query/success.xml",
    "raw_url": "https://github.com/NHSDigital/summary-care-record-api/raw/fbcfdbb1cf8f54d6ec6c13a3103f5971dfc9178a/docker/service/src/main/resources/mock-spine/event-query/success.xml",
    "contents_url": "https://api.github.com/repos/NHSDigital/summary-care-record-api/contents/docker/service/src/main/resources/mock-spine/event-query/success.xml?ref=fbcfdbb1cf8f54d6ec6c13a3103f5971dfc9178a",
    "patch": "@@ -60,7 +60,7 @@\n                 </psis:patient>\n               </psis:recordTarget>\n               <psis:event>\n-                <psis:eventID root=\"12345678-C403-4EF7-A4AB-E07303AF5477\" />\n+                <psis:eventID root=\"FA60BE64-1F34-11EB-A2A8-000C29A364EB\" />\n                 <psis:payloadID extension=\"REPC_MT150007UK05\" root=\"2.16.840.1.113883.2.1.3.2.4.12\" />\n                 <psis:persistenceDate value=\"20210209061632\" />\n                 <psis:eventStatus code=\"1\" codeSystem=\"2.16.840.1.113883.2.1.3.2.4.17.59\" displayName=\"Normal\" />",
    "previous_filename": "docker/service/src/main/resources/mock-spine/getScr.xml"
  },
  {
    "sha": "35e2fc5c6c06d04ceced2d3818f494586e381d79",
    "filename": "docker/service/src/main/resources/mock-spine/upload-scr/pollingSuccess.txt",
    "status": "renamed",
    "additions": 0,
    "deletions": 0,
    "changes": 0,
    "blob_url": "https://github.com/NHSDigital/summary-care-record-api/blob/fbcfdbb1cf8f54d6ec6c13a3103f5971dfc9178a/docker/service/src/main/resources/mock-spine/upload-scr/pollingSuccess.txt",
    "raw_url": "https://github.com/NHSDigital/summary-care-record-api/raw/fbcfdbb1cf8f54d6ec6c13a3103f5971dfc9178a/docker/service/src/main/resources/mock-spine/upload-scr/pollingSuccess.txt",
    "contents_url": "https://api.github.com/repos/NHSDigital/summary-care-record-api/contents/docker/service/src/main/resources/mock-spine/upload-scr/pollingSuccess.txt?ref=fbcfdbb1cf8f54d6ec6c13a3103f5971dfc9178a",
    "previous_filename": "docker/service/src/main/resources/mock-spine/uploadScrPolling.xml"
  },
  {
    "sha": "395e4fece67ee7db22063443d807b591c362be4e",
    "filename": "specification/summary-care-record.yaml",
    "status": "modified",
    "additions": 37,
    "deletions": 6,
    "changes": 43,
    "blob_url": "https://github.com/NHSDigital/summary-care-record-api/blob/fbcfdbb1cf8f54d6ec6c13a3103f5971dfc9178a/specification/summary-care-record.yaml",
    "raw_url": "https://github.com/NHSDigital/summary-care-record-api/raw/fbcfdbb1cf8f54d6ec6c13a3103f5971dfc9178a/specification/summary-care-record.yaml",
    "contents_url": "https://api.github.com/repos/NHSDigital/summary-care-record-api/contents/specification/summary-care-record.yaml?ref=fbcfdbb1cf8f54d6ec6c13a3103f5971dfc9178a",
    "patch": "@@ -124,6 +124,18 @@ servers:\n paths:\n   /Bundle:\n     post:\n+      description: |\n+        ## Overview\n+        Use this endpoint to upload the details of patient's Summary Care Record.\n+\n+        ## Sandbox test scenarios\n+        You can test the following scenarios in our sandbox environment:\n+        \n+        | Scenario                          | Request                                           | Response                                                                                                                              |\n+        | ----------------------------------| ------------------------------------------------- | -------------------- |\n+        | Happy path                        | `Patient.identifier.value`=`9995000180`           | HTTP Status 201      |\n+        | No patient's consent to store SCR | `Patient.identifier.value`=`9693042298`           | HTTP Status 403      |\n+      \n       summary: Upload patient's Summary Care Record\n       operationId: upload-scr\n       parameters:\n@@ -178,9 +190,10 @@ paths:\n         ## Sandbox test scenarios\n         You can test the following scenarios in our sandbox environment:\n \n-        | Scenario                         | Request                                           | Response                                                                                                                              |\n-        | -------------------------------- | ------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------- |\n-        | Happy path                       | `composition.identifier`=`FA60BE64-1F34-11EB-A2A8-000C29A364EB$composition.subject:Patient.identifier=https://fhir.nhs.uk/Id/nhs-number|9995000180`                | HTTP Status 200      |\n+        | Scenario                         | Request                                                                                                                                                            | Response                          |\n+        | -------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------- |\n+        | Happy path                       | `composition.identifier`=`FA60BE64-1F34-11EB-A2A8-000C29A364EB$composition.subject:Patient.identifier=https://fhir.nhs.uk/Id/nhs-number|9995000180`                | HTTP Status 200 - Full Bundle     |\n+        | No results                       | `composition.identifier`=`81CC2DA0-8882-11EB-B538-0800200C9A66$composition.subject:Patient.identifier=https://fhir.nhs.uk/Id/nhs-number|9693042298`                | HTTP Status 200 - Empty Bundle    |\n         \n       summary: Get patient's Summary Care Record\n       operationId: get-scr\n@@ -228,6 +241,15 @@ paths:\n         Use this endpoint to retrieve UUID of patient's latest record. This UUID can be then used to retrieve the Summary Care Record details.\n \n         To get the information you must provide patient's NHS number.\n+\n+        ## Sandbox test scenarios\n+        You can test the following scenarios in our sandbox environment:\n+        \n+        | Scenario                          | Request                                                                                                                   | Response                           |\n+        | ----------------------------------| ------------------------------------------------------------------------------------------------------------------------- | ---------------------------------- |\n+        | Happy path                        | `patient=https://fhir.nhs.uk/Id/nhs-number|9995000180&_sort=date&type=http://snomed.info/sct|196981000000101&_count=1`    | HTTP Status 200 - Full Bundle      |\n+        | Empty result                      | `patient=https://fhir.nhs.uk/Id/nhs-number|9693042298&_sort=date&type=http://snomed.info/sct|196981000000101&_count=1`    | HTTP Status 200 - Empty Bundle     |\n+        \n       parameters:\n         - $ref: '#/components/parameters/BearerAuthorization'\n         - $ref: '#/components/parameters/CorrelationID'\n@@ -286,9 +308,10 @@ paths:\n         ## Sandbox test scenarios\n         You can test the following scenarios in our sandbox environment:\n \n-        | Scenario                         | Request                                           | Response             |\n-        | -------------------------------- | ------------------------------------------------- | -------------------- |\n-        | Happy path                       | `NHSD-Session-URID`=`555254240100`                | HTTP Status 201      |\n+        | Scenario                         | Request                                                                      | Response             |\n+        | -------------------------------- | ---------------------------------------------------------------------------- | -------------------- |\n+        | Happy path                       | `NHSD-Session-URID`=`555254240100`; `nhsNumber`=`9995000180`                 | HTTP Status 201      |\n+        | Patient not found                | `NHSD-Session-URID`=`555254240100`; `nhsNumber`=`9693042298`                 | HTTP Status 400      |\n         \n       parameters:\n         - $ref: '#/components/parameters/BearerAuthorization'\n@@ -327,6 +350,14 @@ paths:\n       description: |\n         ## Overview\n         Use this endpoint to record TMS Event Service (TES) Alerts centrally.\n+\n+        ## Sandbox test scenarios\n+        You can test the following scenarios in our sandbox environment:\n+\n+        | Scenario                         | Request                                  | Response             |\n+        | -------------------------------- | ---------------------------------------- | -------------------- |\n+        | Happy path                       | `nhsNumber`=`9995000180`                 | HTTP Status 201      |\n+        \n       parameters:\n         - $ref: '#/components/parameters/BearerAuthorization'\n         - $ref: '#/components/parameters/CorrelationID'"
  }
]

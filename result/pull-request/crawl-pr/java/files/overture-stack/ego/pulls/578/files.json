[
  {
    "sha": "91d1f384f6f7623205e64604b1feee79c59cb317",
    "filename": "INSTALL.md",
    "status": "added",
    "additions": 194,
    "deletions": 0,
    "changes": 194,
    "blob_url": "https://github.com/overture-stack/ego/blob/74af777ff320c0d01ee82fe697b3dcb742434b3f/INSTALL.md",
    "raw_url": "https://github.com/overture-stack/ego/raw/74af777ff320c0d01ee82fe697b3dcb742434b3f/INSTALL.md",
    "contents_url": "https://api.github.com/repos/overture-stack/ego/contents/INSTALL.md?ref=74af777ff320c0d01ee82fe697b3dcb742434b3f",
    "patch": "@@ -0,0 +1,194 @@\n+# Installation Guide\n+\n+## Prerequisites \n+On the platform of your choice (we recommend Linux) please ensure you have the following installed:\n+* Postgresql \n+    * Ensure you have a user you can use that has the ability to apply database migrations to the Ego database and to create extensions.\n+* Java Runtime Environment version 11.\n+* A configured OAuth2 OIDC provider with a clientId and clientSecret. (For example Google).\n+* The UI ready to be hosted or already hosted somewhere. \n+\n+## Installation\n+\n+### Download Ego\n+\n+You can download the latest version of Ego from [here](https://artifacts.oicr.on.ca/artifactory/dcc-release/bio/overture/ego/[RELEASE]/ego-[RELEASE]-dist.tar.gz). \n+\n+Example using curl:\n+```shell\n+curl  https://artifacts.oicr.on.ca/artifactory/dcc-release/bio/overture/ego/[RELEASE]/ego-[RELEASE]-dist.tar.gz -o ego-dist.tar.gz\n+```\n+\n+### Extract \n+Once downloaded, extract the distribution.\n+\n+```shell\n+tar zxvf ego-dist.tar.gz\n+```\n+\n+This should create a folder with the name of `ego-<version>` where `<version>` is the version number of the release. We recommend moving Ego out of you home directory, to a directory like `/srv`. You may need to use elevated privileges to do this.\n+\n+```shell\n+$ sudo mv ego-4.1.0 /srv/\n+$ ls -l /srv/\n+total 4\n+drwxrwxr-x 8 ubuntu ubuntu 4096 Mar 11 18:51 ego-4.1.0\n+```\n+\n+We also recommend creating a symlink with the name of ego-current should you ever want to update or rollback to previous version of Ego while maintaining one place to look at for running and configuring. \n+\n+```shell\n+/srv$ sudo ln -sf ego-4.1.0 ego-current\n+/srv$ ls -la\n+total 12\n+drwxr-xr-x  3 root   root   4096 Mar 11 18:56 .\n+drwxr-xr-x 19 root   root   4096 Mar 11 18:14 ..\n+drwxrwxr-x  8 ubuntu ubuntu 4096 Mar 11 18:51 ego-4.1.0\n+lrwxrwxrwx  1 root   root      9 Mar 11 18:56 ego-current -> ego-4.1.0\n+```\n+\n+### Database Configuration\n+\n+The directory structure inside of the Ego directory is self-explanatory: \n+\n+```shell\n+/srv/ego-current$ ls -l\n+total 24\n+drwxrwxr-x 2 ubuntu ubuntu 4096 Mar 11 18:51 bin\n+drwxrwxr-x 2 ubuntu ubuntu 4096 Mar 11 18:51 cert\n+drwxr-xr-x 2 ubuntu ubuntu 4096 Mar 11 17:03 conf\n+drwxrwxr-x 2 ubuntu ubuntu 4096 Mar 11 18:51 exec\n+drwxr-xr-x 2 ubuntu ubuntu 4096 Mar 11 17:03 lib\n+drwxr-xr-x 2 ubuntu ubuntu 4096 Mar 11 17:03 logs\n+```\n+\n+We want to navigate into the `conf` directory to edit the `application.yml` file.\n+\n+```shell\n+vim conf/application.yml\n+```\n+\n+First thing we want to edit is the `spring.datasource` section replacing `<ego_db>`, `<db_user>`, and `<db_pass>` with the values you have configured in your postgresql instance:\n+```yml\n+# Datasource\n+spring.datasource:\n+  driver-class-name: org.postgresql.Driver\n+  url: jdbc:postgresql://localhost:5432/<ego_db>?stringtype=unspecified\n+\n+  username: <db_user>\n+  password: <db_pass>\n+  max-active: 10\n+  max-idle: 1\n+  min-idle: 1\n+```\n+\n+Next, as we have not applied any database migrations, we will want to enable flyway to automatically apply outstanding migrations on startup. Look for the `spring.flyway.enabled` setting and set it to `true`. Also, we will need to tell flyway where to find the migrations. As we are using the built in migrations, we can add: `locations: classpath:flyway/sql,classpath:db.migration`. \n+\n+```yml\n+spring:\n+  flyway:\n+    enabled: true # SET THIS TO TRUE, DEFAULT IS FALSE\n+    user: <privileged_user>\n+    password: <privileged_user_password>\n+    locations: classpath:flyway/sql,classpath:db.migration\n+```\n+\n+As the migration requires elevated privileges to create extensions within postgresql, feel free to use a separate user for running them. \n+\n+### First Startup\n+Now we are ready to start Ego and initialize the database. We will use the service wrapper `bin/ego` to start/stop/restart Ego.\n+\n+```shell\n+/srv/ego-current$ bin/ego \n+Usage: bin/ego [ console | start | stop | restart | condrestart | status | install | remove | dump ]\n+\n+Commands:\n+  console      Launch in the current console.\n+  start        Start in the background as a daemon process.\n+  stop         Stop if running as a daemon or in another console.\n+  restart      Stop if running and then start.\n+  condrestart  Restart only if already running.\n+  status       Query the current status.\n+  install      Install to start automatically when system boots.\n+  remove       Uninstall.\n+  dump         Request a Java thread dump if running.\n+\n+```\n+Starting it up for the first time:\n+```shell\n+/srv/ego-current$ bin/ego start\n+Starting EGO Server...\n+Waiting for EGO Server......\n+running: PID:11994\n+```\n+\n+If we look at the logs we should seem something like the following: \n+```shell\n+$ /srv/ego-current$ tail -f logs/wrapper.20210311.log \n+INFO   | jvm 1    | 2021/03/11 19:35:02 | 2021-03-11 19:35:02,492 [WrapperSimpleAppMain] INFO  o.s.b.w.e.t.TomcatWebServer - Tomcat started on port(s): 8081 (http) with context path ''\n+INFO   | jvm 1    | 2021/03/11 19:35:02 | 2021-03-11 19:35:02,492 [WrapperSimpleAppMain] INFO  o.s.b.w.e.t.TomcatWebServer - Tomcat started on port(s): 8081 (http) with context path ''\n+INFO   | jvm 1    | 2021/03/11 19:35:02 | 2021-03-11 19:35:02,497 [WrapperSimpleAppMain] INFO  b.o.e.AuthorizationServiceMain - Started AuthorizationServiceMain in 22.659 seconds (JVM running for 24.385)\n+```\n+\n+## Auth Setup\n+Now that Ego is up and running we want to configure the first user and application that can use Ego for Authorization.\n+\n+### Identity Provider\n+\n+For the identity provider of your choosing, find the relevant section in the `application.yml` configuration file and the client id and secret you have configured with that IdP. For example if Google is your IdP:\n+\n+\n+```yml\n+google:\n+  client:\n+    clientId: <cliend_id>\n+    clientSecret: <client_secret>\n+    accessTokenUri: https://www.googleapis.com/oauth2/v4/token\n+    userAuthorizationUri: https://accounts.google.com/o/oauth2/v2/auth\n+    clientAuthenticationScheme: form\n+    scope:\n+      - email\n+      - profile\n+  resource:\n+    userInfoUri: https://www.googleapis.com/oauth2/v3/userinfo\n+```\n+\n+### First Application\n+Before users can login we need to setup the UI application inside of Ego. This can be done by setting `intialization.enabled` to true and configuring the rest of the settings to match the settings you will use in your UI application.\n+\n+```yml\n+initialization:\n+  enabled: true # Set to true\n+  applications:\n+    - name: <name_of_your_ui_app>\n+      type: CLIENT\n+      clientId: <client_id_of_ui>\n+      clientSecret: <some_secret> \n+      redirectUri: <url to redirect to in UI, for Ego UI this would be root>\n+      description: Some description about this application  # optional\n+```\n+\n+### First User\n+Users by default do not have the `ADMIN` role and therefore cannot modify Ego or use the Ego UI. We want to allow the first user to login to be an ADMIN user. We can do that by using the following configuration in `application.yml`:\n+\n+```yml\n+# Default values available for creation of entities\n+default:\n+  user:\n+    # flag to automatically register first user as an admin\n+    firstUserAsAdmin: true\n+    type: ADMIN\n+    status: APPROVED\n+```\n+\n+### Putting it together.\n+Now that we have updated our config we can restart Ego, and try to login via the UI.\n+```shell\n+bin/ego restart\n+```\n+\n+## Cleanup\n+\n+Assuming all is well, and the Ego database is properly configured and the first user and application are working, you will most likely want to disable the initialization of the first application and user. This means seetting the `firstUserAsAdmin` and `initialization.enabled` to `false`.\n+\n+Also, if you prefer to manage migrations yourself and not have Ego automatically apply them when you update Ego, disable the flyway migration as well. \n\\ No newline at end of file"
  }
]

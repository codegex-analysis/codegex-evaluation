[
  {
    "sha": "c361e0dd2400eaf4556a23e084f83b1076d9c900",
    "filename": "adapters/oidc/installed/src/main/java/org/keycloak/adapters/installed/KeycloakInstalled.java",
    "status": "modified",
    "additions": 27,
    "deletions": 4,
    "changes": 31,
    "blob_url": "https://github.com/keycloak/keycloak/blob/120162629eaeb3507fd431e37a81522eced9b153/adapters/oidc/installed/src/main/java/org/keycloak/adapters/installed/KeycloakInstalled.java",
    "raw_url": "https://github.com/keycloak/keycloak/raw/120162629eaeb3507fd431e37a81522eced9b153/adapters/oidc/installed/src/main/java/org/keycloak/adapters/installed/KeycloakInstalled.java",
    "contents_url": "https://api.github.com/repos/keycloak/keycloak/contents/adapters/oidc/installed/src/main/java/org/keycloak/adapters/installed/KeycloakInstalled.java?ref=120162629eaeb3507fd431e37a81522eced9b153",
    "patch": "@@ -107,6 +107,8 @@\n     Pattern callbackPattern = Pattern.compile(\"callback\\\\s*=\\\\s*\\\"([^\\\"]+)\\\"\");\n     Pattern paramPattern = Pattern.compile(\"param=\\\"([^\\\"]+)\\\"\\\\s+label=\\\"([^\\\"]+)\\\"\\\\s+mask=(\\\\S+)\");\n     Pattern codePattern = Pattern.compile(\"code=([^&]+)\");\n+    private CallbackListener callback;\n+    private DesktopProvider desktopProvider = new DesktopProvider();\n \n \n     public KeycloakInstalled() {\n@@ -194,7 +196,7 @@ public void logout() throws IOException, InterruptedException, URISyntaxExceptio\n     }\n \n     public void loginDesktop() throws IOException, VerificationException, OAuthErrorException, URISyntaxException, ServerRequest.HttpFailure, InterruptedException {\n-        CallbackListener callback = new CallbackListener();\n+        callback = new CallbackListener();\n         callback.start();\n \n         String redirectUri = getRedirectUri(callback);\n@@ -203,7 +205,7 @@ public void loginDesktop() throws IOException, VerificationException, OAuthError\n \n         String authUrl = createAuthUrl(redirectUri, state, pkce);\n \n-        Desktop.getDesktop().browse(new URI(authUrl));\n+        getDesktopProvider().browse(new URI(authUrl));\n \n         try {\n             callback.await();\n@@ -225,6 +227,12 @@ public void loginDesktop() throws IOException, VerificationException, OAuthError\n         status = Status.LOGGED_DESKTOP;\n     }\n \n+    public void close() {\n+        if (callback != null) {\n+            callback.stop();\n+        }\n+    }\n+\n     protected String createAuthUrl(String redirectUri, String state, Pkce pkce) {\n \n         KeycloakUriBuilder builder = deployment.getAuthUrl().clone()\n@@ -265,7 +273,7 @@ private void logoutDesktop() throws IOException, URISyntaxException, Interrupted\n                 .queryParam(\"id_token_hint\", idTokenString)\n                 .build().toString();\n \n-        Desktop.getDesktop().browse(new URI(logoutUrl));\n+        getDesktopProvider().browse(new URI(logoutUrl));\n \n         try {\n             callback.await();\n@@ -623,8 +631,12 @@ public AccessTokenResponse getTokenResponse() {\n         return tokenResponse;\n     }\n \n+    public DesktopProvider getDesktopProvider() {\n+        return desktopProvider;\n+    }\n+\n     public boolean isDesktopSupported() {\n-        return Desktop.isDesktopSupported();\n+        return getDesktopProvider().isDesktopSupported();\n     }\n \n     public KeycloakDeployment getDeployment() {\n@@ -685,6 +697,7 @@ public void stop() {\n             } catch (Exception ignore) {\n                 // it is OK to happen if thread is modified while stopping the server, specially when a security manager is enabled\n             }\n+            shutdownSignal.countDown();\n         }\n \n         public int getLocalPort() {\n@@ -772,4 +785,14 @@ private static String generateS256CodeChallenge(String codeVerifier) throws Exce\n             return Base64Url.encode(md.digest());\n         }\n     }\n+\n+    public static class DesktopProvider {\n+        public boolean isDesktopSupported() {\n+            return Desktop.isDesktopSupported();\n+        }\n+\n+        public void browse(URI uri) throws IOException {\n+            Desktop.getDesktop().browse(uri);\n+        }\n+    }\n }"
  }
]

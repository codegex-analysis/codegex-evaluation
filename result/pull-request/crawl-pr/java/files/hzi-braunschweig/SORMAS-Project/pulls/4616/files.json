[
  {
    "sha": "c625b1db1802410cb1fa3bfa5e90f1d0c1a55167",
    "filename": "sormas-api/src/main/java/de/symeda/sormas/api/action/ActionDto.java",
    "status": "modified",
    "additions": 4,
    "deletions": 0,
    "changes": 4,
    "blob_url": "https://github.com/hzi-braunschweig/SORMAS-Project/blob/893781cc91fe82e16f13881b32f3f6ca0f03c63e/sormas-api/src/main/java/de/symeda/sormas/api/action/ActionDto.java",
    "raw_url": "https://github.com/hzi-braunschweig/SORMAS-Project/raw/893781cc91fe82e16f13881b32f3f6ca0f03c63e/sormas-api/src/main/java/de/symeda/sormas/api/action/ActionDto.java",
    "contents_url": "https://api.github.com/repos/hzi-braunschweig/SORMAS-Project/contents/sormas-api/src/main/java/de/symeda/sormas/api/action/ActionDto.java?ref=893781cc91fe82e16f13881b32f3f6ca0f03c63e",
    "patch": "@@ -180,6 +180,10 @@ public void setActionMeasure(ActionMeasure actionMeasure) {\n \t\tthis.actionMeasure = actionMeasure;\n \t}\n \n+\tpublic ActionReferenceDto toReference() {\n+\t\treturn new ActionReferenceDto(getUuid(), getTitle());\n+\t}\n+\n \tpublic ReferenceDto getContextReference() {\n \n \t\tswitch (actionContext) {"
  },
  {
    "sha": "e320eeb6803da48ccd98bec936c434020b0dea29",
    "filename": "sormas-api/src/main/java/de/symeda/sormas/api/action/ActionReferenceDto.java",
    "status": "added",
    "additions": 43,
    "deletions": 0,
    "changes": 43,
    "blob_url": "https://github.com/hzi-braunschweig/SORMAS-Project/blob/893781cc91fe82e16f13881b32f3f6ca0f03c63e/sormas-api/src/main/java/de/symeda/sormas/api/action/ActionReferenceDto.java",
    "raw_url": "https://github.com/hzi-braunschweig/SORMAS-Project/raw/893781cc91fe82e16f13881b32f3f6ca0f03c63e/sormas-api/src/main/java/de/symeda/sormas/api/action/ActionReferenceDto.java",
    "contents_url": "https://api.github.com/repos/hzi-braunschweig/SORMAS-Project/contents/sormas-api/src/main/java/de/symeda/sormas/api/action/ActionReferenceDto.java?ref=893781cc91fe82e16f13881b32f3f6ca0f03c63e",
    "patch": "@@ -0,0 +1,43 @@\n+/*******************************************************************************\n+ * SORMAS® - Surveillance Outbreak Response Management & Analysis System\n+ * Copyright © 2016-2018 Helmholtz-Zentrum für Infektionsforschung GmbH (HZI)\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with this program. If not, see <https://www.gnu.org/licenses/>.\n+ *******************************************************************************/\n+package de.symeda.sormas.api.action;\n+\n+import de.symeda.sormas.api.ReferenceDto;\n+\n+public class ActionReferenceDto extends ReferenceDto {\n+\n+\tprivate static final long serialVersionUID = 2430932452606853497L;\n+\n+\tpublic ActionReferenceDto() {\n+\n+\t}\n+\n+\tpublic ActionReferenceDto(String uuid) {\n+\t\tsetUuid(uuid);\n+\t}\n+\n+\tpublic ActionReferenceDto(String uuid, String caption) {\n+\t\tsetUuid(uuid);\n+\t\tsetCaption(caption);\n+\t}\n+\n+\t@Override\n+\tpublic String getCaption() {\n+\t\treturn super.getCaption();\n+\t}\n+}"
  },
  {
    "sha": "d68d8e40da040ca73e7afb486be5af4db7eea1f6",
    "filename": "sormas-api/src/main/java/de/symeda/sormas/api/document/DocumentRelatedEntityType.java",
    "status": "modified",
    "additions": 1,
    "deletions": 0,
    "changes": 1,
    "blob_url": "https://github.com/hzi-braunschweig/SORMAS-Project/blob/893781cc91fe82e16f13881b32f3f6ca0f03c63e/sormas-api/src/main/java/de/symeda/sormas/api/document/DocumentRelatedEntityType.java",
    "raw_url": "https://github.com/hzi-braunschweig/SORMAS-Project/raw/893781cc91fe82e16f13881b32f3f6ca0f03c63e/sormas-api/src/main/java/de/symeda/sormas/api/document/DocumentRelatedEntityType.java",
    "contents_url": "https://api.github.com/repos/hzi-braunschweig/SORMAS-Project/contents/sormas-api/src/main/java/de/symeda/sormas/api/document/DocumentRelatedEntityType.java?ref=893781cc91fe82e16f13881b32f3f6ca0f03c63e",
    "patch": "@@ -18,6 +18,7 @@\n \n public enum DocumentRelatedEntityType {\n \n+\tACTION,\n \tEVENT;\n \n \tpublic String toString() {"
  },
  {
    "sha": "488c515f3862309e05075138eaffd212735d20f1",
    "filename": "sormas-api/src/main/resources/enum.properties",
    "status": "modified",
    "additions": 1,
    "deletions": 0,
    "changes": 1,
    "blob_url": "https://github.com/hzi-braunschweig/SORMAS-Project/blob/893781cc91fe82e16f13881b32f3f6ca0f03c63e/sormas-api/src/main/resources/enum.properties",
    "raw_url": "https://github.com/hzi-braunschweig/SORMAS-Project/raw/893781cc91fe82e16f13881b32f3f6ca0f03c63e/sormas-api/src/main/resources/enum.properties",
    "contents_url": "https://api.github.com/repos/hzi-braunschweig/SORMAS-Project/contents/sormas-api/src/main/resources/enum.properties?ref=893781cc91fe82e16f13881b32f3f6ca0f03c63e",
    "patch": "@@ -439,6 +439,7 @@ DiseaseTransmissionMode.VECTOR_BORNE = Primarily vector-borne\n DiseaseTransmissionMode.UNKNOWN = Unknown\n \n # DocumentRelatedEntityType\n+DocumentRelatedEntityType.ACTION = Action\n DocumentRelatedEntityType.EVENT = Event\n \n # DocumentWorkflow"
  },
  {
    "sha": "567f96bc4ae2a4383ccdd71e8c7729c6cbb94c9f",
    "filename": "sormas-base/pom.xml",
    "status": "modified",
    "additions": 6,
    "deletions": 0,
    "changes": 6,
    "blob_url": "https://github.com/hzi-braunschweig/SORMAS-Project/blob/893781cc91fe82e16f13881b32f3f6ca0f03c63e/sormas-base/pom.xml",
    "raw_url": "https://github.com/hzi-braunschweig/SORMAS-Project/raw/893781cc91fe82e16f13881b32f3f6ca0f03c63e/sormas-base/pom.xml",
    "contents_url": "https://api.github.com/repos/hzi-braunschweig/SORMAS-Project/contents/sormas-base/pom.xml?ref=893781cc91fe82e16f13881b32f3f6ca0f03c63e",
    "patch": "@@ -719,6 +719,12 @@\n \t\t\t\t<version>0.3.0</version>\n \t\t\t</dependency>\n \n+\t\t\t<dependency>\n+\t\t\t\t<groupId>com.wcs.wcslib</groupId>\n+\t\t\t\t<artifactId>wcslib-vaadin-widget-multifileupload</artifactId>\n+\t\t\t\t<version>4.0</version>\n+\t\t\t</dependency>\n+\n \t\t\t<!-- ** Vaadin END ** -->\n \n \t\t\t<!-- *** Compile dependencies END *** -->"
  },
  {
    "sha": "9632553875194b8eb0fb91cf17ed965a21809f11",
    "filename": "sormas-ui/pom.xml",
    "status": "modified",
    "additions": 5,
    "deletions": 0,
    "changes": 5,
    "blob_url": "https://github.com/hzi-braunschweig/SORMAS-Project/blob/893781cc91fe82e16f13881b32f3f6ca0f03c63e/sormas-ui/pom.xml",
    "raw_url": "https://github.com/hzi-braunschweig/SORMAS-Project/raw/893781cc91fe82e16f13881b32f3f6ca0f03c63e/sormas-ui/pom.xml",
    "contents_url": "https://api.github.com/repos/hzi-braunschweig/SORMAS-Project/contents/sormas-ui/pom.xml?ref=893781cc91fe82e16f13881b32f3f6ca0f03c63e",
    "patch": "@@ -67,6 +67,11 @@\n \t\t   <artifactId>extended-token-field</artifactId>\n \t\t</dependency>\n \n+\t\t<dependency>\n+\t\t\t<groupId>com.wcs.wcslib</groupId>\n+\t\t\t<artifactId>wcslib-vaadin-widget-multifileupload</artifactId>\n+\t\t</dependency>\n+\n \t\t<dependency>\n \t\t\t<groupId>joda-time</groupId>\n \t\t\t<artifactId>joda-time</artifactId>"
  },
  {
    "sha": "37916902ab521c1cdf71746076dae5977b0724eb",
    "filename": "sormas-ui/src/main/java/de/symeda/sormas/ui/action/ActionListEntry.java",
    "status": "modified",
    "additions": 21,
    "deletions": 2,
    "changes": 23,
    "blob_url": "https://github.com/hzi-braunschweig/SORMAS-Project/blob/893781cc91fe82e16f13881b32f3f6ca0f03c63e/sormas-ui/src/main/java/de/symeda/sormas/ui/action/ActionListEntry.java",
    "raw_url": "https://github.com/hzi-braunschweig/SORMAS-Project/raw/893781cc91fe82e16f13881b32f3f6ca0f03c63e/sormas-ui/src/main/java/de/symeda/sormas/ui/action/ActionListEntry.java",
    "contents_url": "https://api.github.com/repos/hzi-braunschweig/SORMAS-Project/contents/sormas-ui/src/main/java/de/symeda/sormas/ui/action/ActionListEntry.java?ref=893781cc91fe82e16f13881b32f3f6ca0f03c63e",
    "patch": "@@ -25,22 +25,28 @@\n import com.google.common.base.Strings;\n import com.vaadin.icons.VaadinIcons;\n import com.vaadin.shared.ui.ContentMode;\n+import com.vaadin.shared.ui.MarginInfo;\n import com.vaadin.ui.Alignment;\n import com.vaadin.ui.Button;\n import com.vaadin.ui.HorizontalLayout;\n import com.vaadin.ui.Label;\n import com.vaadin.ui.VerticalLayout;\n import com.vaadin.ui.themes.ValoTheme;\n \n+import de.symeda.sormas.api.FacadeProvider;\n import de.symeda.sormas.api.action.ActionDto;\n import de.symeda.sormas.api.action.ActionMeasure;\n import de.symeda.sormas.api.action.ActionPriority;\n import de.symeda.sormas.api.action.ActionStatus;\n+import de.symeda.sormas.api.document.DocumentRelatedEntityType;\n import de.symeda.sormas.api.event.EventHelper;\n+import de.symeda.sormas.api.feature.FeatureType;\n import de.symeda.sormas.api.i18n.Captions;\n import de.symeda.sormas.api.i18n.I18nProperties;\n+import de.symeda.sormas.api.user.UserRight;\n import de.symeda.sormas.api.utils.DataHelper;\n import de.symeda.sormas.api.utils.HtmlHelper;\n+import de.symeda.sormas.ui.document.DocumentListComponent;\n import de.symeda.sormas.ui.utils.ButtonHelper;\n import de.symeda.sormas.ui.utils.CssStyles;\n import de.symeda.sormas.ui.utils.DateFormatHelper;\n@@ -63,9 +69,8 @@ public ActionListEntry(ActionDto action) {\n \t\tVerticalLayout withContentLayout = new VerticalLayout();\n \t\twithContentLayout.setMargin(false);\n \t\twithContentLayout.setSpacing(false);\n-\t\twithContentLayout.setWidth(100, Unit.PERCENTAGE);\n \t\taddComponent(withContentLayout);\n-\t\tsetExpandRatio(withContentLayout, 1);\n+\t\tsetExpandRatio(withContentLayout, 3);\n \n \t\tLabel measureOrTitle = new Label(\n \t\t\tMoreObjects\n@@ -181,6 +186,20 @@ public ActionListEntry(ActionDto action) {\n \t\t\t}\n \t\t\tpriorityLabel.addStyleName(statusStyle);\n \t\t}\n+\n+\t\tif (FacadeProvider.getFeatureConfigurationFacade().isFeatureEnabled(FeatureType.DOCUMENTS)) {\n+\t\t\tVerticalLayout documentLayout = new VerticalLayout();\n+\t\t\tdocumentLayout.setMargin(false);\n+\t\t\tdocumentLayout.setSpacing(false);\n+\t\t\taddComponent(documentLayout);\n+\t\t\tsetExpandRatio(documentLayout, 1);\n+\t\t\tdocumentLayout.setMargin(new MarginInfo(true, true, false, false));\n+\n+\t\t\t// TODO: user rights?\n+\t\t\tDocumentListComponent documentList = new DocumentListComponent(DocumentRelatedEntityType.ACTION, action.toReference(), UserRight.EVENT_EDIT);\n+\t\t\tdocumentList.addStyleName(CssStyles.SIDE_COMPONENT);\n+\t\t\tdocumentLayout.addComponent(documentList);\n+\t\t}\n \t}\n \n \tpublic void addEditListener(int rowIndex, Button.ClickListener editClickListener) {"
  },
  {
    "sha": "efdf01d225fa03870ed239b6b2b40171f3aaf859",
    "filename": "sormas-ui/src/main/java/de/symeda/sormas/ui/document/DocumentListComponent.java",
    "status": "modified",
    "additions": 16,
    "deletions": 10,
    "changes": 26,
    "blob_url": "https://github.com/hzi-braunschweig/SORMAS-Project/blob/893781cc91fe82e16f13881b32f3f6ca0f03c63e/sormas-ui/src/main/java/de/symeda/sormas/ui/document/DocumentListComponent.java",
    "raw_url": "https://github.com/hzi-braunschweig/SORMAS-Project/raw/893781cc91fe82e16f13881b32f3f6ca0f03c63e/sormas-ui/src/main/java/de/symeda/sormas/ui/document/DocumentListComponent.java",
    "contents_url": "https://api.github.com/repos/hzi-braunschweig/SORMAS-Project/contents/sormas-ui/src/main/java/de/symeda/sormas/ui/document/DocumentListComponent.java?ref=893781cc91fe82e16f13881b32f3f6ca0f03c63e",
    "patch": "@@ -18,6 +18,8 @@\n import java.io.IOException;\n import java.util.List;\n \n+import org.vaadin.hene.popupbutton.PopupButton;\n+\n import com.vaadin.icons.VaadinIcons;\n import com.vaadin.server.FileDownloader;\n import com.vaadin.server.Page;\n@@ -28,9 +30,10 @@\n import com.vaadin.ui.HorizontalLayout;\n import com.vaadin.ui.Label;\n import com.vaadin.ui.Notification;\n-import com.vaadin.ui.Upload;\n import com.vaadin.ui.VerticalLayout;\n import com.vaadin.ui.themes.ValoTheme;\n+import com.wcs.wcslib.vaadin.widget.multifileupload.ui.MultiFileUpload;\n+import com.wcs.wcslib.vaadin.widget.multifileupload.ui.UploadStateWindow;\n \n import de.symeda.sormas.api.FacadeProvider;\n import de.symeda.sormas.api.ReferenceDto;\n@@ -43,13 +46,13 @@\n import de.symeda.sormas.api.user.UserRight;\n import de.symeda.sormas.api.utils.DataHelper;\n import de.symeda.sormas.ui.UserProvider;\n-import de.symeda.sormas.ui.importer.DocumentReceiver;\n+import de.symeda.sormas.ui.importer.DocumentMultiFileUpload;\n+import de.symeda.sormas.ui.importer.DocumentUploadFinishedHandler;\n import de.symeda.sormas.ui.utils.ButtonHelper;\n import de.symeda.sormas.ui.utils.CssStyles;\n import de.symeda.sormas.ui.utils.VaadinUiUtil;\n \n public class DocumentListComponent extends VerticalLayout {\n-\n \tprivate final DocumentRelatedEntityType relatedEntityType;\n \tprivate final ReferenceDto entityRef;\n \tprivate final UserRight editRight;\n@@ -95,15 +98,18 @@ private Button buildUploadButton() {\n \t\tuploadLayout.addStyleName(CssStyles.LAYOUT_MINIMAL);\n \t\tuploadLayout.setWidth(250, Unit.PIXELS);\n \n-\t\tDocumentReceiver receiver = new DocumentReceiver(relatedEntityType, entityRef.getUuid(), this::reload);\n-\t\tUpload upload = new Upload(\"\", receiver);\n-\t\treceiver.setUpload(upload);\n-\t\tupload.setButtonCaption(I18nProperties.getCaption(Captions.importImportData));\n-\t\tCssStyles.style(upload, CssStyles.VSPACE_2);\n+\t\tPopupButton mainButton =\n+\t\t\tButtonHelper.createIconPopupButton(Captions.documentUploadDocument, VaadinIcons.PLUS_CIRCLE, uploadLayout, ValoTheme.BUTTON_PRIMARY);\n+\t\tMultiFileUpload multiFileUpload =\n+\t\t\tnew DocumentMultiFileUpload(new DocumentUploadFinishedHandler(relatedEntityType, entityRef.getUuid(), this::reload), new UploadStateWindow());\n+\t\tmultiFileUpload\n+\t\t\t.setUploadButtonCaptions(I18nProperties.getCaption(Captions.importImportData), I18nProperties.getCaption(Captions.importImportData));\n+\t\tmultiFileUpload.setAllUploadFinishedHandler(() -> mainButton.setPopupVisible(false));\n+\t\tCssStyles.style(multiFileUpload, CssStyles.VSPACE_2);\n \n-\t\tuploadLayout.addComponentsAndExpand(upload);\n+\t\tuploadLayout.addComponentsAndExpand(multiFileUpload);\n \n-\t\treturn ButtonHelper.createIconPopupButton(Captions.documentUploadDocument, VaadinIcons.PLUS_CIRCLE, uploadLayout, ValoTheme.BUTTON_PRIMARY);\n+\t\treturn mainButton;\n \t}\n \n \tprivate void reload() {"
  },
  {
    "sha": "e0d4b7c1b48d8a763492e42b14b7260c9889fdfb",
    "filename": "sormas-ui/src/main/java/de/symeda/sormas/ui/importer/DocumentMultiFileUpload.java",
    "status": "added",
    "additions": 39,
    "deletions": 0,
    "changes": 39,
    "blob_url": "https://github.com/hzi-braunschweig/SORMAS-Project/blob/893781cc91fe82e16f13881b32f3f6ca0f03c63e/sormas-ui/src/main/java/de/symeda/sormas/ui/importer/DocumentMultiFileUpload.java",
    "raw_url": "https://github.com/hzi-braunschweig/SORMAS-Project/raw/893781cc91fe82e16f13881b32f3f6ca0f03c63e/sormas-ui/src/main/java/de/symeda/sormas/ui/importer/DocumentMultiFileUpload.java",
    "contents_url": "https://api.github.com/repos/hzi-braunschweig/SORMAS-Project/contents/sormas-ui/src/main/java/de/symeda/sormas/ui/importer/DocumentMultiFileUpload.java?ref=893781cc91fe82e16f13881b32f3f6ca0f03c63e",
    "patch": "@@ -0,0 +1,39 @@\n+/*\n+ * SORMAS® - Surveillance Outbreak Response Management & Analysis System\n+ * Copyright © 2016-2021 Helmholtz-Zentrum für Infektionsforschung GmbH (HZI)\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU General Public License for more details.\n+ * You should have received a copy of the GNU General Public License\n+ * along with this program. If not, see <https://www.gnu.org/licenses/>.\n+ */\n+\n+package de.symeda.sormas.ui.importer;\n+\n+import com.wcs.wcslib.vaadin.widget.multifileupload.ui.MultiFileUpload;\n+import com.wcs.wcslib.vaadin.widget.multifileupload.ui.UploadFinishedHandler;\n+import com.wcs.wcslib.vaadin.widget.multifileupload.ui.UploadStatePanel;\n+import com.wcs.wcslib.vaadin.widget.multifileupload.ui.UploadStateWindow;\n+\n+import de.symeda.sormas.ui.SormasUI;\n+\n+public class DocumentMultiFileUpload extends MultiFileUpload {\n+\n+\tpublic DocumentMultiFileUpload(UploadFinishedHandler uploadFinishedHandler, UploadStateWindow uploadStateWindow) {\n+\t\tsuper(uploadFinishedHandler, uploadStateWindow);\n+\n+\t\t// Need to enable Polling or nothing will happen after selecting a file with the MultiFileUpload input\n+\t\tthis.addAttachListener(e -> SormasUI.get().access(() -> SormasUI.get().setPollInterval(300)));\n+\t\tthis.addDetachListener(e -> SormasUI.get().access(() -> SormasUI.get().setPollInterval(-1)));\n+\t}\n+\n+\t@Override\n+\tprotected UploadStatePanel createStatePanel(UploadStateWindow uploadStateWindow) {\n+\t\treturn new UploadStatePanel(uploadStateWindow, new DocumentUploadReceiver());\n+\t}\n+}"
  },
  {
    "sha": "74eb0fc99458c2028427c1670b6287eb409a841e",
    "filename": "sormas-ui/src/main/java/de/symeda/sormas/ui/importer/DocumentUploadFinishedHandler.java",
    "status": "added",
    "additions": 121,
    "deletions": 0,
    "changes": 121,
    "blob_url": "https://github.com/hzi-braunschweig/SORMAS-Project/blob/893781cc91fe82e16f13881b32f3f6ca0f03c63e/sormas-ui/src/main/java/de/symeda/sormas/ui/importer/DocumentUploadFinishedHandler.java",
    "raw_url": "https://github.com/hzi-braunschweig/SORMAS-Project/raw/893781cc91fe82e16f13881b32f3f6ca0f03c63e/sormas-ui/src/main/java/de/symeda/sormas/ui/importer/DocumentUploadFinishedHandler.java",
    "contents_url": "https://api.github.com/repos/hzi-braunschweig/SORMAS-Project/contents/sormas-ui/src/main/java/de/symeda/sormas/ui/importer/DocumentUploadFinishedHandler.java?ref=893781cc91fe82e16f13881b32f3f6ca0f03c63e",
    "patch": "@@ -0,0 +1,121 @@\n+/*\n+ * SORMAS® - Surveillance Outbreak Response Management & Analysis System\n+ * Copyright © 2016-2021 Helmholtz-Zentrum für Infektionsforschung GmbH (HZI)\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU General Public License for more details.\n+ * You should have received a copy of the GNU General Public License\n+ * along with this program. If not, see <https://www.gnu.org/licenses/>.\n+ */\n+\n+package de.symeda.sormas.ui.importer;\n+\n+import java.io.InputStream;\n+\n+import com.google.common.io.ByteStreams;\n+import com.vaadin.server.Page;\n+import com.vaadin.ui.Label;\n+import com.vaadin.ui.Notification;\n+import com.wcs.wcslib.vaadin.widget.multifileupload.ui.UploadFinishedHandler;\n+\n+import de.symeda.sormas.api.FacadeProvider;\n+import de.symeda.sormas.api.document.DocumentDto;\n+import de.symeda.sormas.api.document.DocumentRelatedEntityType;\n+import de.symeda.sormas.api.i18n.Captions;\n+import de.symeda.sormas.api.i18n.I18nProperties;\n+import de.symeda.sormas.api.i18n.Strings;\n+import de.symeda.sormas.ui.UserProvider;\n+import de.symeda.sormas.ui.utils.VaadinUiUtil;\n+\n+public class DocumentUploadFinishedHandler implements UploadFinishedHandler {\n+\n+\tprivate final DocumentRelatedEntityType relatedEntityType;\n+\tprivate final String relatedEntityUuid;\n+\tprivate final Runnable callback;\n+\n+\tpublic DocumentUploadFinishedHandler(DocumentRelatedEntityType relatedEntityType, String relatedEntityUuid, Runnable callback) {\n+\t\tthis.relatedEntityType = relatedEntityType;\n+\t\tthis.relatedEntityUuid = relatedEntityUuid;\n+\t\tthis.callback = callback;\n+\t}\n+\n+\t@Override\n+\tpublic void handleFile(InputStream inputStream, String fileName, String mimeType, long length, int filesLeftInQueue) {\n+\t\ttry {\n+\t\t\tbyte[] bytes = ByteStreams.toByteArray(inputStream);\n+\n+\t\t\tString existing = FacadeProvider.getDocumentFacade().isExistingDocument(relatedEntityType, relatedEntityUuid, fileName);\n+\t\t\tif (existing != null) {\n+\t\t\t\tVaadinUiUtil.showConfirmationPopup(\n+\t\t\t\t\tI18nProperties.getString(Strings.headingFileExists),\n+\t\t\t\t\tnew Label(String.format(I18nProperties.getString(Strings.infoDocumentAlreadyExists), fileName)),\n+\t\t\t\t\tI18nProperties.getCaption(Captions.actionConfirm),\n+\t\t\t\t\tI18nProperties.getCaption(Captions.actionCancel),\n+\t\t\t\t\tnull,\n+\t\t\t\t\tok -> {\n+\t\t\t\t\t\tif (ok) {\n+\t\t\t\t\t\t\tFacadeProvider.getDocumentFacade().deleteDocument(existing);\n+\t\t\t\t\t\t\ttry {\n+\t\t\t\t\t\t\t\tsaveDocument(fileName, mimeType, length, relatedEntityType, relatedEntityUuid, bytes);\n+\t\t\t\t\t\t\t} catch (Exception e) {\n+\t\t\t\t\t\t\t\tnew Notification(\n+\t\t\t\t\t\t\t\t\tI18nProperties.getString(Strings.headingImportError),\n+\t\t\t\t\t\t\t\t\tI18nProperties.getString(Strings.messageImportError),\n+\t\t\t\t\t\t\t\t\tNotification.Type.ERROR_MESSAGE,\n+\t\t\t\t\t\t\t\t\tfalse).show(Page.getCurrent());\n+\t\t\t\t\t\t\t\tthrow new RuntimeException(e);\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\tif (filesLeftInQueue == 0) {\n+\t\t\t\t\t\t\t\tNotification.show(I18nProperties.getString(Strings.headingUploadSuccess), Notification.Type.TRAY_NOTIFICATION);\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t}\n+\t\t\t\t\t\tif (filesLeftInQueue == 0) {\n+\t\t\t\t\t\t\tif (callback != null) {\n+\t\t\t\t\t\t\t\tcallback.run();\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t}\n+\t\t\t\t\t});\n+\t\t\t} else {\n+\t\t\t\tsaveDocument(fileName, mimeType, length, relatedEntityType, relatedEntityUuid, bytes);\n+\n+\t\t\t\tif (filesLeftInQueue == 0) {\n+\t\t\t\t\tNotification.show(I18nProperties.getString(Strings.headingUploadSuccess), Notification.Type.TRAY_NOTIFICATION);\n+\t\t\t\t\tif (callback != null) {\n+\t\t\t\t\t\tcallback.run();\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t}\n+\t\t} catch (Exception e) {\n+\t\t\tnew Notification(\n+\t\t\t\tI18nProperties.getString(Strings.headingImportError),\n+\t\t\t\tI18nProperties.getString(Strings.messageImportError),\n+\t\t\t\tNotification.Type.ERROR_MESSAGE,\n+\t\t\t\tfalse).show(Page.getCurrent());\n+\t\t\tthrow new RuntimeException(e);\n+\t\t}\n+\t}\n+\n+\tprivate void saveDocument(\n+\t\tString fileName,\n+\t\tString mimeType,\n+\t\tLong length,\n+\t\tDocumentRelatedEntityType relatedEntityType,\n+\t\tString relatedEntityUuid,\n+\t\tbyte[] bytes)\n+\t\tthrows Exception {\n+\t\tDocumentDto document = DocumentDto.build();\n+\t\tdocument.setUploadingUser(UserProvider.getCurrent().getUserReference());\n+\t\tdocument.setName(fileName);\n+\t\tdocument.setMimeType(mimeType);\n+\t\tdocument.setSize(length);\n+\t\tdocument.setRelatedEntityType(relatedEntityType);\n+\t\tdocument.setRelatedEntityUuid(relatedEntityUuid);\n+\n+\t\tFacadeProvider.getDocumentFacade().saveDocument(document, bytes);\n+\t}\n+}"
  },
  {
    "sha": "f5adf3d22d1285f46e42d1a2e3673aad998612a7",
    "filename": "sormas-ui/src/main/java/de/symeda/sormas/ui/importer/DocumentUploadReceiver.java",
    "status": "added",
    "additions": 89,
    "deletions": 0,
    "changes": 89,
    "blob_url": "https://github.com/hzi-braunschweig/SORMAS-Project/blob/893781cc91fe82e16f13881b32f3f6ca0f03c63e/sormas-ui/src/main/java/de/symeda/sormas/ui/importer/DocumentUploadReceiver.java",
    "raw_url": "https://github.com/hzi-braunschweig/SORMAS-Project/raw/893781cc91fe82e16f13881b32f3f6ca0f03c63e/sormas-ui/src/main/java/de/symeda/sormas/ui/importer/DocumentUploadReceiver.java",
    "contents_url": "https://api.github.com/repos/hzi-braunschweig/SORMAS-Project/contents/sormas-ui/src/main/java/de/symeda/sormas/ui/importer/DocumentUploadReceiver.java?ref=893781cc91fe82e16f13881b32f3f6ca0f03c63e",
    "patch": "@@ -0,0 +1,89 @@\n+/*\n+ * SORMAS® - Surveillance Outbreak Response Management & Analysis System\n+ * Copyright © 2016-2021 Helmholtz-Zentrum für Infektionsforschung GmbH (HZI)\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU General Public License for more details.\n+ * You should have received a copy of the GNU General Public License\n+ * along with this program. If not, see <https://www.gnu.org/licenses/>.\n+ */\n+\n+package de.symeda.sormas.ui.importer;\n+\n+import java.io.BufferedInputStream;\n+import java.io.BufferedOutputStream;\n+import java.io.ByteArrayOutputStream;\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.util.Date;\n+\n+import com.vaadin.server.Page;\n+import com.vaadin.ui.Notification;\n+import com.wcs.wcslib.vaadin.widget.multifileupload.receiver.UploadReceiver;\n+\n+import de.symeda.sormas.api.FacadeProvider;\n+import de.symeda.sormas.api.i18n.I18nProperties;\n+import de.symeda.sormas.api.i18n.Strings;\n+import de.symeda.sormas.api.importexport.ImportExportUtils;\n+import de.symeda.sormas.api.utils.DataHelper;\n+import de.symeda.sormas.api.utils.DateHelper;\n+import de.symeda.sormas.ui.UserProvider;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class DocumentUploadReceiver implements UploadReceiver {\n+\n+\tprivate static final Logger LOGGER = LoggerFactory.getLogger(DocumentUploadReceiver.class);\n+\n+\tprivate File file;\n+\n+\t@Override\n+\tpublic OutputStream receiveUpload() {\n+\t\ttry {\n+\t\t\tString newFileName = ImportExportUtils.TEMP_FILE_PREFIX + \"_document_upload\" + DateHelper.formatDateForExport(new Date()) + \"_\"\n+\t\t\t\t+ DataHelper.getShortUuid(UserProvider.getCurrent().getUuid());\n+\t\t\tfile = Paths.get(FacadeProvider.getConfigFacade().getTempFilesPath()).resolve(newFileName).toFile();\n+\t\t\treturn new BufferedOutputStream(Files.newOutputStream(file.toPath()));\n+\n+\t\t} catch (IOException e) {\n+\t\t\tdeleteTempFile();\n+\t\t\tLOGGER.error(e.getMessage(), e);\n+\t\t\tnew Notification(\n+\t\t\t\tI18nProperties.getString(Strings.headingImportError),\n+\t\t\t\tI18nProperties.getString(Strings.messageImportError),\n+\t\t\t\tNotification.Type.ERROR_MESSAGE,\n+\t\t\t\tfalse).show(Page.getCurrent());\n+\t\t\t// Workaround because returning null here throws an uncatchable UploadException\n+\t\t\treturn new ByteArrayOutputStream();\n+\t\t}\n+\t}\n+\n+\t@Override\n+\tpublic void deleteTempFile() {\n+\t\tif (file != null && file.exists()) {\n+\t\t\tfile.delete();\n+\t\t\tfile = null;\n+\t\t}\n+\t}\n+\n+\t@Override\n+\tpublic InputStream getStream() {\n+\t\ttry {\n+\t\t\tif (file != null) {\n+\t\t\t\treturn new BufferedInputStream(Files.newInputStream(file.toPath()));\n+\t\t\t}\n+\t\t\treturn null;\n+\t\t} catch (IOException e) {\n+\t\t\tthrow new RuntimeException(e);\n+\t\t}\n+\t}\n+}"
  },
  {
    "sha": "482a4290fef8ca3b64d126a30b2de49f3e5a4240",
    "filename": "sormas-widgetset/pom.xml",
    "status": "modified",
    "additions": 5,
    "deletions": 0,
    "changes": 5,
    "blob_url": "https://github.com/hzi-braunschweig/SORMAS-Project/blob/893781cc91fe82e16f13881b32f3f6ca0f03c63e/sormas-widgetset/pom.xml",
    "raw_url": "https://github.com/hzi-braunschweig/SORMAS-Project/raw/893781cc91fe82e16f13881b32f3f6ca0f03c63e/sormas-widgetset/pom.xml",
    "contents_url": "https://api.github.com/repos/hzi-braunschweig/SORMAS-Project/contents/sormas-widgetset/pom.xml?ref=893781cc91fe82e16f13881b32f3f6ca0f03c63e",
    "patch": "@@ -35,6 +35,11 @@\n \t\t   <groupId>org.vaadin.addons</groupId>\n \t\t   <artifactId>extended-token-field</artifactId>\n \t\t</dependency>\n+\n+\t\t<dependency>\n+\t\t\t<groupId>com.wcs.wcslib</groupId>\n+\t\t\t<artifactId>wcslib-vaadin-widget-multifileupload</artifactId>\n+\t\t</dependency>\n     </dependencies>\n     <build>\n         <plugins>"
  },
  {
    "sha": "59538c19b2ef583807a5d1de0f29b0744594005e",
    "filename": "sormas-widgetset/src/main/resources/de/symeda/sormas/SormasWidgetset.gwt.xml",
    "status": "modified",
    "additions": 2,
    "deletions": 0,
    "changes": 2,
    "blob_url": "https://github.com/hzi-braunschweig/SORMAS-Project/blob/893781cc91fe82e16f13881b32f3f6ca0f03c63e/sormas-widgetset/src/main/resources/de/symeda/sormas/SormasWidgetset.gwt.xml",
    "raw_url": "https://github.com/hzi-braunschweig/SORMAS-Project/raw/893781cc91fe82e16f13881b32f3f6ca0f03c63e/sormas-widgetset/src/main/resources/de/symeda/sormas/SormasWidgetset.gwt.xml",
    "contents_url": "https://api.github.com/repos/hzi-braunschweig/SORMAS-Project/contents/sormas-widgetset/src/main/resources/de/symeda/sormas/SormasWidgetset.gwt.xml?ref=893781cc91fe82e16f13881b32f3f6ca0f03c63e",
    "patch": "@@ -9,4 +9,6 @@\n     <inherits name=\"com.explicatis.ext_token_field.WidgetSet\" />\n \n     <inherits name=\"com.vaadin.v7.Vaadin7WidgetSet\" />\n+\n+    <inherits name=\"com.wcs.wcslib.vaadin.widget.multifileupload.WidgetSet\" />\n </module>"
  }
]

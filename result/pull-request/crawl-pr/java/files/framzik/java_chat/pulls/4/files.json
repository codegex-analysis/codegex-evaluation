[
  {
    "sha": "46e34746020b42cf1ff2daccf9b6a94a9cc9276d",
    "filename": "client/chats/history_123.txt",
    "status": "added",
    "additions": 11,
    "deletions": 0,
    "changes": 11,
    "blob_url": "https://github.com/framzik/java_chat/blob/58766d61501830a1d5bcb89461fb0b66674e1b6c/client/chats/history_123.txt",
    "raw_url": "https://github.com/framzik/java_chat/raw/58766d61501830a1d5bcb89461fb0b66674e1b6c/client/chats/history_123.txt",
    "contents_url": "https://api.github.com/repos/framzik/java_chat/contents/client/chats/history_123.txt?ref=58766d61501830a1d5bcb89461fb0b66674e1b6c",
    "patch": "@@ -0,0 +1,11 @@\n+[ asd ]: h\\ello\n+[ asd ]: howeare you?\n+[ qwe ]: ok,and y?\n+[ 123 ]: wse good\n+[ 123 ]: hi\n+[ qwe ]: hello\n+[ 123 ]: ывыыв\n+[ 123 ]: фывфвфыв\n+[ 123 ]: фвфыв\n+[ 123 ]: gfgdfg\n+[ 123 ]: dfgdfgdg"
  },
  {
    "sha": "9d865d37dba3f1c54d26dd3bebda714971ccb27e",
    "filename": "client/chats/history_asd.txt",
    "status": "added",
    "additions": 6,
    "deletions": 0,
    "changes": 6,
    "blob_url": "https://github.com/framzik/java_chat/blob/58766d61501830a1d5bcb89461fb0b66674e1b6c/client/chats/history_asd.txt",
    "raw_url": "https://github.com/framzik/java_chat/raw/58766d61501830a1d5bcb89461fb0b66674e1b6c/client/chats/history_asd.txt",
    "contents_url": "https://api.github.com/repos/framzik/java_chat/contents/client/chats/history_asd.txt?ref=58766d61501830a1d5bcb89461fb0b66674e1b6c",
    "patch": "@@ -0,0 +1,6 @@\n+[ asd ]: h\\ello\n+[ asd ]: howeare you?\n+[ qwe ]: ok,and y?\n+[ 123 ]: wse good\n+[ asd ]: \n+[ 123 ]: dfgdfgdg"
  },
  {
    "sha": "5ad5cc836c8ba0aa6331c57089ec5ab1e116b79d",
    "filename": "client/chats/history_qwe.txt",
    "status": "added",
    "additions": 7,
    "deletions": 0,
    "changes": 7,
    "blob_url": "https://github.com/framzik/java_chat/blob/58766d61501830a1d5bcb89461fb0b66674e1b6c/client/chats/history_qwe.txt",
    "raw_url": "https://github.com/framzik/java_chat/raw/58766d61501830a1d5bcb89461fb0b66674e1b6c/client/chats/history_qwe.txt",
    "contents_url": "https://api.github.com/repos/framzik/java_chat/contents/client/chats/history_qwe.txt?ref=58766d61501830a1d5bcb89461fb0b66674e1b6c",
    "patch": "@@ -0,0 +1,7 @@\n+[ asd ]: hqwello\n+[ asd ]: howeare you?\n+[ qwe ]: ok,and y?\n+[ 123 ]: wse good\n+[ qwe ]: hello\n+[ 123 ]: gfgdfg\n+[ 123 ]: dfgdfgdg"
  },
  {
    "sha": "19dba8ed947ad42caa5380bcb4a3bee0908b7808",
    "filename": "client/src/main/java/client/Controller.java",
    "status": "modified",
    "additions": 186,
    "deletions": 12,
    "changes": 198,
    "blob_url": "https://github.com/framzik/java_chat/blob/58766d61501830a1d5bcb89461fb0b66674e1b6c/client/src/main/java/client/Controller.java",
    "raw_url": "https://github.com/framzik/java_chat/raw/58766d61501830a1d5bcb89461fb0b66674e1b6c/client/src/main/java/client/Controller.java",
    "contents_url": "https://api.github.com/repos/framzik/java_chat/contents/client/src/main/java/client/Controller.java?ref=58766d61501830a1d5bcb89461fb0b66674e1b6c",
    "patch": "@@ -4,22 +4,30 @@\n import javafx.application.Platform;\n import javafx.event.ActionEvent;\n import javafx.fxml.FXML;\n+import javafx.fxml.FXMLLoader;\n import javafx.fxml.Initializable;\n+import javafx.scene.Parent;\n+import javafx.scene.Scene;\n+import javafx.scene.control.ListView;\n import javafx.scene.control.PasswordField;\n import javafx.scene.control.TextArea;\n import javafx.scene.control.TextField;\n+import javafx.scene.input.MouseEvent;\n import javafx.scene.layout.HBox;\n+import javafx.stage.Modality;\n import javafx.stage.Stage;\n+import javafx.stage.StageStyle;\n \n-import java.io.DataInputStream;\n-import java.io.DataOutputStream;\n-import java.io.IOException;\n+import java.io.*;\n import java.net.Socket;\n import java.net.URL;\n-import java.net.UnknownHostException;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.util.List;\n import java.util.ResourceBundle;\n \n public class Controller implements Initializable {\n+\n     @FXML\n     public TextArea textArea;\n     @FXML\n@@ -32,23 +40,33 @@\n     public HBox authPanel;\n     @FXML\n     public HBox msgPanel;\n+    @FXML\n+    public ListView<String> clientList;\n \n     private Socket socket;\n     private DataInputStream in;\n     private DataOutputStream out;\n+    private FileWriter fileWriter;\n+\n     private final int PORT = 8189;\n     private final String IP_ADDRESS = \"localhost\";\n \n     private boolean authenticated;\n     private String nickname;\n     private Stage stage;\n+    private Stage regStage;\n+    private Stage updNickStage;\n+    private UpdNicNameController updNicNameController;\n+    private RegController regController;\n \n     public void setAuthenticated(boolean authenticated) {\n         this.authenticated = authenticated;\n         msgPanel.setVisible(authenticated);\n         msgPanel.setManaged(authenticated);\n         authPanel.setVisible(!authenticated);\n         authPanel.setManaged(!authenticated);\n+        clientList.setVisible(authenticated);\n+        clientList.setManaged(authenticated);\n \n         if (!authenticated) {\n             nickname = \"\";\n@@ -61,6 +79,16 @@ public void setAuthenticated(boolean authenticated) {\n     public void initialize(URL location, ResourceBundle resources) {\n         Platform.runLater(() -> {\n             stage = (Stage) textArea.getScene().getWindow();\n+            stage.setOnCloseRequest(event -> {\n+                System.out.println(\"bye\");\n+                if (socket != null && !socket.isClosed()) {\n+                    try {\n+                        out.writeUTF(Command.END);\n+                    } catch (IOException e) {\n+                        e.printStackTrace();\n+                    }\n+                }\n+            });\n         });\n         setAuthenticated(false);\n     }\n@@ -85,22 +113,59 @@ private void connect() {\n                                 String[] token = str.split(\"\\\\s\");\n                                 nickname = token[1];\n                                 setAuthenticated(true);\n+                                fileWriter = initialFw();\n+                                printHistory();\n                                 break;\n                             }\n+\n+                            if (str.equals(Command.REG_OK)) {\n+                                regController.setResultTryToReg(Command.REG_OK);\n+                            }\n+\n+                            if (str.equals(Command.REG_NO)) {\n+                                regController.setResultTryToReg(Command.REG_NO);\n+                            }\n+\n+\n                         } else {\n-                            textArea.appendText(str + \"\\n\");\n+                            String msg = str + \"\\n\";\n+                            textArea.appendText(msg);\n+                            fileWriter.write(msg);\n+                            fileWriter.flush();\n                         }\n                     }\n                     //цикл работы\n                     while (true) {\n                         String str = in.readUTF();\n \n-                        if (str.equals(Command.END)) {\n-                            System.out.println(\"Client disconnected\");\n-                            break;\n-                        }\n+                        if (str.startsWith(\"/\")) {\n+                            if (str.equals(Command.END)) {\n+                                System.out.println(\"Client disconnected\");\n+                                break;\n+                            }\n+                            if (str.startsWith(Command.CLIENT_LIST)) {\n+                                String[] token = str.split(\"\\\\s\");\n+                                Platform.runLater(() -> {\n+                                    clientList.getItems().clear();\n+                                    for (int i = 1; i < token.length; i++) {\n+                                        clientList.getItems().add(token[i]);\n+                                    }\n+                                });\n+                            }\n+                            if (str.equals(Command.UPD_OK)) {\n+                                updNicNameController.setResultTryToUpdNick(Command.UPD_OK);\n+                            }\n+\n+                            if (str.equals(Command.UPD_NO)) {\n+                                updNicNameController.setResultTryToUpdNick(Command.UPD_NO);\n+                            }\n \n-                        textArea.appendText(str + \"\\n\");\n+                        } else {\n+                            String msg = str + \"\\n\";\n+                            textArea.appendText(msg);\n+                            fileWriter.write(msg);\n+                            fileWriter.flush();\n+                        }\n                     }\n                 } catch (RuntimeException e) {\n                     System.out.println(e.getMessage());\n@@ -109,6 +174,7 @@ private void connect() {\n                 } finally {\n                     setAuthenticated(false);\n                     try {\n+                        fileWriter.close();\n                         socket.close();\n                     } catch (IOException e) {\n                         e.printStackTrace();\n@@ -138,7 +204,8 @@ public void tryToAuth(ActionEvent actionEvent) {\n         }\n \n         try {\n-            out.writeUTF(String.format(\"%s %s %s\", Command.AUTH, loginField.getText().trim(), passwordField.getText().trim()));\n+            out.writeUTF(String.format(\"%s %s %s\", Command.AUTH, loginField.getText().trim(),\n+                    passwordField.getText().trim()));\n \n         } catch (IOException e) {\n             e.printStackTrace();\n@@ -147,7 +214,7 @@ public void tryToAuth(ActionEvent actionEvent) {\n         }\n     }\n \n-    private void setTitle(String nickname) {\n+    protected void setTitle(String nickname) {\n         Platform.runLater(() -> {\n             if (nickname.equals(\"\")) {\n                 stage.setTitle(\"Best chat of World\");\n@@ -156,4 +223,111 @@ private void setTitle(String nickname) {\n             }\n         });\n     }\n+\n+    public void clientListMouseReleased(MouseEvent mouseEvent) {\n+        System.out.println(clientList.getSelectionModel().getSelectedItem());\n+        String msg = String\n+                .format(\"%s %s \", Command.PRIVATE_MSG, clientList.getSelectionModel().getSelectedItem());\n+        textField.setText(msg);\n+    }\n+\n+    public void showRegWindow(ActionEvent actionEvent) {\n+        if (regStage == null) {\n+            initRegWindow();\n+        }\n+        regStage.show();\n+    }\n+\n+    public void showUpdNickWindow(ActionEvent actionEvent) {\n+\n+        if (updNickStage == null) {\n+            initUpdNickWindow();\n+        }\n+        updNickStage.show();\n+    }\n+\n+    private void initUpdNickWindow() {\n+        try {\n+            FXMLLoader fxmlLoader = new FXMLLoader(getClass().getResource(\"/updNickName.fxml\"));\n+            Parent root = fxmlLoader.load();\n+\n+            updNicNameController = fxmlLoader.getController();\n+            updNicNameController.setController(this);\n+\n+            updNickStage = new Stage();\n+            updNickStage.setTitle(\"Best chat of World registration\");\n+            updNickStage.setScene(new Scene(root, 450, 350));\n+            updNickStage.initStyle(StageStyle.UTILITY);\n+            updNickStage.initModality(Modality.APPLICATION_MODAL);\n+        } catch (IOException e) {\n+            e.printStackTrace();\n+        }\n+    }\n+\n+    private void initRegWindow() {\n+        try {\n+            FXMLLoader fxmlLoader = new FXMLLoader(getClass().getResource(\"/reg.fxml\"));\n+            Parent root = fxmlLoader.load();\n+\n+            regController = fxmlLoader.getController();\n+            regController.setController(this);\n+\n+            regStage = new Stage();\n+            regStage.setTitle(\"Best chat of World registration\");\n+            regStage.setScene(new Scene(root, 450, 350));\n+            regStage.initStyle(StageStyle.UTILITY);\n+            regStage.initModality(Modality.APPLICATION_MODAL);\n+\n+        } catch (IOException e) {\n+            e.printStackTrace();\n+        }\n+    }\n+\n+    public void registration(String login, String password, String nickname) {\n+        if (socket == null || socket.isClosed()) {\n+            connect();\n+        }\n+        try {\n+            out.writeUTF(String.format(\"%s %s %s %s\", Command.REG, login, password, nickname));\n+        } catch (IOException e) {\n+            e.printStackTrace();\n+        }\n+    }\n+\n+    public void tryUpd(String nickname) {\n+        try {\n+            out.writeUTF(String.format(\"%s %s\", Command.UPD_NICKNAME, nickname));\n+        } catch (IOException e) {\n+            e.printStackTrace();\n+        }\n+    }\n+\n+    public FileWriter initialFw() throws IOException {\n+        if (fileWriter == null) {\n+            fileWriter = new FileWriter(String.format(\"client/chats/history_%s.txt\", nickname), true);\n+        }\n+        return fileWriter;\n+    }\n+\n+    public void printHistory() {\n+\n+        StringBuilder sb = new StringBuilder();\n+        try {\n+            List<String> historyLines = Files.readAllLines(\n+                    new File(String.format(\"client/chats/history_%s.txt\", nickname)).toPath(), StandardCharsets.UTF_8);\n+            int startPosition = 0;\n+            if (historyLines.size() > 100) {\n+                startPosition = historyLines.size() - 100;\n+            }\n+            for (int i = startPosition; i < historyLines.size(); i++) {\n+                sb.append(historyLines.get(i)).append(System.lineSeparator());\n+            }\n+        } catch (IOException e) {\n+            e.printStackTrace();\n+        }\n+        textArea.appendText(sb.toString());\n+    }\n }\n+\n+\n+"
  },
  {
    "sha": "e72d025810667053a3557b3c82d53b7e4b497ce5",
    "filename": "client/src/main/java/client/RegController.java",
    "status": "added",
    "additions": 46,
    "deletions": 0,
    "changes": 46,
    "blob_url": "https://github.com/framzik/java_chat/blob/58766d61501830a1d5bcb89461fb0b66674e1b6c/client/src/main/java/client/RegController.java",
    "raw_url": "https://github.com/framzik/java_chat/raw/58766d61501830a1d5bcb89461fb0b66674e1b6c/client/src/main/java/client/RegController.java",
    "contents_url": "https://api.github.com/repos/framzik/java_chat/contents/client/src/main/java/client/RegController.java?ref=58766d61501830a1d5bcb89461fb0b66674e1b6c",
    "patch": "@@ -0,0 +1,46 @@\n+package client;\n+\n+import commands.Command;\n+import javafx.event.ActionEvent;\n+import javafx.fxml.FXML;\n+import javafx.scene.control.PasswordField;\n+import javafx.scene.control.TextArea;\n+import javafx.scene.control.TextField;\n+\n+public class RegController {\n+    @FXML\n+    private TextField loginField;\n+    @FXML\n+    private PasswordField passwordField;\n+    @FXML\n+    private TextField nicknameField;\n+    @FXML\n+    private TextArea textArea;\n+\n+    private Controller controller;\n+\n+    public void setController(Controller controller) {\n+        this.controller = controller;\n+    }\n+\n+    public void setResultTryToReg(String command) {\n+        if (command.equals(Command.REG_OK)) {\n+            textArea.appendText(\"Регистрация прошла успешно\\n\");\n+        }\n+        if (command.equals(Command.REG_NO)) {\n+            textArea.appendText(\"Логин или никнейм уже заняты\\n\");\n+        }\n+    }\n+\n+    public void tryToReg(ActionEvent actionEvent) {\n+        String login = loginField.getText().trim();\n+        String password = passwordField.getText().trim();\n+        String nickname = nicknameField.getText().trim();\n+\n+        if (login.length() * password.length() * nickname.length() == 0) {\n+            return;\n+        }\n+\n+        controller.registration(login, password, nickname);\n+    }\n+}"
  },
  {
    "sha": "255c32653aafb0dbcf859233544c77f643448fd2",
    "filename": "client/src/main/java/client/UpdNicNameController.java",
    "status": "added",
    "additions": 41,
    "deletions": 0,
    "changes": 41,
    "blob_url": "https://github.com/framzik/java_chat/blob/58766d61501830a1d5bcb89461fb0b66674e1b6c/client/src/main/java/client/UpdNicNameController.java",
    "raw_url": "https://github.com/framzik/java_chat/raw/58766d61501830a1d5bcb89461fb0b66674e1b6c/client/src/main/java/client/UpdNicNameController.java",
    "contents_url": "https://api.github.com/repos/framzik/java_chat/contents/client/src/main/java/client/UpdNicNameController.java?ref=58766d61501830a1d5bcb89461fb0b66674e1b6c",
    "patch": "@@ -0,0 +1,41 @@\n+package client;\n+\n+import commands.Command;\n+import javafx.event.ActionEvent;\n+import javafx.fxml.FXML;\n+import javafx.scene.control.TextArea;\n+import javafx.scene.control.TextField;\n+\n+public class UpdNicNameController {\n+\n+  @FXML\n+  public TextField nicknameFieldUpd;\n+  @FXML\n+  public TextArea textAreaUpd;\n+  private String nickname;\n+\n+  private Controller controller;\n+\n+  public void setController(Controller controller) {\n+    this.controller = controller;\n+  }\n+\n+  public void updateNickName(ActionEvent actionEvent) {\n+    nickname = nicknameFieldUpd.getText().trim();\n+    if (nickname.length() == 0) {\n+      textAreaUpd.appendText(\"Новый никнейм не может быть пустым!\\n\");\n+      return;\n+    }\n+    controller.tryUpd(nickname);\n+  }\n+\n+  public void setResultTryToUpdNick(String command) {\n+    if (command.equals(Command.UPD_OK)) {\n+      textAreaUpd.appendText(\"Обновление никнейма прошло успешно\\n\");\n+      controller.setTitle(nickname);\n+    }\n+    if (command.equals(Command.UPD_NO)) {\n+      textAreaUpd.appendText(\"Такой никнейм уже занят\\n\");\n+    }\n+  }\n+}"
  },
  {
    "sha": "9b3bc4dca09525897654e9c8e402ac1943464271",
    "filename": "client/src/main/resources/reg.fxml",
    "status": "added",
    "additions": 23,
    "deletions": 0,
    "changes": 23,
    "blob_url": "https://github.com/framzik/java_chat/blob/58766d61501830a1d5bcb89461fb0b66674e1b6c/client/src/main/resources/reg.fxml",
    "raw_url": "https://github.com/framzik/java_chat/raw/58766d61501830a1d5bcb89461fb0b66674e1b6c/client/src/main/resources/reg.fxml",
    "contents_url": "https://api.github.com/repos/framzik/java_chat/contents/client/src/main/resources/reg.fxml?ref=58766d61501830a1d5bcb89461fb0b66674e1b6c",
    "patch": "@@ -0,0 +1,23 @@\n+<?import javafx.scene.control.Button?>\n+<?import javafx.scene.control.TextArea?>\n+<?import javafx.scene.control.TextField?>\n+<?import javafx.scene.layout.HBox?>\n+<?import javafx.scene.layout.VBox?>\n+<?import java.net.URL?>\n+<?import javafx.scene.control.PasswordField?>\n+<?import javafx.scene.control.ListView?>\n+<VBox fx:controller=\"client.RegController\"\n+      xmlns:fx=\"http://javafx.com/fxml\" alignment=\"center\">\n+    <stylesheets>\n+        <URL value=\"@/css/style.css\"/>\n+    </stylesheets>\n+\n+    <TextField fx:id=\"loginField\" promptText=\"login\"/>\n+    <PasswordField fx:id=\"passwordField\" promptText=\"password\"/>\n+    <TextField fx:id=\"nicknameField\" promptText=\"nickname\"/>\n+    <TextArea fx:id=\"textArea\" VBox.vgrow=\"ALWAYS\"/>\n+\n+    <Button text=\"reg\" minWidth=\"100\" onAction=\"#tryToReg\"/>\n+\n+\n+</VBox>\n\\ No newline at end of file"
  },
  {
    "sha": "efb6e7408b9d1d601d1d38fcff66b5b8784b79c7",
    "filename": "client/src/main/resources/sample.fxml",
    "status": "modified",
    "additions": 9,
    "deletions": 1,
    "changes": 10,
    "blob_url": "https://github.com/framzik/java_chat/blob/58766d61501830a1d5bcb89461fb0b66674e1b6c/client/src/main/resources/sample.fxml",
    "raw_url": "https://github.com/framzik/java_chat/raw/58766d61501830a1d5bcb89461fb0b66674e1b6c/client/src/main/resources/sample.fxml",
    "contents_url": "https://api.github.com/repos/framzik/java_chat/contents/client/src/main/resources/sample.fxml?ref=58766d61501830a1d5bcb89461fb0b66674e1b6c",
    "patch": "@@ -5,6 +5,7 @@\n <?import javafx.scene.layout.VBox?>\n <?import java.net.URL?>\n <?import javafx.scene.control.PasswordField?>\n+<?import javafx.scene.control.ListView?>\n <VBox fx:controller=\"client.Controller\"\n       xmlns:fx=\"http://javafx.com/fxml\" alignment=\"center\">\n     <stylesheets>\n@@ -15,11 +16,18 @@\n         <TextField fx:id=\"loginField\" HBox.hgrow=\"ALWAYS\" promptText=\"login\"/>\n         <PasswordField fx:id=\"passwordField\" HBox.hgrow=\"ALWAYS\" promptText=\"password\" onAction=\"#tryToAuth\"/>\n         <Button text=\"auth\" onAction=\"#tryToAuth\" minWidth=\"100\"/>\n+        <Button text=\"reg\" onAction=\"#showRegWindow\" minWidth=\"100\"/>\n+    </HBox>\n+\n+    <HBox VBox.vgrow =\"ALWAYS\">\n+        <TextArea fx:id=\"textArea\" HBox.hgrow=\"ALWAYS\" editable=\"false\"/>\n+        <ListView fx:id=\"clientList\" visible=\"false\" managed=\"false\" minWidth=\"100\"\n+        onMouseReleased=\"#clientListMouseReleased\"/>\n     </HBox>\n \n-    <TextArea fx:id=\"textArea\" VBox.vgrow=\"ALWAYS\" editable=\"false\"/>\n \n     <HBox fx:id=\"msgPanel\" visible=\"false\" managed=\"false\">\n+        <Button text=\"ChangeNick\" onAction=\"#showUpdNickWindow\"/>\n         <TextField fx:id=\"textField\" HBox.hgrow=\"ALWAYS\" promptText=\"input text\" onAction=\"#sendMsg\"/>\n         <Button text=\"send\" onAction=\"#sendMsg\"/>\n     </HBox>"
  },
  {
    "sha": "b7a171f61793737a47c3ddee4f6895deb4039066",
    "filename": "client/src/main/resources/updNickName.fxml",
    "status": "added",
    "additions": 16,
    "deletions": 0,
    "changes": 16,
    "blob_url": "https://github.com/framzik/java_chat/blob/58766d61501830a1d5bcb89461fb0b66674e1b6c/client/src/main/resources/updNickName.fxml",
    "raw_url": "https://github.com/framzik/java_chat/raw/58766d61501830a1d5bcb89461fb0b66674e1b6c/client/src/main/resources/updNickName.fxml",
    "contents_url": "https://api.github.com/repos/framzik/java_chat/contents/client/src/main/resources/updNickName.fxml?ref=58766d61501830a1d5bcb89461fb0b66674e1b6c",
    "patch": "@@ -0,0 +1,16 @@\n+<?import javafx.scene.control.Button?>\n+<?import javafx.scene.control.TextArea?>\n+<?import javafx.scene.control.TextField?>\n+<?import javafx.scene.layout.VBox?>\n+<?import java.net.URL?>\n+<VBox fx:controller=\"client.UpdNicNameController\"\n+  xmlns:fx=\"http://javafx.com/fxml\" alignment=\"center\">\n+  <stylesheets>\n+    <URL value=\"@/css/style.css\"/>\n+  </stylesheets>\n+\n+  <TextField fx:id=\"nicknameFieldUpd\" promptText=\"NewNickname\"/>\n+  <TextArea fx:id=\"textAreaUpd\" VBox.vgrow=\"ALWAYS\"/>\n+  <Button text=\"upd\" minWidth=\"100\" onAction=\"#updateNickName\"/>\n+\n+</VBox>\n\\ No newline at end of file"
  },
  {
    "sha": "403827df91726777ddcf8a661d5cfa3a913bf9e8",
    "filename": "command/src/main/java/commands/Command.java",
    "status": "modified",
    "additions": 9,
    "deletions": 1,
    "changes": 10,
    "blob_url": "https://github.com/framzik/java_chat/blob/58766d61501830a1d5bcb89461fb0b66674e1b6c/command/src/main/java/commands/Command.java",
    "raw_url": "https://github.com/framzik/java_chat/raw/58766d61501830a1d5bcb89461fb0b66674e1b6c/command/src/main/java/commands/Command.java",
    "contents_url": "https://api.github.com/repos/framzik/java_chat/contents/command/src/main/java/commands/Command.java?ref=58766d61501830a1d5bcb89461fb0b66674e1b6c",
    "patch": "@@ -4,6 +4,14 @@\n     public static final String END = \"/end\";\n     public static final String AUTH = \"/auth\";\n     public static final String AUTH_OK = \"/authok\";\n-    public static final String W = \"/w\";\n+    public static final String PRIVATE_MSG = \"/w\";\n+    public static final String CLIENT_LIST = \"/clientlist\";\n+    public static final String REG = \"/reg\";\n+    public static final String REG_OK = \"/regok\";\n+    public static final String REG_NO = \"/regno\";\n+    public static final String UPD_NICKNAME = \"/upd\";\n+    public static final String UPD_OK = \"/updok\";\n+    public static final String UPD_NO = \"/updno\";\n+\n \n }"
  },
  {
    "sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391",
    "filename": "identifier.sqlite",
    "status": "added",
    "additions": 0,
    "deletions": 0,
    "changes": 0,
    "blob_url": "https://github.com/framzik/java_chat/blob/58766d61501830a1d5bcb89461fb0b66674e1b6c/identifier.sqlite",
    "raw_url": "https://github.com/framzik/java_chat/raw/58766d61501830a1d5bcb89461fb0b66674e1b6c/identifier.sqlite",
    "contents_url": "https://api.github.com/repos/framzik/java_chat/contents/identifier.sqlite?ref=58766d61501830a1d5bcb89461fb0b66674e1b6c"
  },
  {
    "sha": "30236085acf8d2a2e880f6dee0c6831b89eeecdc",
    "filename": "java3.db",
    "status": "added",
    "additions": 0,
    "deletions": 0,
    "changes": 0,
    "blob_url": "https://github.com/framzik/java_chat/blob/58766d61501830a1d5bcb89461fb0b66674e1b6c/java3.db",
    "raw_url": "https://github.com/framzik/java_chat/raw/58766d61501830a1d5bcb89461fb0b66674e1b6c/java3.db",
    "contents_url": "https://api.github.com/repos/framzik/java_chat/contents/java3.db?ref=58766d61501830a1d5bcb89461fb0b66674e1b6c"
  },
  {
    "sha": "ae5651ab8d5fd15544eb28a95e209bf54ed921eb",
    "filename": "server/pom.xml",
    "status": "modified",
    "additions": 9,
    "deletions": 0,
    "changes": 9,
    "blob_url": "https://github.com/framzik/java_chat/blob/58766d61501830a1d5bcb89461fb0b66674e1b6c/server/pom.xml",
    "raw_url": "https://github.com/framzik/java_chat/raw/58766d61501830a1d5bcb89461fb0b66674e1b6c/server/pom.xml",
    "contents_url": "https://api.github.com/repos/framzik/java_chat/contents/server/pom.xml?ref=58766d61501830a1d5bcb89461fb0b66674e1b6c",
    "patch": "@@ -16,4 +16,13 @@\n         <maven.compiler.target>8</maven.compiler.target>\n     </properties>\n \n+    <dependencies>\n+        <!-- https://mvnrepository.com/artifact/org.xerial/sqlite-jdbc -->\n+        <dependency>\n+            <groupId>org.xerial</groupId>\n+            <artifactId>sqlite-jdbc</artifactId>\n+            <version>3.34.0</version>\n+        </dependency>\n+    </dependencies>\n+\n </project>\n\\ No newline at end of file"
  },
  {
    "sha": "76204f6b6486e0948987dbfa3c2f8f5401767bd5",
    "filename": "server/src/main/java/server/AuthService.java",
    "status": "modified",
    "additions": 8,
    "deletions": 1,
    "changes": 9,
    "blob_url": "https://github.com/framzik/java_chat/blob/58766d61501830a1d5bcb89461fb0b66674e1b6c/server/src/main/java/server/AuthService.java",
    "raw_url": "https://github.com/framzik/java_chat/raw/58766d61501830a1d5bcb89461fb0b66674e1b6c/server/src/main/java/server/AuthService.java",
    "contents_url": "https://api.github.com/repos/framzik/java_chat/contents/server/src/main/java/server/AuthService.java?ref=58766d61501830a1d5bcb89461fb0b66674e1b6c",
    "patch": "@@ -1,5 +1,12 @@\n package server;\n \n public interface AuthService {\n-    String getNicknameByLoginAndPassword(String login, String password);\n+\n+  String getNicknameByLoginAndPassword(String login, String password);\n+\n+  boolean registration(String login, String password, String nickname);\n+\n+  boolean updNicName(String nickName, String login);\n+\n+  void disconnect();\n }"
  },
  {
    "sha": "ef19aa28ecb8d063d830f81ee6fe9a5189b83d24",
    "filename": "server/src/main/java/server/ClientHandler.java",
    "status": "modified",
    "additions": 81,
    "deletions": 19,
    "changes": 100,
    "blob_url": "https://github.com/framzik/java_chat/blob/58766d61501830a1d5bcb89461fb0b66674e1b6c/server/src/main/java/server/ClientHandler.java",
    "raw_url": "https://github.com/framzik/java_chat/raw/58766d61501830a1d5bcb89461fb0b66674e1b6c/server/src/main/java/server/ClientHandler.java",
    "contents_url": "https://api.github.com/repos/framzik/java_chat/contents/server/src/main/java/server/ClientHandler.java?ref=58766d61501830a1d5bcb89461fb0b66674e1b6c",
    "patch": "@@ -6,6 +6,7 @@\n import java.io.DataOutputStream;\n import java.io.IOException;\n import java.net.Socket;\n+import java.net.SocketTimeoutException;\n \n public class ClientHandler {\n \n@@ -15,60 +16,117 @@\n   private DataOutputStream out;\n \n   private String nickname;\n+  private String login;\n \n   public ClientHandler(Server server, Socket socket) {\n     try {\n       this.server = server;\n       this.socket = socket;\n       in = new DataInputStream(socket.getInputStream());\n       out = new DataOutputStream(socket.getOutputStream());\n-\n+      /*\n+        Решил не менять управление потоками через ExecutorService, т.к.\n+        1. Я ленивый\n+        2. У нас создается всего лишь 1 дополнительный поток(кроме основного), а значит нет смысла использовать\n+        ExecutorService, который так же будет создавть 1 поток, и закрывать его.\n+      */\n       new Thread(() -> {\n         try {\n+          // установка сокет тайм аут\n+          socket.setSoTimeout(120000);\n+\n           // цикл аутентификации\n           while (true) {\n             String str = in.readUTF();\n \n+            //если команда отключиться\n             if (str.equals(Command.END)) {\n               out.writeUTF(Command.END);\n               throw new RuntimeException(\"Клиент захотел отключиться\");\n             }\n+\n+            //если команда аутентификация\n             if (str.startsWith(Command.AUTH)) {\n-              String[] token = str.split(\"\\\\s\");\n+              String[] token = str.split(\"\\\\s\", 3);\n               if (token.length < 3) {\n                 continue;\n               }\n               String newNick = server.getAuthService()\n                   .getNicknameByLoginAndPassword(token[1], token[2]);\n-\n+              login = token[1];\n               if (newNick != null) {\n-                nickname = newNick;\n-                sendMsg(Command.AUTH_OK + \" \" + nickname);\n-                server.subscribe(this);\n-                System.out.println(\"client: \" + socket.getRemoteSocketAddress() +\n-                    \" connected with nick: \" + nickname);\n-                break;\n+                if (!server.isLoginAuthenticated(login)) {\n+                  nickname = newNick;\n+                  sendMsg(Command.AUTH_OK + \" \" + nickname);\n+                  server.subscribe(this);\n+                  System.out.println(\"client: \" + socket.getRemoteSocketAddress() +\n+                      \" connected with nick: \" + nickname);\n+                  socket.setSoTimeout(0);\n+                  break;\n+                } else {\n+                  sendMsg(\"Данная учетная запись уже используется\");\n+                }\n               } else {\n                 sendMsg(\"Неверный логин / пароль\");\n               }\n             }\n+\n+            //если команда регистрация\n+            if (str.startsWith(Command.REG)) {\n+              String[] token = str.split(\"\\\\s\", 4);\n+              if (token.length < 4) {\n+                continue;\n+              }\n+              boolean regSuccess = server.getAuthService()\n+                  .registration(token[1], token[2], token[3]);\n+              if (regSuccess) {\n+                sendMsg(Command.REG_OK);\n+              } else {\n+                sendMsg(Command.REG_NO);\n+              }\n+            }\n           }\n           //цикл работы\n           while (true) {\n             String str = in.readUTF();\n \n-            if (str.equals(Command.END)) {\n-              out.writeUTF(Command.END);\n-              break;\n-            }\n-            if (str.startsWith(Command.W)) {\n-              String[] token = str.split(\"\\\\s\", 3);\n-              server.privateMsg(this, token[2], token[1]);\n-              continue;\n-            }\n+            if (str.startsWith(\"/\")) {\n+              if (str.equals(Command.END)) {\n+                out.writeUTF(Command.END);\n+                break;\n+              }\n \n-            server.broadcastMsg(this, str);\n+              if (str.startsWith(Command.PRIVATE_MSG)) {\n+                String[] token = str.split(\"\\\\s\", 3);\n+                if (token.length < 3) {\n+                  continue;\n+                }\n+                server.privateMsg(this, token[1], token[2]);\n+              }\n+\n+              //если команда обновить никнейм\n+              if (str.startsWith(Command.UPD_NICKNAME)) {\n+                String[] token = str.split(\"\\\\s\", 2);\n+                if (token.length < 2) {\n+                  continue;\n+                }\n+                boolean updNickNameSuccess = server.getAuthService().updNicName(token[1], login);\n+                if (updNickNameSuccess) {\n+                  server.unsubscribe(this);\n+                  nickname = token[1];\n+                  server.subscribe(this);\n+                  sendMsg(Command.UPD_OK);\n+                } else {\n+                  sendMsg(Command.UPD_NO);\n+                }\n+              }\n+            } else {\n+              server.broadcastMsg(this, str);\n+            }\n           }\n+          //SocketTimeoutException\n+        } catch (SocketTimeoutException e) {\n+          this.sendMsg(Command.END);\n         } catch (RuntimeException e) {\n           System.out.println(e.getMessage());\n         } catch (IOException e) {\n@@ -99,4 +157,8 @@ public void sendMsg(String msg) {\n   public String getNickname() {\n     return nickname;\n   }\n+\n+  public String getLogin() {\n+    return login;\n+  }\n }"
  },
  {
    "sha": "d5cbf02d8a3e7a010876a796cff3beab739cc3e5",
    "filename": "server/src/main/java/server/DbAuthService.java",
    "status": "added",
    "additions": 92,
    "deletions": 0,
    "changes": 92,
    "blob_url": "https://github.com/framzik/java_chat/blob/58766d61501830a1d5bcb89461fb0b66674e1b6c/server/src/main/java/server/DbAuthService.java",
    "raw_url": "https://github.com/framzik/java_chat/raw/58766d61501830a1d5bcb89461fb0b66674e1b6c/server/src/main/java/server/DbAuthService.java",
    "contents_url": "https://api.github.com/repos/framzik/java_chat/contents/server/src/main/java/server/DbAuthService.java?ref=58766d61501830a1d5bcb89461fb0b66674e1b6c",
    "patch": "@@ -0,0 +1,92 @@\n+package server;\n+\n+import java.sql.Connection;\n+import java.sql.DriverManager;\n+import java.sql.PreparedStatement;\n+import java.sql.SQLException;\n+import java.sql.Statement;\n+\n+public class DbAuthService implements AuthService {\n+\n+  private Connection connection;\n+  private Statement statement;\n+\n+  public DbAuthService() {\n+    try {\n+      connect();\n+    } catch (ClassNotFoundException | SQLException e) {\n+      e.printStackTrace();\n+    }\n+  }\n+\n+  @Override\n+  public String getNicknameByLoginAndPassword(String login, String password) {\n+    String nickname = null;\n+    try {\n+      PreparedStatement psFindLogin = connection\n+          .prepareStatement(\"SELECT nickname FROM users where login = ? AND password =?; \");\n+      psFindLogin.setString(1, login);\n+      psFindLogin.setString(2, password);\n+      nickname = psFindLogin.executeQuery().getString(\"nickname\");\n+    } catch (SQLException throwable) {\n+      throwable.printStackTrace();\n+    }\n+    return nickname;\n+  }\n+\n+  @Override\n+  public boolean registration(String login, String password, String nickname) {\n+    boolean ok = false;\n+    try {\n+      PreparedStatement psInsert = connection\n+          .prepareStatement(\"INSERT INTO users (login,password,nickname) values (?,?,?);\");\n+      psInsert.setString(1, login);\n+      psInsert.setString(2, password);\n+      psInsert.setString(3, nickname);\n+      if (psInsert.executeUpdate() != 0) {\n+        ok = true;\n+      }\n+    } catch (SQLException throwable) {\n+      throwable.printStackTrace();\n+    }\n+    return ok;\n+  }\n+\n+  @Override\n+  public boolean updNicName(String newNickName, String login) {\n+    boolean ok = false;\n+    try {\n+      PreparedStatement psUpdNicName = connection\n+          .prepareStatement(\"UPDATE users SET nickname = ? WHERE login = ?;\");\n+      psUpdNicName.setString(1, newNickName);\n+      psUpdNicName.setString(2, login);\n+      if (psUpdNicName.executeUpdate() != 0) {\n+        ok = true;\n+      }\n+    } catch (SQLException throwable) {\n+      throwable.printStackTrace();\n+    }\n+    return ok;\n+  }\n+\n+\n+  private void connect() throws ClassNotFoundException, SQLException {\n+    Class.forName(\"org.sqlite.JDBC\");\n+    connection = DriverManager.getConnection(\"jdbc:sqlite:java3.db\");\n+    statement = connection.createStatement();\n+  }\n+\n+  @Override\n+  public void disconnect() {\n+    try {\n+      statement.close();\n+    } catch (SQLException e) {\n+      e.printStackTrace();\n+    }\n+    try {\n+      connection.close();\n+    } catch (SQLException e) {\n+      e.printStackTrace();\n+    }\n+  }\n+}"
  },
  {
    "sha": "03708b2658964ccbcb94567979fc0b9b5e9dd0f5",
    "filename": "server/src/main/java/server/Server.java",
    "status": "modified",
    "additions": 42,
    "deletions": 8,
    "changes": 50,
    "blob_url": "https://github.com/framzik/java_chat/blob/58766d61501830a1d5bcb89461fb0b66674e1b6c/server/src/main/java/server/Server.java",
    "raw_url": "https://github.com/framzik/java_chat/raw/58766d61501830a1d5bcb89461fb0b66674e1b6c/server/src/main/java/server/Server.java",
    "contents_url": "https://api.github.com/repos/framzik/java_chat/contents/server/src/main/java/server/Server.java?ref=58766d61501830a1d5bcb89461fb0b66674e1b6c",
    "patch": "@@ -1,5 +1,7 @@\n package server;\n \n+import commands.Command;\n+\n import java.io.DataInputStream;\n import java.io.DataOutputStream;\n import java.io.IOException;\n@@ -21,7 +23,7 @@\n \n   public Server() {\n     clients = new CopyOnWriteArrayList<>();\n-    authService = new SimpleAuthService();\n+    authService = new DbAuthService();\n \n     try {\n       server = new ServerSocket(PORT);\n@@ -37,6 +39,7 @@ public Server() {\n     } catch (IOException e) {\n       e.printStackTrace();\n     } finally {\n+      authService.disconnect();\n       try {\n         socket.close();\n       } catch (IOException e) {\n@@ -57,28 +60,59 @@ public void broadcastMsg(ClientHandler sender, String msg) {\n     }\n   }\n \n-  public void privateMsg(ClientHandler sender, String msg, String nick) {\n+  public void privateMsg(ClientHandler sender, String receiver, String msg) {\n+    String message = String.format(\"[ %s ] to [ %s ]: %s\", sender.getNickname(), receiver, msg);\n     for (ClientHandler c : clients) {\n-      if (c.getNickname().equals(nick) ) {\n-        String message = String.format(\"[ %s ] отправил Вам личное сообщение: %s\", sender.getNickname(), msg);\n-        c.sendMsg(message);\n-      }\n-      if ( c == sender) {\n-        String message = String.format(\"Вы отправили [ %s ] личное сообщение: %s\", sender.getNickname(), msg);\n+      if (c.getNickname().equals(receiver)) {\n         c.sendMsg(message);\n+        if (!c.equals(sender)) {\n+          sender.sendMsg(message);\n+        }\n+        return;\n       }\n     }\n+    sender.sendMsg(\"not found user: \" + receiver);\n   }\n \n   public void subscribe(ClientHandler clientHandler) {\n     clients.add(clientHandler);\n+    broadcastClientList();\n   }\n \n   public void unsubscribe(ClientHandler clientHandler) {\n     clients.remove(clientHandler);\n+    broadcastClientList();\n+  }\n+\n+  public void updateNickName(String nickname){\n+\n   }\n \n+\n   public AuthService getAuthService() {\n     return authService;\n   }\n+\n+  public boolean isLoginAuthenticated(String login) {\n+    for (ClientHandler c : clients) {\n+      if (c.getLogin().equals(login)) {\n+        return true;\n+      }\n+    }\n+    return false;\n+  }\n+\n+  public void broadcastClientList() {\n+    StringBuilder sb = new StringBuilder(Command.CLIENT_LIST);\n+\n+    for (ClientHandler c : clients) {\n+      sb.append(\" \").append(c.getNickname());\n+    }\n+\n+    String msg = sb.toString();\n+\n+    for (ClientHandler c : clients) {\n+      c.sendMsg(msg);\n+    }\n+  }\n }"
  },
  {
    "sha": "aa2e0a2ba223ead75b88cf4b3f815798f987bff4",
    "filename": "server/src/main/java/server/SimpleAuthService.java",
    "status": "modified",
    "additions": 52,
    "deletions": 27,
    "changes": 79,
    "blob_url": "https://github.com/framzik/java_chat/blob/58766d61501830a1d5bcb89461fb0b66674e1b6c/server/src/main/java/server/SimpleAuthService.java",
    "raw_url": "https://github.com/framzik/java_chat/raw/58766d61501830a1d5bcb89461fb0b66674e1b6c/server/src/main/java/server/SimpleAuthService.java",
    "contents_url": "https://api.github.com/repos/framzik/java_chat/contents/server/src/main/java/server/SimpleAuthService.java?ref=58766d61501830a1d5bcb89461fb0b66674e1b6c",
    "patch": "@@ -4,39 +4,64 @@\n import java.util.List;\n \n public class SimpleAuthService implements AuthService {\n-    private class UserData {\n-        String login;\n-        String password;\n-        String nickname;\n-\n-        public UserData(String login, String password, String nickname) {\n-            this.login = login;\n-            this.password = password;\n-            this.nickname = nickname;\n-        }\n+\n+  private class UserData {\n+\n+    String login;\n+    String password;\n+    String nickname;\n+\n+    public UserData(String login, String password, String nickname) {\n+      this.login = login;\n+      this.password = password;\n+      this.nickname = nickname;\n     }\n+  }\n+\n+  private List<UserData> users;\n \n-    private List<UserData> users;\n+  public SimpleAuthService() {\n+    users = new ArrayList<>();\n+    users.add(new UserData(\"qwe\", \"qwe\", \"qwe\"));\n+    users.add(new UserData(\"asd\", \"asd\", \"asd\"));\n+    users.add(new UserData(\"zxc\", \"zxc\", \"zxc\"));\n \n-    public SimpleAuthService() {\n-        users = new ArrayList<>();\n-        users.add(new UserData(\"qwe\", \"qwe\", \"qwe\"));\n-        users.add(new UserData(\"asd\", \"asd\", \"asd\"));\n-        users.add(new UserData(\"zxc\", \"zxc\", \"zxc\"));\n+    for (int i = 1; i < 10; i++) {\n+      users.add(new UserData(\"login\" + i, \"pass\" + i, \"nick\" + i));\n+    }\n+  }\n \n-        for (int i = 1; i < 10; i++) {\n-            users.add(new UserData(\"login\" + i, \"pass\" + i, \"nick\" + i));\n-        }\n+  @Override\n+  public String getNicknameByLoginAndPassword(String login, String password) {\n+    for (UserData user : users) {\n+      if (user.login.equals(login) && user.password.equals(password)) {\n+        return user.nickname;\n+      }\n     }\n \n-    @Override\n-    public String getNicknameByLoginAndPassword(String login, String password) {\n-        for (UserData user : users) {\n-            if(user.login.equals(login) && user.password.equals(password)){\n-                return user.nickname;\n-            }\n-        }\n+    return null;\n+  }\n \n-        return null;\n+  @Override\n+  public boolean registration(String login, String password, String nickname) {\n+    for (UserData user : users) {\n+      if (user.login.equals(login) || user.nickname.equals(nickname)) {\n+        return false;\n+      }\n     }\n+\n+    users.add(new UserData(login, password, nickname));\n+    return true;\n+  }\n+\n+  @Override\n+  public boolean updNicName(String nickName, String login) {\n+    //заглушка\n+    return false;\n+  }\n+\n+  @Override\n+  public void disconnect() {\n+    //заглушка\n+  }\n }"
  }
]

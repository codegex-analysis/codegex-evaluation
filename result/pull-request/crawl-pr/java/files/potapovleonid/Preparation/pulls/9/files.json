[
  {
    "sha": "156627f38d04ddc21e55a1fbadbba7c0b6cc88b9",
    "filename": "lessson07/pom.xml",
    "status": "modified",
    "additions": 9,
    "deletions": 0,
    "changes": 9,
    "blob_url": "https://github.com/potapovleonid/Preparation/blob/77a7904336772f0d14257f71bb22dbc8728e6651/lessson07/pom.xml",
    "raw_url": "https://github.com/potapovleonid/Preparation/raw/77a7904336772f0d14257f71bb22dbc8728e6651/lessson07/pom.xml",
    "contents_url": "https://api.github.com/repos/potapovleonid/Preparation/contents/lessson07/pom.xml?ref=77a7904336772f0d14257f71bb22dbc8728e6651",
    "patch": "@@ -56,6 +56,15 @@\n             <artifactId>spring-boot-starter-test</artifactId>\n             <scope>test</scope>\n         </dependency>\n+        <dependency>\n+            <groupId>org.springframework.security</groupId>\n+            <artifactId>spring-security-test</artifactId>\n+            <scope>test</scope>\n+        </dependency>\n+        <dependency>\n+            <groupId>org.springframework.boot</groupId>\n+            <artifactId>spring-boot-starter-security</artifactId>\n+        </dependency>\n     </dependencies>\n \n     <build>"
  },
  {
    "sha": "7af78f077ce335573f3c905aa72d25cb01358e01",
    "filename": "lessson07/src/main/java/ru/home/des/configs/SecurityConfig.java",
    "status": "added",
    "additions": 76,
    "deletions": 0,
    "changes": 76,
    "blob_url": "https://github.com/potapovleonid/Preparation/blob/77a7904336772f0d14257f71bb22dbc8728e6651/lessson07/src/main/java/ru/home/des/configs/SecurityConfig.java",
    "raw_url": "https://github.com/potapovleonid/Preparation/raw/77a7904336772f0d14257f71bb22dbc8728e6651/lessson07/src/main/java/ru/home/des/configs/SecurityConfig.java",
    "contents_url": "https://api.github.com/repos/potapovleonid/Preparation/contents/lessson07/src/main/java/ru/home/des/configs/SecurityConfig.java?ref=77a7904336772f0d14257f71bb22dbc8728e6651",
    "patch": "@@ -0,0 +1,76 @@\n+package ru.home.des.configs;\n+\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.context.ApplicationContext;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.security.authentication.dao.DaoAuthenticationProvider;\n+import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;\n+import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;\n+import org.springframework.security.config.annotation.web.builders.HttpSecurity;\n+import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;\n+import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;\n+import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;\n+import org.springframework.security.crypto.password.PasswordEncoder;\n+import org.springframework.security.web.util.matcher.AntPathRequestMatcher;\n+import ru.home.des.entity.UserAuthority;\n+import ru.home.des.entity.UserRole;\n+import ru.home.des.services.UserService;\n+\n+@Configuration\n+@EnableWebSecurity\n+@EnableGlobalMethodSecurity(securedEnabled = true,\n+                            jsr250Enabled = true,\n+                            prePostEnabled = true)\n+public class SecurityConfig extends WebSecurityConfigurerAdapter {\n+\n+    @Autowired\n+    private ApplicationContext context;\n+\n+    private UserService userService;\n+\n+    @Override\n+    protected void configure(AuthenticationManagerBuilder auth){\n+        auth.authenticationProvider(authenticationProvider());\n+    }\n+\n+    @Bean\n+    public PasswordEncoder passwordEncoder(){\n+        return new BCryptPasswordEncoder();\n+    }\n+\n+    @Bean\n+    public DaoAuthenticationProvider authenticationProvider(){\n+        initializeUserService();\n+        DaoAuthenticationProvider authenticationProvider = new DaoAuthenticationProvider();\n+        authenticationProvider.setUserDetailsService(userService);\n+        authenticationProvider.setPasswordEncoder(passwordEncoder());\n+        return authenticationProvider;\n+    }\n+\n+    private void initializeUserService() {\n+        this.userService = context.getBean(UserService.class);\n+    }\n+\n+    @Override\n+    protected void configure(HttpSecurity http) throws Exception {\n+        http.authorizeRequests()\n+                .antMatchers(\"/students\").hasAnyAuthority(\n+                UserAuthority.ADMIN.name(), UserAuthority.MANAGER.name())\n+                .antMatchers(\"/students\").hasAnyRole(UserRole.ROLE_ADMIN.name())\n+                .anyRequest().permitAll()\n+                .and()\n+                .formLogin()\n+                .loginPage(\"/login\")\n+                .loginProcessingUrl(\"/auth\")\n+                .failureUrl(\"/login-error\")\n+                .permitAll()\n+                .and()\n+                .logout().logoutRequestMatcher(new AntPathRequestMatcher(\"/logout\"))\n+                .logoutSuccessUrl(\"/\").deleteCookies(\"JSESSIONDID\")\n+                .invalidateHttpSession(true)\n+                .and()\n+                .csrf().disable();\n+    }\n+\n+}"
  },
  {
    "sha": "eadfd67f24a6125d63f3f01c25bc10a64713c27d",
    "filename": "lessson07/src/main/java/ru/home/des/controllers/MainController.java",
    "status": "modified",
    "additions": 7,
    "deletions": 0,
    "changes": 7,
    "blob_url": "https://github.com/potapovleonid/Preparation/blob/77a7904336772f0d14257f71bb22dbc8728e6651/lessson07/src/main/java/ru/home/des/controllers/MainController.java",
    "raw_url": "https://github.com/potapovleonid/Preparation/raw/77a7904336772f0d14257f71bb22dbc8728e6651/lessson07/src/main/java/ru/home/des/controllers/MainController.java",
    "contents_url": "https://api.github.com/repos/potapovleonid/Preparation/contents/lessson07/src/main/java/ru/home/des/controllers/MainController.java?ref=77a7904336772f0d14257f71bb22dbc8728e6651",
    "patch": "@@ -1,14 +1,21 @@\n package ru.home.des.controllers;\n \n+import org.springframework.security.access.prepost.PreAuthorize;\n import org.springframework.stereotype.Controller;\n import org.springframework.web.bind.annotation.RequestMapping;\n \n @Controller\n public class MainController {\n \n+    @PreAuthorize(\"isAuthenticated()\")\n     @RequestMapping({\"\", \"/\"})\n     public String index(){\n         return \"index\";\n     }\n \n+    @RequestMapping(\"/login\")\n+    public String login(){\n+        return \"login\";\n+    }\n+\n }"
  },
  {
    "sha": "7f8cb71ec258b857c0f772eefcf73f8a67b7684f",
    "filename": "lessson07/src/main/java/ru/home/des/entity/User.java",
    "status": "added",
    "additions": 37,
    "deletions": 0,
    "changes": 37,
    "blob_url": "https://github.com/potapovleonid/Preparation/blob/77a7904336772f0d14257f71bb22dbc8728e6651/lessson07/src/main/java/ru/home/des/entity/User.java",
    "raw_url": "https://github.com/potapovleonid/Preparation/raw/77a7904336772f0d14257f71bb22dbc8728e6651/lessson07/src/main/java/ru/home/des/entity/User.java",
    "contents_url": "https://api.github.com/repos/potapovleonid/Preparation/contents/lessson07/src/main/java/ru/home/des/entity/User.java?ref=77a7904336772f0d14257f71bb22dbc8728e6651",
    "patch": "@@ -0,0 +1,37 @@\n+package ru.home.des.entity;\n+\n+import lombok.AllArgsConstructor;\n+import lombok.Builder;\n+import lombok.Data;\n+import lombok.NoArgsConstructor;\n+\n+import javax.persistence.*;\n+\n+@Entity\n+@Builder\n+@Data\n+@NoArgsConstructor\n+@AllArgsConstructor\n+@Table(name = \"user_tbl\")\n+public class User {\n+    private static final String SEQUANCE_NAME = \"user_seq\";\n+\n+    @Id\n+    @GeneratedValue(strategy = GenerationType.IDENTITY, generator = SEQUANCE_NAME)\n+    @SequenceGenerator(name = SEQUANCE_NAME, sequenceName = SEQUANCE_NAME, allocationSize = 1)\n+    @Column(name = \"user_id\")\n+    private Long id;\n+\n+    @Column(name = \"login_fld\")\n+    private String login;\n+\n+    @Column(name = \"password_fld\")\n+    private String password;\n+\n+    @Column(name = \"user_role_fld\")\n+    private UserRole role;\n+\n+    @Column(name = \"user_authority\")\n+    private UserAuthority authority;\n+\n+}"
  },
  {
    "sha": "ebc54a515ef6257e1e49100e02a71e5f1559d547",
    "filename": "lessson07/src/main/java/ru/home/des/entity/UserAuthority.java",
    "status": "added",
    "additions": 5,
    "deletions": 0,
    "changes": 5,
    "blob_url": "https://github.com/potapovleonid/Preparation/blob/77a7904336772f0d14257f71bb22dbc8728e6651/lessson07/src/main/java/ru/home/des/entity/UserAuthority.java",
    "raw_url": "https://github.com/potapovleonid/Preparation/raw/77a7904336772f0d14257f71bb22dbc8728e6651/lessson07/src/main/java/ru/home/des/entity/UserAuthority.java",
    "contents_url": "https://api.github.com/repos/potapovleonid/Preparation/contents/lessson07/src/main/java/ru/home/des/entity/UserAuthority.java?ref=77a7904336772f0d14257f71bb22dbc8728e6651",
    "patch": "@@ -0,0 +1,5 @@\n+package ru.home.des.entity;\n+\n+public enum UserAuthority {\n+    ADMIN, MANAGER, STUDENT, TEACHER\n+}"
  },
  {
    "sha": "c6dd867a0d8508bc52b1eed7804297289c62aff4",
    "filename": "lessson07/src/main/java/ru/home/des/entity/UserRole.java",
    "status": "added",
    "additions": 5,
    "deletions": 0,
    "changes": 5,
    "blob_url": "https://github.com/potapovleonid/Preparation/blob/77a7904336772f0d14257f71bb22dbc8728e6651/lessson07/src/main/java/ru/home/des/entity/UserRole.java",
    "raw_url": "https://github.com/potapovleonid/Preparation/raw/77a7904336772f0d14257f71bb22dbc8728e6651/lessson07/src/main/java/ru/home/des/entity/UserRole.java",
    "contents_url": "https://api.github.com/repos/potapovleonid/Preparation/contents/lessson07/src/main/java/ru/home/des/entity/UserRole.java?ref=77a7904336772f0d14257f71bb22dbc8728e6651",
    "patch": "@@ -0,0 +1,5 @@\n+package ru.home.des.entity;\n+\n+public enum UserRole {\n+    ROLE_ADMIN, ROLE_STUDENT, ROLE_TEACHER, ROLE_MANAGER\n+}"
  },
  {
    "sha": "b8d522bf49564f53b0264358b824dba42e1744b0",
    "filename": "lessson07/src/main/java/ru/home/des/repositories/UserRepository.java",
    "status": "added",
    "additions": 9,
    "deletions": 0,
    "changes": 9,
    "blob_url": "https://github.com/potapovleonid/Preparation/blob/77a7904336772f0d14257f71bb22dbc8728e6651/lessson07/src/main/java/ru/home/des/repositories/UserRepository.java",
    "raw_url": "https://github.com/potapovleonid/Preparation/raw/77a7904336772f0d14257f71bb22dbc8728e6651/lessson07/src/main/java/ru/home/des/repositories/UserRepository.java",
    "contents_url": "https://api.github.com/repos/potapovleonid/Preparation/contents/lessson07/src/main/java/ru/home/des/repositories/UserRepository.java?ref=77a7904336772f0d14257f71bb22dbc8728e6651",
    "patch": "@@ -0,0 +1,9 @@\n+package ru.home.des.repositories;\n+\n+import org.springframework.data.jpa.repository.JpaRepository;\n+import ru.home.des.entity.User;\n+\n+public interface UserRepository extends JpaRepository<User, Long> {\n+    User findFirstByLogin(String login);\n+    void deleteUserById(Long id);\n+}"
  },
  {
    "sha": "b8dfab97f6716c69a9c5bad2573ef8ba4692c841",
    "filename": "lessson07/src/main/java/ru/home/des/services/UserService.java",
    "status": "added",
    "additions": 14,
    "deletions": 0,
    "changes": 14,
    "blob_url": "https://github.com/potapovleonid/Preparation/blob/77a7904336772f0d14257f71bb22dbc8728e6651/lessson07/src/main/java/ru/home/des/services/UserService.java",
    "raw_url": "https://github.com/potapovleonid/Preparation/raw/77a7904336772f0d14257f71bb22dbc8728e6651/lessson07/src/main/java/ru/home/des/services/UserService.java",
    "contents_url": "https://api.github.com/repos/potapovleonid/Preparation/contents/lessson07/src/main/java/ru/home/des/services/UserService.java?ref=77a7904336772f0d14257f71bb22dbc8728e6651",
    "patch": "@@ -0,0 +1,14 @@\n+package ru.home.des.services;\n+\n+import org.springframework.security.core.userdetails.UserDetailsService;\n+import ru.home.des.entity.User;\n+\n+import java.util.List;\n+\n+public interface UserService extends UserDetailsService {\n+    List<User> getAll();\n+    void save(User user);\n+    User findUserById(Long id);\n+    void deleteUserById(Long id);\n+    void deleteUser(User user);\n+}"
  },
  {
    "sha": "7f32461754501827189752c95d207da605032774",
    "filename": "lessson07/src/main/java/ru/home/des/services/UserServiceImpl.java",
    "status": "added",
    "additions": 79,
    "deletions": 0,
    "changes": 79,
    "blob_url": "https://github.com/potapovleonid/Preparation/blob/77a7904336772f0d14257f71bb22dbc8728e6651/lessson07/src/main/java/ru/home/des/services/UserServiceImpl.java",
    "raw_url": "https://github.com/potapovleonid/Preparation/raw/77a7904336772f0d14257f71bb22dbc8728e6651/lessson07/src/main/java/ru/home/des/services/UserServiceImpl.java",
    "contents_url": "https://api.github.com/repos/potapovleonid/Preparation/contents/lessson07/src/main/java/ru/home/des/services/UserServiceImpl.java?ref=77a7904336772f0d14257f71bb22dbc8728e6651",
    "patch": "@@ -0,0 +1,79 @@\n+package ru.home.des.services;\n+\n+import org.springframework.security.core.GrantedAuthority;\n+import org.springframework.security.core.authority.SimpleGrantedAuthority;\n+import org.springframework.security.core.userdetails.UserDetails;\n+import org.springframework.security.core.userdetails.UsernameNotFoundException;\n+import org.springframework.security.crypto.password.PasswordEncoder;\n+import org.springframework.stereotype.Service;\n+import ru.home.des.entity.User;\n+import ru.home.des.entity.UserAuthority;\n+import ru.home.des.entity.UserRole;\n+import ru.home.des.repositories.UserRepository;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+@Service\n+public class UserServiceImpl implements UserService {\n+\n+    private final UserRepository repository;\n+    private final PasswordEncoder encoder;\n+\n+    public UserServiceImpl(UserRepository repository, PasswordEncoder encoder) {\n+        this.repository = repository;\n+        this.encoder = encoder;\n+        initDB();\n+    }\n+\n+    private void initDB(){\n+        repository.saveAll(Arrays.asList(\n+                new User(null, \"admin\", encoder.encode(\"admin\"), UserRole.ROLE_ADMIN, UserAuthority.ADMIN),\n+                new User(null, \"manager\", encoder.encode(\"manager\"), UserRole.ROLE_ADMIN, UserAuthority.MANAGER),\n+                new User(null, \"student\", encoder.encode(\"student\"), UserRole.ROLE_STUDENT, UserAuthority.STUDENT)\n+        ));\n+    }\n+\n+    @Override\n+    public List<User> getAll() {\n+        return repository.findAll();\n+    }\n+\n+    @Override\n+    public void save(User user) {\n+        repository.save(user);\n+    }\n+\n+    @Override\n+    public User findUserById(Long id) {\n+        return repository.findById(id).orElse(null);\n+    }\n+\n+\n+    @Override\n+    public void deleteUserById(Long id) {\n+        repository.deleteUserById(id);\n+    }\n+\n+    @Override\n+    public void deleteUser(User user) {\n+        repository.delete(user);\n+    }\n+\n+    @Override\n+    public UserDetails loadUserByUsername(String s) throws UsernameNotFoundException {\n+        User findUser = repository.findFirstByLogin(s);\n+        if (findUser == null){\n+            throw  new UsernameNotFoundException(\"User not found with name: \" + s);\n+        }\n+\n+        List<GrantedAuthority> roles = new ArrayList<>();\n+        roles.add(new SimpleGrantedAuthority(findUser.getRole().name()));\n+\n+        return new org.springframework.security.core.userdetails.User(\n+                findUser.getLogin(),\n+                findUser.getPassword(),\n+                roles);\n+    }\n+}"
  },
  {
    "sha": "ca069d314fc6848810cb4a38bc34aab9febb06e8",
    "filename": "lessson07/src/main/resources/templates/login.html",
    "status": "added",
    "additions": 25,
    "deletions": 0,
    "changes": 25,
    "blob_url": "https://github.com/potapovleonid/Preparation/blob/77a7904336772f0d14257f71bb22dbc8728e6651/lessson07/src/main/resources/templates/login.html",
    "raw_url": "https://github.com/potapovleonid/Preparation/raw/77a7904336772f0d14257f71bb22dbc8728e6651/lessson07/src/main/resources/templates/login.html",
    "contents_url": "https://api.github.com/repos/potapovleonid/Preparation/contents/lessson07/src/main/resources/templates/login.html?ref=77a7904336772f0d14257f71bb22dbc8728e6651",
    "patch": "@@ -0,0 +1,25 @@\n+<!DOCTYPE html>\n+<html lang=\"en\" xmlns:th=\"http://www.w3.org/1999/xhtml\">\n+<head>\n+    <meta charset=\"UTF-8\">\n+    <title>Login</title>\n+</head>\n+<body>\n+\n+<p th:if=\"${loginError}\" class=\"error\">Wrong user or password</p>\n+<form th:action=\"@{/auth}\" method=\"post\">\n+    <table border=\"1\">\n+        <tr>\n+            <td>Name</td>\n+            <td><input type=\"text\" name=\"username\"/></td>\n+        </tr>\n+        <tr>\n+            <td>Password</td>\n+            <td><input type=\"password\" name=\"password\"/></td>\n+        </tr>\n+    </table>\n+    <button type=\"submit\">Login</button>\n+</form>\n+\n+</body>\n+</html>\n\\ No newline at end of file"
  }
]

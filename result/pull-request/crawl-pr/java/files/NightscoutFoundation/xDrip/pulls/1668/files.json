[
  {
    "sha": "cf64f5940e7acc60e24f0e094eee01d4c6926aaf",
    "filename": "app/src/main/java/com/eveningoutpost/dexdrip/UtilityModels/SpeechUtil.java",
    "status": "modified",
    "additions": 30,
    "deletions": 0,
    "changes": 30,
    "blob_url": "https://github.com/NightscoutFoundation/xDrip/blob/7f033c4c3f6e9acd250222884f521539e5e02e51/app/src/main/java/com/eveningoutpost/dexdrip/UtilityModels/SpeechUtil.java",
    "raw_url": "https://github.com/NightscoutFoundation/xDrip/raw/7f033c4c3f6e9acd250222884f521539e5e02e51/app/src/main/java/com/eveningoutpost/dexdrip/UtilityModels/SpeechUtil.java",
    "contents_url": "https://api.github.com/repos/NightscoutFoundation/xDrip/contents/app/src/main/java/com/eveningoutpost/dexdrip/UtilityModels/SpeechUtil.java?ref=7f033c4c3f6e9acd250222884f521539e5e02e51",
    "patch": "@@ -3,6 +3,8 @@\n import android.content.ActivityNotFoundException;\n import android.content.Context;\n import android.content.Intent;\n+import android.content.res.Configuration;\n+import android.content.res.Resources;\n import android.media.AudioManager;\n import android.os.PowerManager;\n import android.speech.tts.TextToSpeech;\n@@ -32,6 +34,8 @@\n     public static final String TWICE_DELIMITER = \" ... ... ... \"; // creates a pause hopefully works on all locales\n     private static volatile TextToSpeech tts = null; // maintained instance\n \n+    private static Resources speechResources = null; // cached access to strings\n+\n     // delay parameter allows you to force a millis delay before playing to avoid clash with notification sounds triggered at the same time\n     @SuppressWarnings(\"WeakerAccess\")\n     public static void say(final String text) {\n@@ -152,6 +156,25 @@ private static Locale chosenLocale() {\n         return speech_locale;\n     }\n \n+    // load localized resources for desired language\n+    private static Resources getLocalizedResources(Locale desiredLocale) {\n+        Context context = xdrip.getAppContext();\n+        Configuration conf = context.getResources().getConfiguration();\n+        conf = new Configuration(conf);\n+        conf.setLocale(desiredLocale);\n+        Context localizedContext = context.createConfigurationContext(conf);\n+        return localizedContext.getResources();\n+    }\n+\n+    // return correct string resources for speech language\n+    public static Resources getSpeechResources() {\n+        if (speechResources == null) {\n+            return xdrip.getAppContext().getResources();\n+        } else {\n+            return speechResources;\n+        }\n+    }\n+\n     // set up an instance to Android TTS with our desired language and settings\n     private synchronized static void initialize() {\n         if (tts != null) return;\n@@ -164,6 +187,13 @@ private synchronized static void initialize() {\n \n                 UserError.Log.d(TAG, \"Chosen locale: \" + speech_locale);\n \n+                try {\n+                    speechResources = getLocalizedResources(speech_locale);\n+                } catch (Exception e) {\n+                    UserError.Log.e(TAG, \"Can't load localized resources: \" + e.toString());\n+                    speechResources = null;\n+                }\n+\n                 int set_language_result;\n                 // try setting the language we want\n                 try {"
  },
  {
    "sha": "d761da0b3286e2e8bee08a1ec8f3aca5ef1fe96b",
    "filename": "app/src/main/java/com/eveningoutpost/dexdrip/utils/BgToSpeech.java",
    "status": "modified",
    "additions": 15,
    "deletions": 15,
    "changes": 30,
    "blob_url": "https://github.com/NightscoutFoundation/xDrip/blob/7f033c4c3f6e9acd250222884f521539e5e02e51/app/src/main/java/com/eveningoutpost/dexdrip/utils/BgToSpeech.java",
    "raw_url": "https://github.com/NightscoutFoundation/xDrip/raw/7f033c4c3f6e9acd250222884f521539e5e02e51/app/src/main/java/com/eveningoutpost/dexdrip/utils/BgToSpeech.java",
    "contents_url": "https://api.github.com/repos/NightscoutFoundation/xDrip/contents/app/src/main/java/com/eveningoutpost/dexdrip/utils/BgToSpeech.java?ref=7f033c4c3f6e9acd250222884f521539e5e02e51",
    "patch": "@@ -11,7 +11,8 @@\n import com.eveningoutpost.dexdrip.UtilityModels.Pref;\n import com.eveningoutpost.dexdrip.UtilityModels.SpeechUtil;\n import com.eveningoutpost.dexdrip.UtilityModels.VehicleMode;\n-import com.eveningoutpost.dexdrip.xdrip;\n+\n+import android.content.res.Resources;\n \n import java.text.DecimalFormat;\n \n@@ -113,30 +114,28 @@ public static void realSpeakNow(final double value, long timestamp, String delta\n         SpeechUtil.say(text_to_speak);\n     }\n \n-    private static String mungeDeltaName(String delta_name) {\n-\n-\n+    private static String mungeDeltaName(String delta_name, Resources res) {\n         switch (delta_name) {\n             case \"DoubleDown\":\n-                delta_name = xdrip.getAppContext().getString(R.string.DoubleDown);\n+                delta_name = res.getString(R.string.DoubleDown);\n                 break;\n             case \"SingleDown\":\n-                delta_name = xdrip.getAppContext().getString(R.string.SingleDown);\n+                delta_name = res.getString(R.string.SingleDown);\n                 break;\n             case \"FortyFiveDown\":\n-                delta_name = xdrip.getAppContext().getString(R.string.FortyFiveDown);\n+                delta_name = res.getString(R.string.FortyFiveDown);\n                 break;\n             case \"Flat\":\n-                delta_name = xdrip.getAppContext().getString(R.string.Flat);\n+                delta_name = res.getString(R.string.Flat);\n                 break;\n             case \"FortyFiveUp\":\n-                delta_name = xdrip.getAppContext().getString(R.string.FortyFiveUp);\n+                delta_name = res.getString(R.string.FortyFiveUp);\n                 break;\n             case \"SingleUp\":\n-                delta_name = xdrip.getAppContext().getString(R.string.SingleUp);\n+                delta_name = res.getString(R.string.SingleUp);\n                 break;\n             case \"DoubleUp\":\n-                delta_name = xdrip.getAppContext().getString(R.string.DoubleUp);\n+                delta_name = res.getString(R.string.DoubleUp);\n                 break;\n             case \"NOT COMPUTABLE\":\n                 delta_name = \"\";\n@@ -148,6 +147,7 @@ private static String mungeDeltaName(String delta_name) {\n     }\n \n     private static String calculateText(double value, String delta_name) {\n+        Resources res = SpeechUtil.getSpeechResources();\n \n         final boolean doMgdl = (Pref.getString(\"units\", \"mgdl\").equals(\"mgdl\"));\n         final boolean bg_to_speech_repeat_twice = (Pref.getBooleanDefaultFalse(\"bg_to_speech_repeat_twice\"));\n@@ -156,7 +156,7 @@ private static String calculateText(double value, String delta_name) {\n         // TODO does some of this need unifying from best glucose etc?\n         final DecimalFormat df = new DecimalFormat(\"#\");\n         if (value >= 400) {\n-            text = xdrip.getAppContext().getString(R.string.high);\n+            text = res.getString(R.string.high);\n         } else if (value >= 40) {\n             if (doMgdl) {\n                 df.setMaximumFractionDigits(0);\n@@ -175,12 +175,12 @@ private static String calculateText(double value, String delta_name) {\n                     Log.e(TAG, \"Null pointer for TTS in calculateText\");\n                 }\n             }\n-            if (delta_name != null) text += \" \" + mungeDeltaName(delta_name);\n+            if (delta_name != null) text += \" \" + mungeDeltaName(delta_name, res);\n             if (bg_to_speech_repeat_twice) text = text + TWICE_DELIMITER + text;\n         } else if (value > 12) {\n-            text = xdrip.getAppContext().getString(R.string.low);\n+            text = res.getString(R.string.low);\n         } else {\n-            text = xdrip.getAppContext().getString(R.string.error);\n+            text = res.getString(R.string.error);\n         }\n         Log.d(TAG, \"calculated text: \" + text);\n         return text;"
  }
]

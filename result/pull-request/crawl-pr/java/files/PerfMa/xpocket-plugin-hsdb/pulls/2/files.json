[
  {
    "sha": "e8ade2af405240ae00978b9e15a8c1cf6c7dc96d",
    "filename": "src/main/java/com/perfma/xpocket/plugin/hsdb/HSDBCommand.java",
    "status": "modified",
    "additions": 8,
    "deletions": 2,
    "changes": 10,
    "blob_url": "https://github.com/PerfMa/xpocket-plugin-hsdb/blob/a5a1d6875e22335b7595761379335b513d61ebb7/src/main/java/com/perfma/xpocket/plugin/hsdb/HSDBCommand.java",
    "raw_url": "https://github.com/PerfMa/xpocket-plugin-hsdb/raw/a5a1d6875e22335b7595761379335b513d61ebb7/src/main/java/com/perfma/xpocket/plugin/hsdb/HSDBCommand.java",
    "contents_url": "https://api.github.com/repos/PerfMa/xpocket-plugin-hsdb/contents/src/main/java/com/perfma/xpocket/plugin/hsdb/HSDBCommand.java?ref=a5a1d6875e22335b7595761379335b513d61ebb7",
    "patch": "@@ -67,7 +67,7 @@\n     \"mem\",\n     \"sysprops\",\n     \"universe\",\n-    \"whatis\"},\n+    \"whatis\", \"classdetail\", \"instance\", \"method\", \"objectvisit\", \"stack\", \"typedetail\"},\n         usage = {\"clhsdb [path of sa-jdi.jar] start hsdb command line\",\n             \"assert true | false\",\n             \"attach pid | exec core\",\n@@ -126,7 +126,13 @@\n             \"mem address [ length ]\",\n             \"sysprops\",\n             \"universe\",\n-            \"whatis address\"})\n+            \"whatis address\",\n+            \"classdetail  [address | fullClassName]\",\n+            \"instance address\",\n+            \"method address\",\n+            \"objectvisit [-d] fullClassName[.class]\",\n+            \"stack threadName\",\n+            \"typedetail typeName\"})\n public class HSDBCommand extends AbstractXPocketCommand {\n \n     private HSDBPlugin plugin;"
  },
  {
    "sha": "b9ad97d89d58673cb3fee4c9ea59dc78228e0f99",
    "filename": "src/main/java/com/perfma/xpocket/plugin/hsdb/HSDBPlugin.java",
    "status": "modified",
    "additions": 61,
    "deletions": 2,
    "changes": 63,
    "blob_url": "https://github.com/PerfMa/xpocket-plugin-hsdb/blob/a5a1d6875e22335b7595761379335b513d61ebb7/src/main/java/com/perfma/xpocket/plugin/hsdb/HSDBPlugin.java",
    "raw_url": "https://github.com/PerfMa/xpocket-plugin-hsdb/raw/a5a1d6875e22335b7595761379335b513d61ebb7/src/main/java/com/perfma/xpocket/plugin/hsdb/HSDBPlugin.java",
    "contents_url": "https://api.github.com/repos/PerfMa/xpocket-plugin-hsdb/contents/src/main/java/com/perfma/xpocket/plugin/hsdb/HSDBPlugin.java?ref=a5a1d6875e22335b7595761379335b513d61ebb7",
    "patch": "@@ -8,7 +8,10 @@\n import java.io.File;\n import java.io.IOException;\n import java.io.InputStream;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n import java.util.Arrays;\n+import java.util.List;\n import java.util.Set;\n import java.util.TreeSet;\n import java.util.concurrent.LinkedBlockingQueue;\n@@ -52,6 +55,21 @@\n \n     private int pid = -1;\n \n+    private static final String USER_HOME = System.getProperty(\"user.home\");\n+\n+    private static final String path = USER_HOME + File.separator + \".xpocket\"\n+            + File.separator + \".hsdb\" + File.separator;\n+\n+    private static final String ENHANCE_HSDB_JAR = \"clhsdb-enhance-2021-03-jar-with-dependencies.jar\";\n+\n+    private static String enhanceHsdbPath;\n+\n+    private boolean enhanceMode;\n+\n+    private static final List<String> ENHANCE_COMMANDS = Arrays.asList(\n+        \"classdetail\", \"instance\", \"method\", \"objectvisit\", \"stack\", \"typedetail\"\n+    );\n+\n     static {\n \n         int version = 8;\n@@ -89,11 +107,34 @@\n         }\n     }\n \n+\n     @Override\n     public void init(XPocketProcess process) {\n         String[] notNeedAttachCommand = {\"assert\", \"attach\", \"echo\", \"help\",\n             \"history\", \"quit\", \"versioncheck\", \"verbose\"};\n         notNeedAttach.addAll(Arrays.asList(notNeedAttachCommand));\n+\n+        try {\n+            File file = new File(path );\n+            if(!file.exists()) {\n+                file.mkdirs();\n+            }\n+            enhanceHsdbPath = file.getAbsolutePath() + File.separator + ENHANCE_HSDB_JAR;\n+\n+            InputStream is = HSDBPlugin.class.getClassLoader().getResourceAsStream(ENHANCE_HSDB_JAR);\n+            if(is != null) {\n+                File f = new File(path + ENHANCE_HSDB_JAR);\n+                if(f.exists()){\n+                    f.delete();\n+                }\n+                Path targetFile = f.toPath();\n+                Files.copy(is, targetFile);\n+                is.close();\n+            }\n+\n+        } catch (Throwable ex) {\n+            ex.printStackTrace();\n+        }\n     }\n \n     @Override\n@@ -171,6 +212,9 @@ public void run() {\n     }\n \n     public boolean isAvaibleNow(String cmd) {\n+        if(enhanceMode && ENHANCE_COMMANDS.contains(cmd)){\n+            return true;\n+        }\n         if (clhsdbProc == null || !clhsdbProc.isAlive()) {\n             return \"clhsdb\".equals(cmd);\n         } else if (!attachStatus) {\n@@ -199,6 +243,9 @@ public void invoke(XPocketProcess process) {\n                                 i++;\n                                 hsdbjarPath = args[i];\n                                 break;\n+                            case \"-e\":\n+                                enhanceMode = true;\n+                                break;\n                             default:\n                                 if (pos < input.length) {\n                                     input[pos++] = arg;\n@@ -223,10 +270,22 @@ public void invoke(XPocketProcess process) {\n                         if (hsdbjarPath == null) {\n                             hsdbjarPath = JAVA_HOME + \"/lib/sa-jdi.jar\";\n                         }\n+                        if(enhanceMode){\n+                            if (osName.toUpperCase().startsWith(\"WIN\")){\n+                                hsdbjarPath = \"\\\"\" + enhanceHsdbPath + \"\\\"\";\n+                            }else {\n+                                hsdbjarPath = enhanceHsdbPath;\n+                            }\n+                        }\n                         File file = new File(hsdbjarPath);\n                         if (file.exists()) {\n-                            clhsdbProc = Runtime.getRuntime().exec(\n-                                    String.format(START_CMD_TEMP, hsdbjarPath, params));\n+                            if(enhanceMode){\n+                                clhsdbProc = Runtime.getRuntime().exec(\n+                                        String.format(\"java -jar %s %s\", hsdbjarPath, params));\n+                            }else {\n+                                clhsdbProc = Runtime.getRuntime().exec(\n+                                        String.format(START_CMD_TEMP, hsdbjarPath, params));\n+                            }\n                             Thread t = new Thread(this);\n                             t.start();\n                         } else {"
  },
  {
    "sha": "56e1d696ed241be5b44f4dcbb5a95fb8699e63b1",
    "filename": "src/main/resources/clhsdb-enhance-2021-03-jar-with-dependencies.jar",
    "status": "added",
    "additions": 0,
    "deletions": 0,
    "changes": 0,
    "blob_url": "https://github.com/PerfMa/xpocket-plugin-hsdb/blob/a5a1d6875e22335b7595761379335b513d61ebb7/src/main/resources/clhsdb-enhance-2021-03-jar-with-dependencies.jar",
    "raw_url": "https://github.com/PerfMa/xpocket-plugin-hsdb/raw/a5a1d6875e22335b7595761379335b513d61ebb7/src/main/resources/clhsdb-enhance-2021-03-jar-with-dependencies.jar",
    "contents_url": "https://api.github.com/repos/PerfMa/xpocket-plugin-hsdb/contents/src/main/resources/clhsdb-enhance-2021-03-jar-with-dependencies.jar?ref=a5a1d6875e22335b7595761379335b513d61ebb7"
  }
]

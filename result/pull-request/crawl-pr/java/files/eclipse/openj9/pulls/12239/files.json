[
  {
    "sha": "4d3f1f3ff22c0236ceb7e838d58a80bf8a65baea",
    "filename": "runtime/codert_vm/pnathelp.m4",
    "status": "modified",
    "additions": 26,
    "deletions": 9,
    "changes": 35,
    "blob_url": "https://github.com/eclipse/openj9/blob/290ea10845d51fc38bfbd4ca26e75cfe694974d9/runtime/codert_vm/pnathelp.m4",
    "raw_url": "https://github.com/eclipse/openj9/raw/290ea10845d51fc38bfbd4ca26e75cfe694974d9/runtime/codert_vm/pnathelp.m4",
    "contents_url": "https://api.github.com/repos/eclipse/openj9/contents/runtime/codert_vm/pnathelp.m4?ref=290ea10845d51fc38bfbd4ca26e75cfe694974d9",
    "patch": "@@ -20,7 +20,7 @@ dnl SPDX-License-Identifier: EPL-2.0 OR Apache-2.0 OR GPL-2.0 WITH Classpath-exc\n \n include(phelpers.m4)\n \n-\t.file \"pnathelp.s\"\n+\tSTART_FILE(\"pnathelp.s\")\n \n define({CSECT_NAME},{pnathelp})\n \n@@ -294,6 +294,31 @@ START_PROC($1)\n END_PROC($1)\n })\n \n+dnl Helpers that are at a method invocation point.\n+dnl\n+dnl See definition of SAVE_C_VOLATILE_REGS in phelpers.m4\n+dnl for details.\n+\n+undefine({MUST_PRESERVE_FPR})\n+undefine({MUST_PRESERVE_VR})\n+\n+PICBUILDER_DUAL_MODE_HELPER(jitLookupInterfaceMethod,3)\n+PICBUILDER_SLOW_PATH_ONLY_HELPER(jitResolveInterfaceMethod,2)\n+PICBUILDER_SLOW_PATH_ONLY_HELPER(jitResolveSpecialMethod,3)\n+PICBUILDER_SLOW_PATH_ONLY_HELPER(jitResolveStaticMethod,3)\n+PICBUILDER_SLOW_PATH_ONLY_HELPER(jitResolveVirtualMethod,2)\n+SLOW_PATH_ONLY_HELPER(jitInduceOSRAtCurrentPC,0)\n+SLOW_PATH_ONLY_HELPER(jitInduceOSRAtCurrentPCAndRecompile,0)\n+SLOW_PATH_ONLY_HELPER(jitRetranslateMethod,3)\n+\n+dnl Helpers that are not at a method invocation point.\n+dnl\n+dnl See definition of SAVE_C_VOLATILE_REGS in phelpers.m4\n+dnl for details.\n+\n+define({MUST_PRESERVE_FPR})\n+ifdef({ASM_J9VM_ENV_DATA64},{define({MUST_PRESERVE_VR})})\n+\n dnl Runtime helpers\n \n DUAL_MODE_HELPER(jitNewValue,1)\n@@ -356,18 +381,13 @@ dnl Only called from PicBuilder\n PICBUILDER_FAST_PATH_ONLY_HELPER(jitMethodIsNative,1)\n PICBUILDER_FAST_PATH_ONLY_HELPER(jitMethodIsSync,1)\n PICBUILDER_FAST_PATH_ONLY_HELPER(jitResolvedFieldIsVolatile,3)\n-PICBUILDER_DUAL_MODE_HELPER(jitLookupInterfaceMethod,3)\n PICBUILDER_SLOW_PATH_ONLY_HELPER(jitResolveString,3)\n PICBUILDER_SLOW_PATH_ONLY_HELPER(jitResolveClass,3)\n PICBUILDER_SLOW_PATH_ONLY_HELPER(jitResolveClassFromStaticField,3)\n PICBUILDER_SLOW_PATH_ONLY_HELPER(jitResolveField,3)\n PICBUILDER_SLOW_PATH_ONLY_HELPER(jitResolveFieldSetter,3)\n PICBUILDER_SLOW_PATH_ONLY_HELPER(jitResolveStaticField,3)\n PICBUILDER_SLOW_PATH_ONLY_HELPER(jitResolveStaticFieldSetter,3)\n-PICBUILDER_SLOW_PATH_ONLY_HELPER(jitResolveInterfaceMethod,2)\n-PICBUILDER_SLOW_PATH_ONLY_HELPER(jitResolveSpecialMethod,3)\n-PICBUILDER_SLOW_PATH_ONLY_HELPER(jitResolveStaticMethod,3)\n-PICBUILDER_SLOW_PATH_ONLY_HELPER(jitResolveVirtualMethod,2)\n PICBUILDER_SLOW_PATH_ONLY_HELPER(jitResolveMethodType,3)\n PICBUILDER_SLOW_PATH_ONLY_HELPER(jitResolveMethodHandle,3)\n PICBUILDER_SLOW_PATH_ONLY_HELPER(jitResolveInvokeDynamic,3)\n@@ -385,7 +405,6 @@ dnl Recompilation helpers\n \n SLOW_PATH_ONLY_HELPER(jitRetranslateCaller,2)\n SLOW_PATH_ONLY_HELPER(jitRetranslateCallerWithPreparation,3)\n-SLOW_PATH_ONLY_HELPER(jitRetranslateMethod,3)\n \n dnl Exception throw helpers\n \n@@ -419,8 +438,6 @@ FAST_PATH_ONLY_HELPER_NO_RETURN_VALUE(jitWriteBarrierStoreMetronome,3)\n \n dnl Misc\n \n-SLOW_PATH_ONLY_HELPER(jitInduceOSRAtCurrentPC,0)\n-SLOW_PATH_ONLY_HELPER(jitInduceOSRAtCurrentPCAndRecompile,0)\n SLOW_PATH_ONLY_HELPER(jitNewInstanceImplAccessCheck,3)\n SLOW_PATH_ONLY_HELPER_NO_EXCEPTION_NO_RETURN_VALUE(jitCallCFunction,3)\n SLOW_PATH_ONLY_HELPER_NO_EXCEPTION_NO_RETURN_VALUE(jitCallJitAddPicToPatchOnClassUnload,2)"
  },
  {
    "sha": "54d8662f58171aef314e3b4e0437a51be61f7793",
    "filename": "runtime/jilgen/jilconsts.c",
    "status": "modified",
    "additions": 4,
    "deletions": 0,
    "changes": 4,
    "blob_url": "https://github.com/eclipse/openj9/blob/290ea10845d51fc38bfbd4ca26e75cfe694974d9/runtime/jilgen/jilconsts.c",
    "raw_url": "https://github.com/eclipse/openj9/raw/290ea10845d51fc38bfbd4ca26e75cfe694974d9/runtime/jilgen/jilconsts.c",
    "contents_url": "https://api.github.com/repos/eclipse/openj9/contents/runtime/jilgen/jilconsts.c?ref=290ea10845d51fc38bfbd4ca26e75cfe694974d9",
    "patch": "@@ -355,6 +355,10 @@ writeConstants(OMRPortLibrary *OMRPORTLIB, IDATA fd)\n \t\t\twriteConstant(OMRPORTLIB, fd, \"J9TR_cframe_preservedFPRs\", offsetof(J9CInterpreterStackFrame, preservedFPRs)) |\n \t\t\twriteConstant(OMRPORTLIB, fd, \"J9TR_cframe_jitGPRs\", offsetof(J9CInterpreterStackFrame, jitGPRs)) |\n \t\t\twriteConstant(OMRPORTLIB, fd, \"J9TR_cframe_jitFPRs\", offsetof(J9CInterpreterStackFrame, jitFPRs)) |\n+#if defined(J9VM_ENV_DATA64)\n+\t\t\twriteConstant(OMRPORTLIB, fd, \"J9TR_cframe_jitVRs\", offsetof(J9CInterpreterStackFrame, jitVRs)) |\n+\t\t\twriteConstant(OMRPORTLIB, fd, \"J9TR_cframe_preservedVRs\", offsetof(J9CInterpreterStackFrame, preservedVRs)) |\n+#endif /* J9VM_ENV_DATA64 */\n \t\t\twriteConstant(OMRPORTLIB, fd, \"J9TR_cframe_jitCR\", offsetof(J9CInterpreterStackFrame, jitCR)) |\n \t\t\twriteConstant(OMRPORTLIB, fd, \"J9TR_cframe_jitLR\", offsetof(J9CInterpreterStackFrame, jitLR)) |\n #if !defined(LINUX) || defined(J9VM_ENV_DATA64)"
  },
  {
    "sha": "01004d50e9d7a6561c0cefc437cc5779af8b1b51",
    "filename": "runtime/oti/JITInterface.hpp",
    "status": "modified",
    "additions": 2,
    "deletions": 2,
    "changes": 4,
    "blob_url": "https://github.com/eclipse/openj9/blob/290ea10845d51fc38bfbd4ca26e75cfe694974d9/runtime/oti/JITInterface.hpp",
    "raw_url": "https://github.com/eclipse/openj9/raw/290ea10845d51fc38bfbd4ca26e75cfe694974d9/runtime/oti/JITInterface.hpp",
    "contents_url": "https://api.github.com/repos/eclipse/openj9/contents/runtime/oti/JITInterface.hpp?ref=290ea10845d51fc38bfbd4ca26e75cfe694974d9",
    "patch": "@@ -1,5 +1,5 @@\n /*******************************************************************************\n- * Copyright (c) 1991, 2020 IBM Corp. and others\n+ * Copyright (c) 1991, 2021 IBM Corp. and others\n  *\n  * This program and the accompanying materials are made available under\n  * the terms of the Eclipse Public License 2.0 which accompanies this\n@@ -87,9 +87,9 @@ typedef struct {\n \tunion {\n \t\tUDATA numbered[32];\n \t} gpr;\n-\tU_64 fpr[32];\n \tUDATA cr;\n \tUDATA lr;\n+\tU_64 fpr[32];\n } J9JITRegisters;\n \n #elif defined(J9VM_ARCH_S390)"
  },
  {
    "sha": "e468fb273742ca5dfb4899f221e14a650324865a",
    "filename": "runtime/oti/j9nonbuilder.h",
    "status": "modified",
    "additions": 12,
    "deletions": 4,
    "changes": 16,
    "blob_url": "https://github.com/eclipse/openj9/blob/290ea10845d51fc38bfbd4ca26e75cfe694974d9/runtime/oti/j9nonbuilder.h",
    "raw_url": "https://github.com/eclipse/openj9/raw/290ea10845d51fc38bfbd4ca26e75cfe694974d9/runtime/oti/j9nonbuilder.h",
    "contents_url": "https://api.github.com/repos/eclipse/openj9/contents/runtime/oti/j9nonbuilder.h?ref=290ea10845d51fc38bfbd4ca26e75cfe694974d9",
    "patch": "@@ -5614,16 +5614,20 @@ typedef struct J9CInterpreterStackFrame {\n \tUDATA currentTOC; /* callee saves incoming TOC in own frame */\n \tUDATA outgoingArguments[J9_INLINE_JNI_MAX_ARG_COUNT];\n \tUDATA jitGPRs[32]; /* r0-r31 */\n-\tU_8 jitFPRs[32 * 8]; /* fp0-fp31 */\n \tUDATA jitCR;\n \tUDATA jitLR;\n+\tU_8 jitFPRs[32 * 8]; /* fp0-fp31 */\n #if defined(J9VM_ENV_DATA64)\n+\tU_8 jitVRs[52 * 16]; /* vsr0-vsr51 */\n \tUDATA align[3];\n #else /* J9VM_ENV_DATA64 */\n \tUDATA align[1];\n #endif /* J9VM_ENV_DATA64 */\n \tUDATA preservedGPRs[19]; /* r13-r31 */\n \tU_8 preservedFPRs[18 * 8]; /* fp14-31 */\n+#if defined(J9VM_ENV_DATA64)\n+\tU_8 preservedVRs[12 * 16]; /* vsr52-vsr63 */\n+#endif /* J9VM_ENV_DATA64 */\n #elif defined(J9VM_ENV_DATA64) /* AIXPPC */\n #if defined(J9VM_ENV_LITTLE_ENDIAN)\n \t/* Linux PPC 64 LE\n@@ -5636,12 +5640,14 @@ typedef struct J9CInterpreterStackFrame {\n \tUDATA currentTOC; /* callee saves own TOC in own frame */\n \tUDATA outgoingArguments[J9_INLINE_JNI_MAX_ARG_COUNT];\n \tUDATA jitGPRs[32]; /* r0-r31 */\n-\tU_8 jitFPRs[32 * 8]; /* fp0-fp31 */\n \tUDATA jitCR;\n \tUDATA jitLR;\n+\tU_8 jitFPRs[32 * 8]; /* fp0-fp31 */\n+\tU_8 jitVRs[52 * 16]; /* vsr0-vsr51 */\n \tUDATA align[6];\n \tUDATA preservedGPRs[18]; /* r14-r31 */\n \tU_8 preservedFPRs[18 * 8]; /* fp14-31 */\n+\tU_8 preservedVRs[12 * 16]; /* vsr52-vsr63 */\n #else /* J9VM_ENV_LITTLE_ENDIAN */\n \t/* Linux PPC 64 BE\n \t *\n@@ -5655,12 +5661,14 @@ typedef struct J9CInterpreterStackFrame {\n \tUDATA currentTOC; /* callee saves own TOC in own frame */\n \tUDATA outgoingArguments[J9_INLINE_JNI_MAX_ARG_COUNT];\n \tUDATA jitGPRs[32]; /* r0-r31 */\n-\tU_8 jitFPRs[32 * 8]; /* fp0-fp31 */\n \tUDATA jitCR;\n \tUDATA jitLR;\n+\tU_8 jitFPRs[32 * 8]; /* fp0-fp31 */\n+\tU_8 jitVRs[52 * 16]; /* vsr0-vsr51 */\n \tUDATA align[4];\n \tUDATA preservedGPRs[18]; /* r14-r31 */\n \tU_8 preservedFPRs[18 * 8]; /* fp14-31 */\n+\tU_8 preservedVRs[12 * 16]; /* vsr52-vsr63 */\n #endif /* J9VM_ENV_LITTLE_ENDIAN */\n #else /* J9VM_ENV_DATA64 */\n #if defined(J9VM_ENV_LITTLE_ENDIAN)\n@@ -5675,9 +5683,9 @@ typedef struct J9CInterpreterStackFrame {\n \tUDATA preservedLR; /* callee saves in caller frame */\n \tUDATA outgoingArguments[J9_INLINE_JNI_MAX_ARG_COUNT];\n \tUDATA jitGPRs[32]; /* r0-r31 */\n-\tU_8 jitFPRs[32 * 8]; /* fp0-fp31 */\n \tUDATA jitCR;\n \tUDATA jitLR;\n+\tU_8 jitFPRs[32 * 8]; /* fp0-fp31 */\n \tUDATA preservedCR; /* callee saves in own frame */\n \tUDATA preservedGPRs[19]; /* r13-r31 */\n \tU_8 preservedFPRs[18 * 8]; /* fp14-31 */"
  },
  {
    "sha": "e6027f937319ca00b70dbe7189491315b65fdd65",
    "filename": "runtime/oti/phelpers.m4",
    "status": "modified",
    "additions": 281,
    "deletions": 14,
    "changes": 295,
    "blob_url": "https://github.com/eclipse/openj9/blob/290ea10845d51fc38bfbd4ca26e75cfe694974d9/runtime/oti/phelpers.m4",
    "raw_url": "https://github.com/eclipse/openj9/raw/290ea10845d51fc38bfbd4ca26e75cfe694974d9/runtime/oti/phelpers.m4",
    "contents_url": "https://api.github.com/repos/eclipse/openj9/contents/runtime/oti/phelpers.m4?ref=290ea10845d51fc38bfbd4ca26e75cfe694974d9",
    "patch": "@@ -1,4 +1,4 @@\n-dnl Copyright (c) 1991, 2019 IBM Corp. and others\n+dnl Copyright (c) 1991, 2021 IBM Corp. and others\n dnl\n dnl This program and the accompanying materials are made available under\n dnl the terms of the Eclipse Public License 2.0 which accompanies this\n@@ -88,6 +88,10 @@ define({fp31},31)\n \n J9CONST({CINTERP_STACK_SIZE},J9TR_cframe_sizeof)\n \n+define({CONCAT},$1$2)\n+define({SYM_COUNT},0)\n+define({INC_SYM_COUNT},{define({SYM_COUNT},eval(1+SYM_COUNT))})\n+\n ifdef({ASM_J9VM_ENV_DATA64},{\n \n ifelse(eval(CINTERP_STACK_SIZE % 64),0, ,{ERROR stack size CINTERP_STACK_SIZE is not 64-aligned})\n@@ -130,6 +134,10 @@ ifdef({AIXPPC},{\n \n dnl AIX PPC 32 and 64\n \n+define({START_FILE},{\n+\t.file $1\n+})\n+\n define({FUNC_PTR},{r11})\n \n define({CALL_INDIRECT},{\n@@ -144,7 +152,7 @@ dnl inline version of _ptrgl follows\n define({FUNC_LABEL},{.$1})\n \n define({BRANCH_SYMBOL},{FUNC_LABEL($1)[pr]})\n-\n+\t\n define({DECLARE_PUBLIC},{\n \t.globl .$1[pr]\n \t.globl $1[ds]\n@@ -169,6 +177,7 @@ define({START_TEXT},{\n })\n \n define({START_PROC},{\n+\tINC_SYM_COUNT\n \tDECLARE_PUBLIC($1)\n \tSTART_TEXT(CSECT_NAME)\n \t.$1:\n@@ -194,6 +203,13 @@ J9CONST({LR_SAVE_OFFSET},eval(CINTERP_STACK_SIZE+J9TR_cframe_preservedLR))\n \n },{ dnl AIXPPC\n \n+dnl Linux PPC\n+\n+define({START_FILE},{\n+\t.file $1\n+\t.machine power7\n+})\n+\n ifdef({ASM_J9VM_ENV_DATA64},{\n \n ifdef({ASM_J9VM_ENV_LITTLE_ENDIAN},{\n@@ -230,6 +246,7 @@ define({CALL_DIRECT},{\n })\n \n define({START_PROC},{\n+\tINC_SYM_COUNT\n \tDECLARE_PUBLIC($1)\n \tSTART_TEXT(CSECT_NAME)\n \tFUNC_LABEL($1):\n@@ -295,6 +312,7 @@ define({DECLARE_EXTERN},{\n })\n \n define({START_PROC},{\n+\tINC_SYM_COUNT\n \tDECLARE_PUBLIC($1)\n \tSTART_TEXT(CSECT_NAME)\n \tFUNC_LABEL($1):\n@@ -341,6 +359,7 @@ define({START_TEXT})\n define({CALL_DIRECT},{bl BRANCH_SYMBOL($1)})\n \n define({START_PROC},{\n+\tINC_SYM_COUNT\n \tDECLARE_PUBLIC($1)\n \tSTART_TEXT(CSECT_NAME)\n \tFUNC_LABEL($1):\n@@ -445,6 +464,22 @@ define({CALL_C_WITH_VMTHREAD},{\n \tCALL_DIRECT($1)\n })\n \n+dnl Any helper called at a method invocation point does not\n+dnl need to preserve FPR/VR as they are all considered volatile\n+dnl in the JIT private linkage.\n+dnl\n+dnl The exceptions to this are FPRs which represent arguments to\n+dnl the called method. These must be stored into the FPR save slots\n+dnl in the ELS before calling the helper in case decompilation occurs.\n+dnl They must be restored after the helper call as the PicBuilder code\n+dnl does not preserve them. If VRs are in used, just restore the VRs\n+dnl since they will also restore the contents of the FPRs.\n+dnl\n+dnl MUST_PRESERVE_FPR indicates that all FPRs must be preserved. If this is\n+dnl not defined, then the JIT argument FPRs only must be preserved.\n+dnl\n+dnl MUST_PRESERVE_VR indicates that VRs must be preserved.\n+\n define({SAVE_C_VOLATILE_REGS},{\n \tSAVE_CR\n \tSAVE_R2_FOR_ALL\n@@ -466,27 +501,244 @@ define({SAVE_C_VOLATILE_REGS},{\n \tstfd fp5,JIT_FPR_SAVE_SLOT(5)\n \tstfd fp6,JIT_FPR_SAVE_SLOT(6)\n \tstfd fp7,JIT_FPR_SAVE_SLOT(7)\n+ifdef({MUST_PRESERVE_VR},{\n+\tladdr r4,J9TR_VMThread_javaVM(J9VMTHREAD)\n+\tlwz r3,J9TR_JavaVM_runtimeFlags(r4)\n+\tandi. r3,r3,J9TR_J9_EXTENDED_RUNTIME_USE_VECTOR_REGISTERS\n+\tbeq CONCAT(.L_no_VR_save_,SYM_COUNT)\n+\taddi r3,r1,J9TR_cframe_jitVRs\n+\tstxvd2x 0,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 1,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 2,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 3,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 4,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 5,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 6,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 7,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 8,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 9,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 10,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 11,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 12,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 13,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 14,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 15,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 16,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 17,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 18,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 19,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 20,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 21,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 22,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 23,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 24,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 25,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 26,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 27,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 28,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 29,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 30,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 31,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 32,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 33,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 34,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 35,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 36,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 37,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 38,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 39,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 40,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 41,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 42,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 43,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 44,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 45,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 46,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 47,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 48,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 49,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 50,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 51,0,r3\n+ifdef({MUST_PRESERVE_FPR},{\n+\tb CONCAT(.L_no_VR_save_,SYM_COUNT)\n+}) dnl MUST_PRESERVE_FPR\n+CONCAT(.L_no_VR_save_,SYM_COUNT):\t\n+}) dnl MUST_PRESERVE_VR\n+ifdef({MUST_PRESERVE_FPR},{\n \tstfd fp8,JIT_FPR_SAVE_SLOT(8)\n \tstfd fp9,JIT_FPR_SAVE_SLOT(9)\n \tstfd fp10,JIT_FPR_SAVE_SLOT(10)\n \tstfd fp11,JIT_FPR_SAVE_SLOT(11)\n \tstfd fp12,JIT_FPR_SAVE_SLOT(12)\n \tstfd fp13,JIT_FPR_SAVE_SLOT(13)\n+}) dnl MUST_PRESERVE_FPR\n+CONCAT(.L_save_done_,SYM_COUNT):\t\n })\n \n define({RESTORE_C_VOLATILE_REGS},{\n-\tRESTORE_CR\n-\tRESTORE_R2_FOR_ALL\n-\tladdr r3,JIT_GPR_SAVE_SLOT(3)\n-\tladdr r4,JIT_GPR_SAVE_SLOT(4)\n-\tladdr r5,JIT_GPR_SAVE_SLOT(5)\n-\tladdr r6,JIT_GPR_SAVE_SLOT(6)\n-\tladdr r7,JIT_GPR_SAVE_SLOT(7)\n-\tladdr r8,JIT_GPR_SAVE_SLOT(8)\n-\tladdr r9,JIT_GPR_SAVE_SLOT(9)\n-\tladdr r10,JIT_GPR_SAVE_SLOT(10)\n-\tladdr r11,JIT_GPR_SAVE_SLOT(11)\n-\tladdr r12,JIT_GPR_SAVE_SLOT(12)\n+ifdef({MUST_PRESERVE_VR},{\n+\tladdr r4,J9TR_VMThread_javaVM(J9VMTHREAD)\n+\tlwz r3,J9TR_JavaVM_runtimeFlags(r4)\n+\tandi. r3,r3,J9TR_J9_EXTENDED_RUNTIME_USE_VECTOR_REGISTERS\n+\tbeq CONCAT(.L_no_VR_restore_,SYM_COUNT)\n+\taddi r3,r1,J9TR_cframe_jitVRs\n+\tlxvd2x 0,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 1,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 2,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 3,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 4,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 5,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 6,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 7,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 8,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 9,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 10,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 11,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 12,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 13,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 14,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 15,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 16,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 17,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 18,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 19,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 20,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 21,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 22,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 23,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 24,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 25,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 26,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 27,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 28,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 29,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 30,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 31,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 32,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 33,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 34,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 35,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 36,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 37,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 38,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 39,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 40,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 41,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 42,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 43,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 44,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 45,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 46,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 47,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 48,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 49,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 50,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 51,0,r3\n+\tb CONCAT(.L_restore_done_,SYM_COUNT)\n+CONCAT(.L_no_VR_restore_,SYM_COUNT):\t\n+}) dnl MUST_PRESERVE_VR\n \tlfd fp0,JIT_FPR_SAVE_SLOT(0)\n \tlfd fp1,JIT_FPR_SAVE_SLOT(1)\n \tlfd fp2,JIT_FPR_SAVE_SLOT(2)\n@@ -495,12 +747,27 @@ define({RESTORE_C_VOLATILE_REGS},{\n \tlfd fp5,JIT_FPR_SAVE_SLOT(5)\n \tlfd fp6,JIT_FPR_SAVE_SLOT(6)\n \tlfd fp7,JIT_FPR_SAVE_SLOT(7)\n+ifdef({MUST_PRESERVE_FPR},{\n \tlfd fp8,JIT_FPR_SAVE_SLOT(8)\n \tlfd fp9,JIT_FPR_SAVE_SLOT(9)\n \tlfd fp10,JIT_FPR_SAVE_SLOT(10)\n \tlfd fp11,JIT_FPR_SAVE_SLOT(11)\n \tlfd fp12,JIT_FPR_SAVE_SLOT(12)\n \tlfd fp13,JIT_FPR_SAVE_SLOT(13)\n+}) dnl MUST_PRESERVE_FPR\n+CONCAT(.L_restore_done_,SYM_COUNT):\t\n+\tRESTORE_CR\n+\tRESTORE_R2_FOR_ALL\n+\tladdr r3,JIT_GPR_SAVE_SLOT(3)\n+\tladdr r4,JIT_GPR_SAVE_SLOT(4)\n+\tladdr r5,JIT_GPR_SAVE_SLOT(5)\n+\tladdr r6,JIT_GPR_SAVE_SLOT(6)\n+\tladdr r7,JIT_GPR_SAVE_SLOT(7)\n+\tladdr r8,JIT_GPR_SAVE_SLOT(8)\n+\tladdr r9,JIT_GPR_SAVE_SLOT(9)\n+\tladdr r10,JIT_GPR_SAVE_SLOT(10)\n+\tladdr r11,JIT_GPR_SAVE_SLOT(11)\n+\tladdr r12,JIT_GPR_SAVE_SLOT(12)\n })\n \n dnl No need to save/restore fp14-31 - the stack walker will never need to read"
  },
  {
    "sha": "37ec4a7e368f9fac2c3b1359b92111bb6ef66612",
    "filename": "runtime/vm/pcinterp.m4",
    "status": "modified",
    "additions": 64,
    "deletions": 5,
    "changes": 69,
    "blob_url": "https://github.com/eclipse/openj9/blob/290ea10845d51fc38bfbd4ca26e75cfe694974d9/runtime/vm/pcinterp.m4",
    "raw_url": "https://github.com/eclipse/openj9/raw/290ea10845d51fc38bfbd4ca26e75cfe694974d9/runtime/vm/pcinterp.m4",
    "contents_url": "https://api.github.com/repos/eclipse/openj9/contents/runtime/vm/pcinterp.m4?ref=290ea10845d51fc38bfbd4ca26e75cfe694974d9",
    "patch": "@@ -1,4 +1,4 @@\n-dnl Copyright (c) 2017, 2018 IBM Corp. and others\n+dnl Copyright (c) 2017, 2021 IBM Corp. and others\n dnl\n dnl This program and the accompanying materials are made available under\n dnl the terms of the Eclipse Public License 2.0 which accompanies this\n@@ -20,7 +20,7 @@ dnl SPDX-License-Identifier: EPL-2.0 OR Apache-2.0 OR GPL-2.0 WITH Classpath-exc\n \n include(phelpers.m4)\n \n-\t.file \"pcinterp.s\"\n+\tSTART_FILE(\"pcinterp.s\")\n \n define({CSECT_NAME},{c_cInterpreter})\n \n@@ -77,16 +77,44 @@ ifdef({SAVE_R13},{\n \tSAVE_FPR(30)\n \tSAVE_FPR(31)\n  \tmr J9VMTHREAD,r3\n-\tladdr r4,J9TR_VMThread_entryLocalStorage(r3)\n+\tladdr r4,J9TR_VMThread_entryLocalStorage(J9VMTHREAD)\n \taddi r0,r1,JIT_GPR_SAVE_OFFSET(0)\n \tstaddr r0,J9TR_ELS_jitGlobalStorageBase(r4)\n \taddi r0,r1,JIT_FPR_SAVE_OFFSET(0)\n \tstaddr r0,J9TR_ELS_jitFPRegisterStorageBase(r4)\n \tli r3,-1\n ifdef({ASM_J9VM_ENV_DATA64},{\n \tstaddr r3,JIT_GPR_SAVE_SLOT(17)\n-\tladdr r3,J9TR_VMThread_javaVM(J9VMTHREAD)\n-\tladdr r3,J9TR_JavaVMJitConfig(r3)\n+\tladdr r4,J9TR_VMThread_javaVM(J9VMTHREAD)\n+\tlwz r3,J9TR_JavaVM_runtimeFlags(r4)\n+\tandi. r3,r3,J9TR_J9_EXTENDED_RUNTIME_USE_VECTOR_REGISTERS\n+\tbeq .L_no_VR_save\n+\taddi r3,r1,J9TR_cframe_preservedVRs\n+\tstxvd2x 52,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 53,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 54,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 55,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 56,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 57,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 58,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 59,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 60,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 61,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 62,0,r3\n+\taddi r3,r3,16\n+\tstxvd2x 63,0,r3\n+.L_no_VR_save:\n+\tladdr r3,J9TR_JavaVMJitConfig(r4)\n \tcmpliaddr r3,0\n \tbeq .L_noJIT\n \tladdr r3,J9TR_JitConfig_pseudoTOC(r3)\n@@ -114,6 +142,37 @@ ifdef({ASM_J9VM_ENV_DATA64},{\n ifdef({SAVE_R13},{\n \tRESTORE_GPR(13)\n })\n+ifdef({ASM_J9VM_ENV_DATA64},{\n+\tladdr r4,J9TR_VMThread_javaVM(J9VMTHREAD)\n+\tlwz r3,J9TR_JavaVM_runtimeFlags(r4)\n+\tandi. r3,r3,J9TR_J9_EXTENDED_RUNTIME_USE_VECTOR_REGISTERS\n+\tbeq .L_no_VR_restore\n+\taddi r3,r1,J9TR_cframe_preservedVRs\n+\tlxvd2x 52,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 53,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 54,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 55,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 56,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 57,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 58,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 59,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 60,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 61,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 62,0,r3\n+\taddi r3,r3,16\n+\tlxvd2x 63,0,r3\n+.L_no_VR_restore:\n+}) dnl ASM_J9VM_ENV_DATA64\n \tRESTORE_GPR(14)\n \tRESTORE_GPR(15)\n \tRESTORE_GPR(16)"
  }
]

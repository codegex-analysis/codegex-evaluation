[
  {
    "sha": "81ae0524f0a05f9752e1b1572cfe5f689ae9ae02",
    "filename": "leshan-bsserver-demo/src/main/resources/webapp/tag/bootstrap-modal.tag",
    "status": "modified",
    "additions": 2,
    "deletions": 0,
    "changes": 2,
    "blob_url": "https://github.com/eclipse/leshan/blob/1dce242d3e51fd52d4855c95155b3cd8369a7821/leshan-bsserver-demo/src/main/resources/webapp/tag/bootstrap-modal.tag",
    "raw_url": "https://github.com/eclipse/leshan/raw/1dce242d3e51fd52d4855c95155b3cd8369a7821/leshan-bsserver-demo/src/main/resources/webapp/tag/bootstrap-modal.tag",
    "contents_url": "https://api.github.com/repos/eclipse/leshan/contents/leshan-bsserver-demo/src/main/resources/webapp/tag/bootstrap-modal.tag?ref=1dce242d3e51fd52d4855c95155b3cd8369a7821",
    "patch": "@@ -104,6 +104,7 @@\n                     shortId : 123,\n                     security : {\n                         bootstrapServer : false,\n+                        certificateUsage: lwserver.certificateUsage,\n                         clientOldOffTime : 1,\n                         publicKeyOrId : lwserver.id,\n                         secretKey : lwserver.key,\n@@ -120,6 +121,7 @@\n                  bs:[{\n                     security : {\n                         bootstrapServer : true,\n+                        certificateUsage: bsserver.certificateUsage,\n                         clientOldOffTime : 1,\n                         publicKeyOrId : bsserver.id,\n                         secretKey : bsserver.key,"
  },
  {
    "sha": "6ddccbf1092173cf3e00c6415205d43598371a97",
    "filename": "leshan-bsserver-demo/src/main/resources/webapp/tag/bootstrap.tag",
    "status": "modified",
    "additions": 6,
    "deletions": 0,
    "changes": 6,
    "blob_url": "https://github.com/eclipse/leshan/blob/1dce242d3e51fd52d4855c95155b3cd8369a7821/leshan-bsserver-demo/src/main/resources/webapp/tag/bootstrap.tag",
    "raw_url": "https://github.com/eclipse/leshan/raw/1dce242d3e51fd52d4855c95155b3cd8369a7821/leshan-bsserver-demo/src/main/resources/webapp/tag/bootstrap.tag",
    "contents_url": "https://api.github.com/repos/eclipse/leshan/contents/leshan-bsserver-demo/src/main/resources/webapp/tag/bootstrap.tag?ref=1dce242d3e51fd52d4855c95155b3cd8369a7821",
    "patch": "@@ -58,6 +58,9 @@\n                         <p>\n                             <strong>{ security.uri }</strong><br/>\n                             security mode : {security.securityMode}<br/>\n+                            <span if={security.certificateUsage}>\n+                            certificate usage : {security.certificateUsage}<br/>\n+                            </span>\n                             <span if={security.securityMode === 'PSK'}>\n                                 Identity : <code code style=display:block;white-space:pre-wrap>{wrap(toAscii(security.publicKeyOrId))}</code>\n                                 Key : <code code style=display:block;white-space:pre-wrap>{wrap(toHex(security.secretKey))}</code>\n@@ -70,6 +73,9 @@\n                         <p>\n                             <strong>{security.uri}</strong><br/>\n                             security mode : {security.securityMode}<br/>\n+                            <span if={security.certificateUsage}>\n+                            certificate usage : {security.certificateUsage}<br/>\n+                            </span>\n                             <span if={security.securityMode === 'PSK'}>\n                                 Identity : <code code style=display:block;white-space:pre-wrap>{wrap(toAscii(security.publicKeyOrId))}</code>\n                                 key : <code code style=display:block;white-space:pre-wrap>{wrap(toHex(security.secretKey))}</code>"
  },
  {
    "sha": "93cc839846c4546544784d5e00d8df4786ef9a54",
    "filename": "leshan-bsserver-demo/src/main/resources/webapp/tag/securityconfig-input.tag",
    "status": "modified",
    "additions": 16,
    "deletions": 0,
    "changes": 16,
    "blob_url": "https://github.com/eclipse/leshan/blob/1dce242d3e51fd52d4855c95155b3cd8369a7821/leshan-bsserver-demo/src/main/resources/webapp/tag/securityconfig-input.tag",
    "raw_url": "https://github.com/eclipse/leshan/raw/1dce242d3e51fd52d4855c95155b3cd8369a7821/leshan-bsserver-demo/src/main/resources/webapp/tag/securityconfig-input.tag",
    "contents_url": "https://api.github.com/repos/eclipse/leshan/contents/leshan-bsserver-demo/src/main/resources/webapp/tag/securityconfig-input.tag?ref=1dce242d3e51fd52d4855c95155b3cd8369a7821",
    "patch": "@@ -35,11 +35,24 @@\n         <x509-input ref=\"x509\" onchange={onchange} disable={disable} servercertificate={servercertificate}></x509-input>\n     </div>\n \n+    <div class=\"form-group\">\n+        <label for=\"certificateUsage\" class=\"col-sm-4 control-label\">Certificate usage</label>\n+        <div class=\"col-sm-8\">\n+            <select class=\"form-control\" id=\"certificateUsage\" ref=\"certificateUsage\">\n+                <option value=\"CA_CONSTRAINT\"                      >CA constraint</option>\n+                <option value=\"SERVICE_CERTIFICATE_CONSTRAINT\"     >service certificate constraint</option>\n+                <option value=\"TRUST_ANCHOR_ASSERTION\"             >trust anchor assertion</option>\n+                <option value=\"DOMAIN_ISSUER_CERTIFICATE\" selected >domain-issued certificate</option>\n+            </select>\n+        </div>\n+    </div>\n+\n     <script>\n         // Tag definition\n         var tag = this;\n         // Tag Params\n         tag.secmode = opts.secmode || {no_sec:true};\n+        tag.certificateUsage = opts.certificateUsage || \"\";\n         tag.disable = opts.disable || {};\n         tag.serverpubkey = opts.serverpubkey || \"\";\n         tag.servercertificate = opts.servercertificate || \"\";\n@@ -99,6 +112,9 @@\n                 config.serverKey = fromHex(x509.servCert);\n             }\n \n+            // set Certificate Usage\n+            config.certificateUsage = tag.refs.certificateUsage.value;\n+\n             return config;\n         }\n "
  },
  {
    "sha": "4dd692aa7342a2fb80c5d422504ac8e2ad71f92f",
    "filename": "leshan-client-demo/src/main/java/org/eclipse/leshan/client/demo/LeshanClientDemo.java",
    "status": "modified",
    "additions": 15,
    "deletions": 6,
    "changes": 21,
    "blob_url": "https://github.com/eclipse/leshan/blob/1dce242d3e51fd52d4855c95155b3cd8369a7821/leshan-client-demo/src/main/java/org/eclipse/leshan/client/demo/LeshanClientDemo.java",
    "raw_url": "https://github.com/eclipse/leshan/raw/1dce242d3e51fd52d4855c95155b3cd8369a7821/leshan-client-demo/src/main/java/org/eclipse/leshan/client/demo/LeshanClientDemo.java",
    "contents_url": "https://api.github.com/repos/eclipse/leshan/contents/leshan-client-demo/src/main/java/org/eclipse/leshan/client/demo/LeshanClientDemo.java?ref=1dce242d3e51fd52d4855c95155b3cd8369a7821",
    "patch": "@@ -62,6 +62,7 @@\n import org.eclipse.leshan.client.resource.LwM2mObjectEnabler;\n import org.eclipse.leshan.client.resource.ObjectsInitializer;\n import org.eclipse.leshan.client.resource.listener.ObjectsListenerAdapter;\n+import org.eclipse.leshan.core.CertificateUsage;\n import org.eclipse.leshan.core.LwM2m;\n import org.eclipse.leshan.core.californium.DefaultEndpointFactory;\n import org.eclipse.leshan.core.model.LwM2mModel;\n@@ -226,6 +227,9 @@ public static void main(final String[] args) {\n                 \"The path to a root certificate file to trust or a folder containing all the trusted certificates in X509v3 format (DER encoding) or trust store URI.\"\n                         + trustStoreChapter);\n \n+        options.addOption(\"cu\", \"certificate-usage\", true,\n+                \"Certificate Usage (as integer) for security object.\\n Default: domain issued certificate (3).\");\n+\n         HelpFormatter formatter = new HelpFormatter();\n         formatter.setWidth(90);\n         formatter.setOptionComparator(null);\n@@ -504,6 +508,11 @@ public static void main(final String[] args) {\n             }\n         }\n \n+        CertificateUsage certificateUsage = CertificateUsage.DOMAIN_ISSUER_CERTIFICATE;\n+        if (cl.hasOption(\"cu\")) {\n+            certificateUsage = CertificateUsage.fromCode(Integer.parseInt(cl.getOptionValue(\"cu\")));\n+        }\n+\n         // get local address\n         String localAddress = null;\n         int localPort = 0;\n@@ -552,8 +561,8 @@ public static void main(final String[] args) {\n             createAndStartClient(endpoint, localAddress, localPort, cl.hasOption(\"b\"), additionalAttributes,\n                     bsAdditionalAttributes, lifetime, communicationPeriod, serverURI, pskIdentity, pskKey,\n                     clientPrivateKey, clientPublicKey, serverPublicKey, clientCertificate, serverCertificate,\n-                    trustStore, latitude, longitude, scaleFactor, cl.hasOption(\"ocf\"), cl.hasOption(\"oc\"),\n-                    cl.hasOption(\"r\"), cl.hasOption(\"f\"), modelsFolderPath, ciphers);\n+                    trustStore, certificateUsage, latitude, longitude, scaleFactor, cl.hasOption(\"ocf\"),\n+                    cl.hasOption(\"oc\"), cl.hasOption(\"r\"), cl.hasOption(\"f\"), modelsFolderPath, ciphers);\n         } catch (Exception e) {\n             System.err.println(\"Unable to create and start client ...\");\n             e.printStackTrace();\n@@ -566,9 +575,9 @@ public static void createAndStartClient(String endpoint, String localAddress, in\n             Integer communicationPeriod, String serverURI, byte[] pskIdentity, byte[] pskKey,\n             PrivateKey clientPrivateKey, PublicKey clientPublicKey, PublicKey serverPublicKey,\n             X509Certificate clientCertificate, X509Certificate serverCertificate, List<Certificate> trustStore,\n-            Float latitude, Float longitude, float scaleFactor, boolean supportOldFormat,\n-            boolean supportDeprecatedCiphers, boolean reconnectOnUpdate, boolean forceFullhandshake,\n-            String modelsFolderPath, List<CipherSuite> ciphers) throws Exception {\n+            CertificateUsage certificateUsage, Float latitude, Float longitude, float scaleFactor,\n+            boolean supportOldFormat, boolean supportDeprecatedCiphers, boolean reconnectOnUpdate,\n+            boolean forceFullhandshake, String modelsFolderPath, List<CipherSuite> ciphers) throws Exception {\n \n         locationInstance = new MyLocation(latitude, longitude, scaleFactor);\n \n@@ -608,7 +617,7 @@ public static void createAndStartClient(String endpoint, String localAddress, in\n                 initializer.setInstancesForObject(SERVER, new Server(123, lifetime));\n             } else if (clientCertificate != null) {\n                 initializer.setInstancesForObject(SECURITY, x509(serverURI, 123, clientCertificate.getEncoded(),\n-                        clientPrivateKey.getEncoded(), serverCertificate.getEncoded()));\n+                        clientPrivateKey.getEncoded(), serverCertificate.getEncoded(), certificateUsage.code));\n                 initializer.setInstancesForObject(SERVER, new Server(123, lifetime));\n             } else {\n                 initializer.setInstancesForObject(SECURITY, noSec(serverURI, 123));"
  },
  {
    "sha": "5b4b09fba286764bf1f0007c3c5f7ce9023bbe3d",
    "filename": "leshan-server-core/src/main/java/org/eclipse/leshan/server/bootstrap/BootstrapConfig.java",
    "status": "modified",
    "additions": 16,
    "deletions": 2,
    "changes": 18,
    "blob_url": "https://github.com/eclipse/leshan/blob/1dce242d3e51fd52d4855c95155b3cd8369a7821/leshan-server-core/src/main/java/org/eclipse/leshan/server/bootstrap/BootstrapConfig.java",
    "raw_url": "https://github.com/eclipse/leshan/raw/1dce242d3e51fd52d4855c95155b3cd8369a7821/leshan-server-core/src/main/java/org/eclipse/leshan/server/bootstrap/BootstrapConfig.java",
    "contents_url": "https://api.github.com/repos/eclipse/leshan/contents/leshan-server-core/src/main/java/org/eclipse/leshan/server/bootstrap/BootstrapConfig.java?ref=1dce242d3e51fd52d4855c95155b3cd8369a7821",
    "patch": "@@ -23,8 +23,10 @@\n import java.util.List;\n import java.util.Map;\n \n+import org.eclipse.leshan.core.CertificateUsage;\n import org.eclipse.leshan.core.SecurityMode;\n import org.eclipse.leshan.core.request.BindingMode;\n+import org.eclipse.leshan.core.util.datatype.ULong;\n \n /**\n  * A client configuration to apply to a device during a bootstrap session.\n@@ -223,14 +225,26 @@ public String toString() {\n          */\n         public Integer bootstrapServerAccountTimeout = 0;\n \n+        /**\n+         * The Certificate Usage Resource specifies the semantic of the certificate or raw public key stored in the\n+         * Server Public Key Resource, which is used to match the certificate presented in the TLS/DTLS handshake.\n+         * <ul>\n+         * <li>0: CA constraint\n+         * <li>1: service certificate constraint\n+         * <li>2: trust anchor assertion\n+         * <li>3: domain-issued certificate (default if missing)\n+         * </ul>\n+         */\n+        public CertificateUsage certificateUsage;\n+\n         @Override\n         public String toString() {\n             // Note : secretKey and smsBindingKeySecret are explicitly excluded from the display for security purposes\n             return String.format(\n-                    \"ServerSecurity [uri=%s, bootstrapServer=%s, securityMode=%s, publicKeyOrId=%s, serverPublicKey=%s, smsSecurityMode=%s, smsBindingKeySecret=%s, serverSmsNumber=%s, serverId=%s, clientOldOffTime=%s, bootstrapServerAccountTimeout=%s]\",\n+                    \"ServerSecurity [uri=%s, bootstrapServer=%s, securityMode=%s, publicKeyOrId=%s, serverPublicKey=%s, smsSecurityMode=%s, smsBindingKeySecret=%s, serverSmsNumber=%s, serverId=%s, clientOldOffTime=%s, bootstrapServerAccountTimeout=%s, certificateUsage=%s]\",\n                     uri, bootstrapServer, securityMode, Arrays.toString(publicKeyOrId),\n                     Arrays.toString(serverPublicKey), smsSecurityMode, Arrays.toString(smsBindingKeyParam),\n-                    serverSmsNumber, serverId, clientOldOffTime, bootstrapServerAccountTimeout);\n+                    serverSmsNumber, serverId, clientOldOffTime, bootstrapServerAccountTimeout, certificateUsage);\n         }\n     }\n "
  },
  {
    "sha": "85649f9b558a7270fdf68763d5af819cc8cae954",
    "filename": "leshan-server-core/src/main/java/org/eclipse/leshan/server/bootstrap/BootstrapUtil.java",
    "status": "modified",
    "additions": 2,
    "deletions": 0,
    "changes": 2,
    "blob_url": "https://github.com/eclipse/leshan/blob/1dce242d3e51fd52d4855c95155b3cd8369a7821/leshan-server-core/src/main/java/org/eclipse/leshan/server/bootstrap/BootstrapUtil.java",
    "raw_url": "https://github.com/eclipse/leshan/raw/1dce242d3e51fd52d4855c95155b3cd8369a7821/leshan-server-core/src/main/java/org/eclipse/leshan/server/bootstrap/BootstrapUtil.java",
    "contents_url": "https://api.github.com/repos/eclipse/leshan/contents/leshan-server-core/src/main/java/org/eclipse/leshan/server/bootstrap/BootstrapUtil.java?ref=1dce242d3e51fd52d4855c95155b3cd8369a7821",
    "patch": "@@ -66,6 +66,8 @@ public static LwM2mObjectInstance toSecurityInstance(int instanceId, ServerSecur\n             resources.add(LwM2mSingleResource.newIntegerResource(11, securityConfig.clientOldOffTime));\n         if (securityConfig.bootstrapServerAccountTimeout != null)\n             resources.add(LwM2mSingleResource.newIntegerResource(12, securityConfig.bootstrapServerAccountTimeout));\n+        if (securityConfig.certificateUsage != null)\n+            resources.add(LwM2mSingleResource.newUnsignedIntegerResource(15, securityConfig.certificateUsage.code));\n \n         return new LwM2mObjectInstance(instanceId, resources);\n     }"
  }
]

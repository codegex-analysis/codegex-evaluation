[
  {
    "sha": "463aec3534dbd4a9c7fed88ec75c95e539824ace",
    "filename": "web/src/main/java/org/openmrs/web/filter/util/CurrentUsers.java",
    "status": "added",
    "additions": 104,
    "deletions": 0,
    "changes": 104,
    "blob_url": "https://github.com/openmrs/openmrs-core/blob/29bf57fdb35376fd783b6e255234d1482c10ab3f/web/src/main/java/org/openmrs/web/filter/util/CurrentUsers.java",
    "raw_url": "https://github.com/openmrs/openmrs-core/raw/29bf57fdb35376fd783b6e255234d1482c10ab3f/web/src/main/java/org/openmrs/web/filter/util/CurrentUsers.java",
    "contents_url": "https://api.github.com/repos/openmrs/openmrs-core/contents/web/src/main/java/org/openmrs/web/filter/util/CurrentUsers.java?ref=29bf57fdb35376fd783b6e255234d1482c10ab3f",
    "patch": "@@ -0,0 +1,104 @@\n+/**\n+ * This Source Code Form is subject to the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+ * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+ * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+ *\n+ * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+ * graphic logo is a trademark of OpenMRS Inc.\n+ */\n+\n+package org.openmrs.web.filter.util;\n+\n+import java.util.ArrayList;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.TreeMap;\n+\n+import javax.servlet.ServletContext;\n+import javax.servlet.http.HttpSession;\n+\n+import org.apache.commons.lang.StringUtils;\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.openmrs.User;\n+import org.openmrs.web.WebConstants;\n+\n+public class CurrentUsers {\n+\t\n+\tprivate static final Log log = LogFactory.getLog(CurrentUsers.class);\n+\t\n+\t/**\n+\t * Initialize the current users list.\n+\t * \n+\t * @param servletContext\n+\t */\n+\t\n+\tpublic static Map<String, String> init(ServletContext servletContext) {\n+\t\tMap<String, String> currentUserMap = Collections.synchronizedMap(new TreeMap<String, String>());\n+\t\tservletContext.setAttribute(WebConstants.CURRENT_USERS, currentUserMap);\n+\t\treturn currentUserMap;\n+\t}\n+\t/**\n+\t * Get the current list of map of users stored in the session\n+\t * \n+\t * @param httpSession the current session\n+\t * @return map of users logged in\n+\t */\n+\t @SuppressWarnings(\"unchecked\")\n+\t private static Map<String, String> getCurrentUsers(HttpSession httpSession) {\n+\t\t\tMap<String, String> currentUsers = (Map<String, String>) httpSession.getServletContext().getAttribute(\n+\t\t\t    WebConstants.CURRENT_USERS);\n+\t\t\tif (currentUsers == null) {\n+\t\t\t\tcurrentUsers = init(httpSession.getServletContext());\n+\t\t\t}\n+\t\t\treturn currentUsers;\n+\t\t}\n+\t \n+\t  /**\n+\t\t* Add the user to the current users.\n+\t\t* \n+\t\t* @param httpSession\n+\t    * @param user the user that just logged in\n+\t  */\n+\t  public static void addUser(HttpSession httpSession,User user) {\n+\t\t  Map<String,String> currentUsers = getCurrentUsers(httpSession);\n+\t\t  \n+\t\t  String currentUserName = user.getUsername();\n+\t\t  //if the user name is blank then print their system id\n+\t\t  if(StringUtils.isBlank(currentUserName)) {\n+\t\t\t  currentUserName = \"systemid:\" + user.getSystemId();\n+\t\t\t  \n+\t\t  }\n+\t\t  \n+\t\t  if(log.isDebugEnabled()) {\n+\t\t\t  \n+\t\t\t  log.debug(\"Adding current user name\" + currentUserName);\n+\t\t\t  \n+\t\t  }\n+\t\t  \n+\t\t  currentUsers.put(httpSession.getId(),currentUserName);\n+\t\t  \n+\t  }\n+\t  \n+\t  /**\n+\t\t* Get sorted user names list.\n+\t\t* \n+\t\t* @param httpSession\n+\t\t* @return sorted user names\n+\t\t*/\n+\t  public static List<String> getCurrentUsernames(HttpSession httpSession) {\n+\t\t\tMap<String, String> currentUsers = getCurrentUsers(httpSession);\n+\t\t\tList<String> userNames = new ArrayList<String>();\n+\t\t\tsynchronized (currentUsers) {\n+\t\t\t\tfor (String value : currentUsers.values()) {\n+\t\t\t\t\tuserNames.add(value);\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\tCollections.sort(userNames);\n+\t\t\treturn userNames;\n+\t\t}\n+\t  \n+}"
  },
  {
    "sha": "f0852e2343690590f319322ff36e4e07ebd06732",
    "filename": "web/src/test/java/org/openmrs/web/filter/update/util/CurrentUsersTest.java",
    "status": "added",
    "additions": 44,
    "deletions": 0,
    "changes": 44,
    "blob_url": "https://github.com/openmrs/openmrs-core/blob/29bf57fdb35376fd783b6e255234d1482c10ab3f/web/src/test/java/org/openmrs/web/filter/update/util/CurrentUsersTest.java",
    "raw_url": "https://github.com/openmrs/openmrs-core/raw/29bf57fdb35376fd783b6e255234d1482c10ab3f/web/src/test/java/org/openmrs/web/filter/update/util/CurrentUsersTest.java",
    "contents_url": "https://api.github.com/repos/openmrs/openmrs-core/contents/web/src/test/java/org/openmrs/web/filter/update/util/CurrentUsersTest.java?ref=29bf57fdb35376fd783b6e255234d1482c10ab3f",
    "patch": "@@ -0,0 +1,44 @@\n+/**\n+ * This Source Code Form is subject to the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+ * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+ * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+ *\n+ * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+ * graphic logo is a trademark of OpenMRS Inc.\n+ */\n+package org.openmrs.web.filter.update.util;\n+\n+import java.util.List;\n+import org.junit.Assert;\n+import org.junit.jupiter.api.Test;\n+import org.openmrs.User;\n+import org.openmrs.api.UserService;\n+import org.openmrs.api.context.Context;\n+import org.openmrs.web.filter.util.CurrentUsers;\n+import org.openmrs.web.test.BaseWebContextSensitiveTest;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.mock.web.MockHttpSession;\n+\n+public class CurrentUsersTest extends BaseWebContextSensitiveTest {\n+\n+\tprivate static final String USER_SET = \"org/openmrs/CurrentUserTest.xml\";\n+\t@Autowired\n+\tUserService userService;\n+\n+\t@Test\n+\t\n+\tpublic void getCurrentUsernames_shoulReturnUserNamesForLoggedInUsers() {\n+\t\texecuteDataSet(USER_SET);\n+\t\tMockHttpSession session = new MockHttpSession();\n+\t\tUser user = userService.getUser(5508);\n+\t\tContext.authenticate(user.getUsername(),\"User12345\");\n+\t\tAssert.assertEquals(Context.getAuthenticatedUser().getUsername(),user.getUsername());\n+\t\tUser loggedInUser = Context.getAuthenticatedUser();\n+\t\tCurrentUsers.addUser(session,loggedInUser);\n+\t\tList<String> currentUserNames = CurrentUsers.getCurrentUsernames(session);\n+\t\tAssert.assertTrue(currentUserNames.contains(\"firstaccount\"));\n+\n+\t}\n+\n+}"
  },
  {
    "sha": "3524c74406ac393c9ed0c96767061b7ca95e7a15",
    "filename": "web/src/test/resources/org/openmrs/CurrentUserTest.xml",
    "status": "added",
    "additions": 16,
    "deletions": 0,
    "changes": 16,
    "blob_url": "https://github.com/openmrs/openmrs-core/blob/29bf57fdb35376fd783b6e255234d1482c10ab3f/web/src/test/resources/org/openmrs/CurrentUserTest.xml",
    "raw_url": "https://github.com/openmrs/openmrs-core/raw/29bf57fdb35376fd783b6e255234d1482c10ab3f/web/src/test/resources/org/openmrs/CurrentUserTest.xml",
    "contents_url": "https://api.github.com/repos/openmrs/openmrs-core/contents/web/src/test/resources/org/openmrs/CurrentUserTest.xml?ref=29bf57fdb35376fd783b6e255234d1482c10ab3f",
    "patch": "@@ -0,0 +1,16 @@\n+<?xml version='1.0' encoding='UTF-8'?>\n+<!--\n+\n+    This Source Code Form is subject to the terms of the Mozilla Public License,\n+    v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+    obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+    the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+\n+    Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+    graphic logo is a trademark of OpenMRS Inc.\n+\n+-->\n+<dataset>\n+  <person person_id=\"5508\" gender=\"F\" dead=\"false\" creator=\"1\" date_created=\"2008-08-15 15:46:47.0\" voided=\"false\" uuid=\"edc3d446-e53b-11de-8404-001e378eb67e\"/>\n+  <users user_id=\"5508\" person_id=\"5508\" system_id=\"508-x\" username=\"firstaccount\" password=\"74e3ed4f9e5b955de443feabc9f12ecd291ac6a7eaa2f09a72a5c811ec618b044d7131f687c0a0465fc0c660d09fd245e410e12ffe77d78b2a0c504b40afa202\" salt=\"1c30292f0b438b49b181950f3e831c6a9f38ef1c7d559fca566e8cd6b4efb417150585d4c3345f0fb0b520fc0884ad82ea7c1a28f48c2c562106a3d110716cfc\" secret_question=\"a secret\" secret_answer=\"an answer\" creator=\"1\" date_created=\"2008-08-15 15:57:09.0\" changed_by=\"1\" date_changed=\"2008-08-18 11:51:56.0\" retired=\"false\" retire_reason=\"\" uuid=\"2eadf946-e53c-11de-8404-001e378eb67e\"/> \n+</dataset>"
  }
]

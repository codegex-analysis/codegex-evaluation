[
  {
    "sha": "d5232a31844bc1e70fa023376956fc470c0f8800",
    "filename": "api/src/main/java/org/openmrs/module/coreapps/parser/ParseEncounterToJson.java",
    "status": "modified",
    "additions": 10,
    "deletions": 3,
    "changes": 13,
    "blob_url": "https://github.com/openmrs/openmrs-module-coreapps/blob/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/api/src/main/java/org/openmrs/module/coreapps/parser/ParseEncounterToJson.java",
    "raw_url": "https://github.com/openmrs/openmrs-module-coreapps/raw/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/api/src/main/java/org/openmrs/module/coreapps/parser/ParseEncounterToJson.java",
    "contents_url": "https://api.github.com/repos/openmrs/openmrs-module-coreapps/contents/api/src/main/java/org/openmrs/module/coreapps/parser/ParseEncounterToJson.java?ref=acbad4bdfcd76a354fc4c6adce6548a1d033e5b0",
    "patch": "@@ -20,6 +20,7 @@\n import org.openmrs.module.emrapi.encounter.EncounterDomainWrapper;\n import org.openmrs.ui.framework.SimpleObject;\n import org.openmrs.ui.framework.UiUtils;\n+import org.openmrs.util.TimeZoneUtil;\n \n public class ParseEncounterToJson {\n \n@@ -50,9 +51,15 @@ public SimpleObject createEncounterJSON(User authenticatedUser, Encounter encoun\n         // UUID is not provided by EncounterDomainWrapper, adding it here.\n         simpleEncounter.put(\"uuid\", encounter.getUuid());\n         // manually set the date and time components so we can control how we format them\n-        simpleEncounter.put(\"encounterDate\", uiUtils.format(encounter.getEncounterDatetime()));\n-        simpleEncounter.put(\"encounterTime\",\n-                DateFormatUtils.format(encounter.getEncounterDatetime(), \"hh:mm a\", Context.getLocale()));\n+\n+        if(uiUtils.handleTimeZones()){\n+            simpleEncounter.put(\"encounterDate\", TimeZoneUtil.toRFC3339(encounter.getEncounterDatetime()));\n+            simpleEncounter.put(\"encounterTime\", \"\");\n+        }else{\n+            simpleEncounter.put(\"encounterDate\", uiUtils.format(encounter.getEncounterDatetime()));\n+            simpleEncounter.put(\"encounterTime\",\n+                    DateFormatUtils.format(encounter.getEncounterDatetime(), \"hh:mm a\", Context.getLocale()));\n+        }\n \n         // do the same for other date fields\n         simpleEncounter.put(\"dateCreated\", uiUtils.format(encounter.getDateCreated()));"
  },
  {
    "sha": "a574e4bda2051db57af05807cdbe573e3b6252ba",
    "filename": "api/src/main/java/org/openmrs/util/TimeZoneUtil.java",
    "status": "added",
    "additions": 58,
    "deletions": 0,
    "changes": 58,
    "blob_url": "https://github.com/openmrs/openmrs-module-coreapps/blob/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/api/src/main/java/org/openmrs/util/TimeZoneUtil.java",
    "raw_url": "https://github.com/openmrs/openmrs-module-coreapps/raw/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/api/src/main/java/org/openmrs/util/TimeZoneUtil.java",
    "contents_url": "https://api.github.com/repos/openmrs/openmrs-module-coreapps/contents/api/src/main/java/org/openmrs/util/TimeZoneUtil.java?ref=acbad4bdfcd76a354fc4c6adce6548a1d033e5b0",
    "patch": "@@ -0,0 +1,58 @@\n+/**\n+ * This Source Code Form is subject to the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+ * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+ * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+ *\n+ * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+ * graphic logo is a trademark of OpenMRS Inc.\n+ */\n+package org.openmrs.util;\n+\n+import org.joda.time.DateTime;\n+import org.joda.time.format.ISODateTimeFormat;\n+\n+import java.util.Calendar;\n+import java.util.Date;\n+\n+import static org.joda.time.DateTimeZone.UTC;\n+\n+/**\n+ * Helps provide tools to support recommended OpenMRS time zones conventions.\n+ * \n+ * @see https://wiki.openmrs.org/display/docs/Time+Zones+Conventions\n+ */\n+public class TimeZoneUtil {\n+\t\n+\t/**\n+\t * Formats a date as its RFC 3339 string representation.\n+\t * \n+\t * @param date The date.\n+\t * @return The date formated as RFC 3339.\n+\t */\n+\tpublic static String toRFC3339(Date date) {\n+\t\treturn ISODateTimeFormat.dateTime().print(new DateTime(date.getTime(), UTC));\n+\t}\n+\t\n+\t/**\n+\t * Gets the Calendar instance for the date set in UTC. This always returns a GregorianCalendar\n+\t * subclass.\n+\t * \n+\t * @param date The date.\n+\t * @return The GregorianCalendar set in UTC for the date.\n+\t */\n+\tpublic static Calendar toUTCCalendar(Date date) {\n+\t\treturn new DateTime(date.getTime(), UTC).toGregorianCalendar();\n+\t}\n+\n+\t/**\n+\t * Gets a String date in ISO8601 format. This always returns a Date converted from UTC to the server timezone\n+\t * subclass.\n+\t *\n+\t * @param ISOStringDate A String in a ISO 8601 Format.\n+\t * @return Date with the server timezone.\n+\t */\n+\tpublic static Date toDate(String ISOStringDate) {\n+\t\treturn javax.xml.bind.DatatypeConverter.parseDateTime(ISOStringDate).getTime();\n+\t}\n+}"
  },
  {
    "sha": "c8594530d5acf59893f3655cd82914bc157c701a",
    "filename": "omod/src/main/java/org/openmrs/module/coreapps/fragment/controller/dashboardwidgets/DashboardWidgetFragmentController.java",
    "status": "modified",
    "additions": 3,
    "deletions": 2,
    "changes": 5,
    "blob_url": "https://github.com/openmrs/openmrs-module-coreapps/blob/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/omod/src/main/java/org/openmrs/module/coreapps/fragment/controller/dashboardwidgets/DashboardWidgetFragmentController.java",
    "raw_url": "https://github.com/openmrs/openmrs-module-coreapps/raw/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/omod/src/main/java/org/openmrs/module/coreapps/fragment/controller/dashboardwidgets/DashboardWidgetFragmentController.java",
    "contents_url": "https://api.github.com/repos/openmrs/openmrs-module-coreapps/contents/omod/src/main/java/org/openmrs/module/coreapps/fragment/controller/dashboardwidgets/DashboardWidgetFragmentController.java?ref=acbad4bdfcd76a354fc4c6adce6548a1d033e5b0",
    "patch": "@@ -8,6 +8,7 @@\n import org.openmrs.module.appframework.domain.AppDescriptor;\n import org.openmrs.module.emrapi.patient.PatientDomainWrapper;\n import org.openmrs.ui.framework.UiFrameworkConstants;\n+import org.openmrs.ui.framework.UiUtils;\n import org.openmrs.ui.framework.annotation.FragmentParam;\n import org.openmrs.ui.framework.annotation.InjectBeans;\n import org.openmrs.ui.framework.annotation.SpringBean;\n@@ -18,7 +19,7 @@\n \n public class DashboardWidgetFragmentController {\n \n-    public void controller(FragmentConfiguration config, @FragmentParam(\"app\") AppDescriptor app, @InjectBeans PatientDomainWrapper patientWrapper,\n+    public void controller(FragmentConfiguration config, @FragmentParam(\"app\") AppDescriptor app, @InjectBeans PatientDomainWrapper patientWrapper, UiUtils uiUtils,\n                            @SpringBean(\"adminService\") AdministrationService adminService) throws IOException {\n         ObjectMapper mapper = new ObjectMapper();\n \n@@ -43,7 +44,7 @@ public void controller(FragmentConfiguration config, @FragmentParam(\"app\") AppDe\n             }\n             appConfig.put(\"patientUuid\", patientWrapper.getPatient().getUuid());\n         }\n-\n+        appConfig.put(\"handleTimeZones\",uiUtils.handleTimeZones());\n         if (appConfig.get(\"dateFormat\") == null) {\n             appConfig.put(\"dateFormat\", adminService.getGlobalProperty(UiFrameworkConstants.GP_FORMATTER_DATE_FORMAT, \"yyyy-MM-dd\"));\n         }"
  },
  {
    "sha": "c1cb94212d4af9968a2daa26b5fbb7cefc262993",
    "filename": "omod/src/main/java/org/openmrs/module/coreapps/fragment/controller/patientdashboard/VisitIncludesFragmentController.java",
    "status": "modified",
    "additions": 5,
    "deletions": 0,
    "changes": 5,
    "blob_url": "https://github.com/openmrs/openmrs-module-coreapps/blob/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/omod/src/main/java/org/openmrs/module/coreapps/fragment/controller/patientdashboard/VisitIncludesFragmentController.java",
    "raw_url": "https://github.com/openmrs/openmrs-module-coreapps/raw/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/omod/src/main/java/org/openmrs/module/coreapps/fragment/controller/patientdashboard/VisitIncludesFragmentController.java",
    "contents_url": "https://api.github.com/repos/openmrs/openmrs-module-coreapps/contents/omod/src/main/java/org/openmrs/module/coreapps/fragment/controller/patientdashboard/VisitIncludesFragmentController.java?ref=acbad4bdfcd76a354fc4c6adce6548a1d033e5b0",
    "patch": "@@ -6,12 +6,14 @@\n import org.openmrs.VisitAttributeType;\n import org.openmrs.Patient;\n import org.openmrs.api.VisitService;\n+import org.openmrs.api.context.Context;\n import org.openmrs.module.appui.UiSessionContext;\n import org.openmrs.module.coreapps.utils.VisitTypeHelper;\n import org.openmrs.module.emrapi.adt.AdtService;\n import org.openmrs.api.PatientService;\n import org.openmrs.module.emrapi.patient.PatientDomainWrapper;\n import org.openmrs.module.emrapi.visit.VisitDomainWrapper;\n+import org.openmrs.ui.framework.UiUtils;\n import org.openmrs.ui.framework.annotation.InjectBeans;\n import org.openmrs.ui.framework.annotation.SpringBean;\n import org.openmrs.ui.framework.fragment.FragmentConfiguration;\n@@ -34,6 +36,7 @@ public void controller(FragmentConfiguration config,\n \t\t\t@SpringBean(\"visitTypeHelper\") VisitTypeHelper visitTypeHelper,\n \t\t\tUiSessionContext sessionContext,\n \t\t\tHttpServletRequest request,\n+\t\t    UiUtils uiUtils,\n \t\t\t@SpringBean(\"patientService\")PatientService patientService){\n \n \t\tObject patient = config.get(\"patient\");\n@@ -88,6 +91,8 @@ public void controller(FragmentConfiguration config,\n \t\tmodel.addAttribute(\"activeVisits\", activeVisits);\n \t\tmodel.addAttribute(\"visitTypes\", visitTypes);\n \t\tmodel.addAttribute(\"visitAttributeTypes\", visitAttributeTypes);\n+\t\tmodel.addAttribute(\"dateFormat\" , uiUtils.getJSDateFormat());\n+\t\tmodel.addAttribute(\"locale\",  Context.getLocale().getLanguage());\n \t}\n }\n "
  },
  {
    "sha": "77de9093275e62bdaedad4c6af2a3dfaf961ada4",
    "filename": "omod/src/main/java/org/openmrs/module/coreapps/fragment/controller/patientheader/ActiveVisitStatusFragmentController.java",
    "status": "modified",
    "additions": 7,
    "deletions": 1,
    "changes": 8,
    "blob_url": "https://github.com/openmrs/openmrs-module-coreapps/blob/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/omod/src/main/java/org/openmrs/module/coreapps/fragment/controller/patientheader/ActiveVisitStatusFragmentController.java",
    "raw_url": "https://github.com/openmrs/openmrs-module-coreapps/raw/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/omod/src/main/java/org/openmrs/module/coreapps/fragment/controller/patientheader/ActiveVisitStatusFragmentController.java",
    "contents_url": "https://api.github.com/repos/openmrs/openmrs-module-coreapps/contents/omod/src/main/java/org/openmrs/module/coreapps/fragment/controller/patientheader/ActiveVisitStatusFragmentController.java?ref=acbad4bdfcd76a354fc4c6adce6548a1d033e5b0",
    "patch": "@@ -26,6 +26,7 @@\n import org.openmrs.ui.framework.annotation.SpringBean;\n import org.openmrs.ui.framework.fragment.FragmentConfiguration;\n import org.openmrs.ui.framework.fragment.FragmentModel;\n+import org.openmrs.util.TimeZoneUtil;\n \n public class ActiveVisitStatusFragmentController {\n \n@@ -50,7 +51,12 @@ public void controller(FragmentConfiguration config,\n \t\t}\n \t\tif (activeVisit != null) {\n \t\t\tconfig.addAttribute(\"activeVisit\", activeVisit);\n-\t\t\tconfig.addAttribute(\"activeVisitStartDatetime\", uiUtils.format(activeVisit.getStartDatetime()));\n+\t\t\tif(uiUtils.handleTimeZones()){\n+\t\t\t\tconfig.addAttribute(\"activeVisitStartDatetime\", TimeZoneUtil.toRFC3339(activeVisit.getStartDatetime()));\n+\t\t\t}else{\n+\t\t\t\tconfig.addAttribute(\"activeVisitStartDatetime\", uiUtils.format(activeVisit.getStartDatetime()));\n+\t\t\t}\n+\n \t\t\tconfig.addAttribute(\"showVisitTypeOnPatientHeaderSection\", visitTypeHelper.showVisitTypeOnPatientHeaderSection());\n \n \t\t\tString color = (String) visitTypeHelper.getVisitTypeColorAndShortName(activeVisit.getVisit().getVisitType()).get(\"color\");"
  },
  {
    "sha": "ae2777ecb02deaf63904917b0107abf77b4b357f",
    "filename": "omod/src/main/java/org/openmrs/module/coreapps/fragment/controller/visit/RetrospectiveVisitFragmentController.java",
    "status": "modified",
    "additions": 13,
    "deletions": 12,
    "changes": 25,
    "blob_url": "https://github.com/openmrs/openmrs-module-coreapps/blob/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/omod/src/main/java/org/openmrs/module/coreapps/fragment/controller/visit/RetrospectiveVisitFragmentController.java",
    "raw_url": "https://github.com/openmrs/openmrs-module-coreapps/raw/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/omod/src/main/java/org/openmrs/module/coreapps/fragment/controller/visit/RetrospectiveVisitFragmentController.java",
    "contents_url": "https://api.github.com/repos/openmrs/openmrs-module-coreapps/contents/omod/src/main/java/org/openmrs/module/coreapps/fragment/controller/visit/RetrospectiveVisitFragmentController.java?ref=acbad4bdfcd76a354fc4c6adce6548a1d033e5b0",
    "patch": "@@ -20,6 +20,8 @@\n import java.util.List;\n import javax.servlet.http.HttpServletRequest;\n \n+import static org.openmrs.util.TimeZoneUtil.toRFC3339;\n+\n public class RetrospectiveVisitFragmentController {\n \n     private final Logger log = LoggerFactory.getLogger(getClass());\n@@ -36,16 +38,9 @@ public Object create(@SpringBean(\"adtService\") AdtService adtService,\n             stopDate = startDate;\n         }\n \n-        // set the startDate time component to the start of day\n-        startDate = new DateTime(startDate).withTime(0,0,0,0).toDate();\n+        //If stopDate is today, it cannot be today at 23:59:59, because that would be in the future.\n+        stopDate = stopDate.after(new Date()) ? new Date() : stopDate;\n \n-        // if stopDate is today, set stopDate to current datetime, otherwise set time component to end of date\n-        if (new DateTime().withTime(0,0,0,0).equals(new DateTime(stopDate).withTime(0,0,0,0))) {\n-            stopDate = new Date();\n-        }\n-        else {\n-            stopDate = new DateTime(stopDate).withTime(23, 59, 59, 999).toDate();\n-        }\n \n         try {\n             VisitDomainWrapper createdVisit = adtService.createRetrospectiveVisit(patient, location, startDate, stopDate);\n@@ -64,9 +59,15 @@ public Object create(@SpringBean(\"adtService\") AdtService adtService,\n \n             if (visits != null) {\n                 for (VisitDomainWrapper visit : visits) {\n-                    simpleVisits.add(SimpleObject.create(\"startDate\", ui.format(new DateTime(visit.getVisit().getStartDatetime()).toDateMidnight().toDate()),\n-                            \"stopDate\", ui.format(new DateTime(visit.getVisit().getStopDatetime()).toDateMidnight().toDate()),\n-                            \"id\", visit.getVisit().getId(), \"uuid\", visit.getVisit().getUuid()));\n+                    if(ui.handleTimeZones()){\n+                        simpleVisits.add(SimpleObject.create(\"startDate\", toRFC3339(new DateTime(visit.getVisit().getStartDatetime()).toDate()),\n+                                \"stopDate\", toRFC3339(new DateTime(visit.getVisit().getStopDatetime()).toDate()),\n+                                \"id\", visit.getVisit().getId(), \"uuid\", visit.getVisit().getUuid()));\n+                    }else{\n+                        simpleVisits.add(SimpleObject.create(\"startDate\", ui.format(new DateTime(visit.getVisit().getStartDatetime()).toDateMidnight().toDate()),\n+                                \"stopDate\", ui.format(new DateTime(visit.getVisit().getStopDatetime()).toDateMidnight().toDate()),\n+                                \"id\", visit.getVisit().getId(), \"uuid\", visit.getVisit().getUuid()));\n+                    }\n                 }\n             }\n "
  },
  {
    "sha": "fa631d1756ba11d7fbb14b39a07738c209a91f54",
    "filename": "omod/src/main/java/org/openmrs/module/coreapps/fragment/controller/visit/VisitDetailsFragmentController.java",
    "status": "modified",
    "additions": 15,
    "deletions": 6,
    "changes": 21,
    "blob_url": "https://github.com/openmrs/openmrs-module-coreapps/blob/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/omod/src/main/java/org/openmrs/module/coreapps/fragment/controller/visit/VisitDetailsFragmentController.java",
    "raw_url": "https://github.com/openmrs/openmrs-module-coreapps/raw/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/omod/src/main/java/org/openmrs/module/coreapps/fragment/controller/visit/VisitDetailsFragmentController.java",
    "contents_url": "https://api.github.com/repos/openmrs/openmrs-module-coreapps/contents/omod/src/main/java/org/openmrs/module/coreapps/fragment/controller/visit/VisitDetailsFragmentController.java?ref=acbad4bdfcd76a354fc4c6adce6548a1d033e5b0",
    "patch": "@@ -48,6 +48,7 @@\n import org.openmrs.ui.framework.fragment.action.FailureResult;\n import org.openmrs.ui.framework.fragment.action.FragmentActionResult;\n import org.openmrs.ui.framework.fragment.action.SuccessResult;\n+import org.openmrs.util.TimeZoneUtil;\n import org.springframework.web.bind.annotation.RequestParam;\n \n public class VisitDetailsFragmentController {\n@@ -82,12 +83,20 @@ public SimpleObject getVisitDetails(@SpringBean(\"emrApiProperties\") EmrApiProper\n       Date startDatetime = visit.getStartDatetime();\n       Date stopDatetime = visit.getStopDatetime();\n \n-      simpleObject.put(\"startDatetime\", uiUtils.format(startDatetime));\n-\n-      if (stopDatetime != null) {\n-         simpleObject.put(\"stopDatetime\", uiUtils.format(stopDatetime));\n-      } else {\n-         simpleObject.put(\"stopDatetime\", null);\n+          if(uiUtils.handleTimeZones()){\n+         simpleObject.put(\"startDatetime\", TimeZoneUtil.toRFC3339(startDatetime));\n+         if (stopDatetime != null) {\n+            simpleObject.put(\"stopDatetime\", TimeZoneUtil.toRFC3339(stopDatetime));\n+         } else {\n+            simpleObject.put(\"stopDatetime\", null);\n+         }\n+      }else{\n+         simpleObject.put(\"startDatetime\", uiUtils.format(startDatetime));\n+         if (stopDatetime != null) {\n+            simpleObject.put(\"stopDatetime\", uiUtils.format(stopDatetime));\n+         } else {\n+            simpleObject.put(\"stopDatetime\", null);\n+         }\n       }\n \n       VisitDomainWrapper visitWrapper = new VisitDomainWrapper(visit, emrApiProperties);"
  },
  {
    "sha": "f7319b36011cacfd8782f9bfde8f90f7752b4c87",
    "filename": "omod/src/main/java/org/openmrs/module/coreapps/page/controller/patientdashboard/PatientDashboardPageController.java",
    "status": "modified",
    "additions": 5,
    "deletions": 0,
    "changes": 5,
    "blob_url": "https://github.com/openmrs/openmrs-module-coreapps/blob/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/omod/src/main/java/org/openmrs/module/coreapps/page/controller/patientdashboard/PatientDashboardPageController.java",
    "raw_url": "https://github.com/openmrs/openmrs-module-coreapps/raw/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/omod/src/main/java/org/openmrs/module/coreapps/page/controller/patientdashboard/PatientDashboardPageController.java",
    "contents_url": "https://api.github.com/repos/openmrs/openmrs-module-coreapps/contents/omod/src/main/java/org/openmrs/module/coreapps/page/controller/patientdashboard/PatientDashboardPageController.java?ref=acbad4bdfcd76a354fc4c6adce6548a1d033e5b0",
    "patch": "@@ -37,6 +37,7 @@\n import org.openmrs.ui.framework.annotation.SpringBean;\n import org.openmrs.ui.framework.page.PageModel;\n import org.openmrs.ui.framework.page.Redirect;\n+import org.openmrs.ui.framework.UiUtils;\n import org.springframework.web.bind.annotation.RequestParam;\n \n public class PatientDashboardPageController {\n@@ -51,6 +52,7 @@ public Object controller(@RequestParam(\"patientId\") Patient patient,\n          @SpringBean(\"appFrameworkService\") AppFrameworkService appFrameworkService,\n          @SpringBean(\"coreAppsProperties\") CoreAppsProperties coreAppsProperties,\n          @SpringBean(\"applicationEventService\") ApplicationEventService applicationEventService,\n+         UiUtils uiUtils,\n          UiSessionContext sessionContext)\n    {\n       if (!Context.hasPrivilege(CoreAppsConstants.PRIVILEGE_PATIENT_VISITS)) {\n@@ -65,6 +67,9 @@ else if (patient.isVoided() || patient.isPersonVoided()) {\n       model.addAttribute(\"patient\", patientDomainWrapper);\n       model.addAttribute(\"selectedTab\", selectedTab);\n       model.addAttribute(\"selectedVisit\", visit);\n+      model.addAttribute(\"dateFormat\" , uiUtils.getJSDateFormat()); //dateFormat);\n+      model.addAttribute(\"datetimeFormat\" , uiUtils.getJSDatetimeFormat());\n+      model.addAttribute(\"timeFormat\" , uiUtils.getTimeFormat());\n \n       Location visitLocation = null;\n       try {"
  },
  {
    "sha": "e542f894c1d9206aeb2b1a2ca912f3695ac6ad26",
    "filename": "omod/src/main/web/dashboardwidgets/latestobsforconceptlist/latestobsforconceptlist.html",
    "status": "modified",
    "additions": 1,
    "deletions": 1,
    "changes": 2,
    "blob_url": "https://github.com/openmrs/openmrs-module-coreapps/blob/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/omod/src/main/web/dashboardwidgets/latestobsforconceptlist/latestobsforconceptlist.html",
    "raw_url": "https://github.com/openmrs/openmrs-module-coreapps/raw/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/omod/src/main/web/dashboardwidgets/latestobsforconceptlist/latestobsforconceptlist.html",
    "contents_url": "https://api.github.com/repos/openmrs/openmrs-module-coreapps/contents/omod/src/main/web/dashboardwidgets/latestobsforconceptlist/latestobsforconceptlist.html?ref=acbad4bdfcd76a354fc4c6adce6548a1d033e5b0",
    "patch": "@@ -8,7 +8,7 @@\n                 <span ng-repeat=\"member in obs.groupMembers\" style=\"float: left\">\n                     {{member.prefix}}&nbsp;<strong>{{member.value}}</strong>\n                     <span ng-if=\"$index != (obs.groupMembers.length - 1)\">&comma;</span>\n-                </span> \n+                </span>\n             </div>\n             <span ng-else style=\"float: left\">\n                 <strong>{{obs.value}}</strong>"
  },
  {
    "sha": "56e482f453e90acd7438992ca4d4ccc04bd8edb0",
    "filename": "omod/src/main/webapp/fragments/patientHeader.gsp",
    "status": "modified",
    "additions": 32,
    "deletions": 6,
    "changes": 38,
    "blob_url": "https://github.com/openmrs/openmrs-module-coreapps/blob/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/omod/src/main/webapp/fragments/patientHeader.gsp",
    "raw_url": "https://github.com/openmrs/openmrs-module-coreapps/raw/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/omod/src/main/webapp/fragments/patientHeader.gsp",
    "contents_url": "https://api.github.com/repos/openmrs/openmrs-module-coreapps/contents/omod/src/main/webapp/fragments/patientHeader.gsp?ref=acbad4bdfcd76a354fc4c6adce6548a1d033e5b0",
    "patch": "@@ -4,6 +4,8 @@\n \n     ui.includeCss(\"coreapps\", \"patientHeader.css\")\n     ui.includeJavascript(\"coreapps\", \"patientdashboard/patient.js\")\n+    ui.includeJavascript(\"uicommons\", \"moment-with-locales.min.js\")\n+    ui.includeJavascript(\"coreapps\", \"custom/utilsTimezone.js\")\n \n     appContextModel.put(\"returnUrl\", ui.thisUrl())\n %>\n@@ -75,8 +77,12 @@\n \n     <% if (patient.patient.dead) { %>\n         <div class=\"death-header col-12\">\n-            <span class=\"death-message\">\n-                ${ ui.message(\"coreapps.deadPatient\", ui.format(patient.patient.deathDate), ui.format(patient.patient.causeOfDeath)) }\n+            <span class=\"death-message ${ui.handleTimeZones() ? 'rfc3339-date' : ''}\">\n+                <% if (ui.handleTimeZones()) { %>\n+                    ${ui.message(\"coreapps.deadPatient\", ui.format(patient.patient.deathDate), ui.format(patient.patient.causeOfDeath))}\n+                <% } else { %>\n+                    ${ui.message(\"coreapps.deadPatient\", ui.format(patient.patient.deathDate), ui.format(patient.patient.causeOfDeath))}\n+                <% } %>\n             </span>\n             <span class=\"death-info-extension\">\n                 <%= ui.includeFragment(\"appui\", \"extensionPoint\", [ id: \"patientHeader.deathInfo\", contextModel: appContextModel ]) %>\n@@ -102,7 +108,7 @@\n                 </h1>\n             </div>\n \n-            <div class=\"gender-age col-auto\">\n+            <div class=\"gender-age col-auto ${ui.handleTimeZones() ? 'rfc3339-date' : ''}\">\n                 <span>${ui.message(\"coreapps.gender.\" + ui.encodeHtml(patient.gender))}&nbsp;</span>\n                 <span>\n                     <% if (patient.birthdate) { %>\n@@ -113,9 +119,12 @@\n                     <% } else { %>\n                         ${ui.message(\"coreapps.ageDays\", patient.ageInDays)}\n                     <% } %>\n-                    (<% if (patient.birthdateEstimated) { %>~<% } %>${ ui.formatDatePretty(patient.birthdate) })\n-                    <% } else { %>\n-                        ${ui.message(\"coreapps.unknownAge\")}\n+                    (<% if (patient.birthdateEstimated) { %>~<% } %>\n+                    <span class=\"patient-birhtdate\">\n+                        ${ui.formatDatePretty(patient.birthdate)}\n+                    </span>)\n+                <% } else { %>\n+                ${ui.message(\"coreapps.unknownAge\")}\n                     <% } %>\n                 </span>\n                 <span id=\"edit-patient-demographics\" class=\"edit-info ml-2\">\n@@ -253,3 +262,20 @@\n         <button class=\"cancel\">${ui.message(\"coreapps.cancel\")}</button>\n     </div>\n </div>\n+\n+<script type=\"text/javascript\">\n+\n+    //Convert dates to client timezone\n+    if (jq(\".death-message.rfc3339-date\").text() != '') {\n+        jq(\".death-message.rfc3339-date\").text(function () {\n+            return jq(this).text().replace(\"${ui.format(patient.patient.deathDate)}\", formatDatetime(new Date(\"${ui.format(patient.patient.deathDate)}\"),  \"${ui.getJSDatetimeFormat()}\",  \"${ui.getLocale()}\"));\n+        });\n+    }\n+    //Convert Age to client timezone\n+    if (jq(\".gender-age.rfc3339-date\").find(\".patient-birhtdate\").text() != '') {\n+            jq(\".gender-age.rfc3339-date\").find(\".patient-birhtdate\").text(function () {\n+                return jq(this).text().replace(\"${ui.formatDatePretty(patient.birthdate)}\", formatDate(new Date(\"${ui.formatDatePretty(patient.birthdate)}\"), \"${ui.getJSDateFormat()}\", \"${ui.getLocale()}\"));\n+            });\n+        }\n+\n+</script>\n\\ No newline at end of file"
  },
  {
    "sha": "ec1f02b33ade1ebe00fe168653aeb7c43f047b9d",
    "filename": "omod/src/main/webapp/fragments/patientdashboard/activeDrugOrders.gsp",
    "status": "modified",
    "additions": 13,
    "deletions": 1,
    "changes": 14,
    "blob_url": "https://github.com/openmrs/openmrs-module-coreapps/blob/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/omod/src/main/webapp/fragments/patientdashboard/activeDrugOrders.gsp",
    "raw_url": "https://github.com/openmrs/openmrs-module-coreapps/raw/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/omod/src/main/webapp/fragments/patientdashboard/activeDrugOrders.gsp",
    "contents_url": "https://api.github.com/repos/openmrs/openmrs-module-coreapps/contents/omod/src/main/webapp/fragments/patientdashboard/activeDrugOrders.gsp?ref=acbad4bdfcd76a354fc4c6adce6548a1d033e5b0",
    "patch": "@@ -2,6 +2,7 @@\n     def careSettings = activeDrugOrders.collect{it.careSetting}.unique();\n     detailsUrl = detailsUrl ? detailsUrl.replace(\"{{patientUuid}}\", patient.uuid) : null;\n     returnUrl = returnUrl ? returnUrl.replace(\"{{patientUuid}}\", patient.uuid) : \"\";\n+    ui.includeJavascript(\"coreapps\", \"custom/utilsTimezone.js\")\n %>\n \n <style type=\"text/css\">\n@@ -38,7 +39,7 @@\n                         <label>${ ui.format(it.drug ?: it.concept) }</label>\n                         <small>${ it.dosingInstructionsInstance.getDosingInstructionsAsString(sessionContext.locale) }</small>\n                         <% if (displayActivationDate) { %>\n-                            <span style='float:right; font-size: small; color:#939393' >${ ui.formatDatetimePretty(it.dateActivated) }</span>\n+                            <span style='float:right; font-size: small; color:#939393' class=\"${ui.handleTimeZones() ? 'rfc3339-date' : ''}\" >${ui.handleTimeZones() ? ui.format(it.dateActivated) : ui.formatDatetimePretty(it.dateActivated)}</span>\n                         <% } %>\n                     </li>\n                     <% } %>\n@@ -48,3 +49,14 @@\n     </div>\n \n </div>\n+\n+<script type=\"text/javascript\">\n+    jq(document).ready(function () {\n+        jq(\".active-drug-orders .rfc3339-date\").each(function() {\n+            var drugDatetimeInUTC = jq(this).text().trim();\n+            jq(this).text(function () {\n+                return jq(this).text().replace(drugDatetimeInUTC, formatDate(new Date(drugDatetimeInUTC), \"${ui.getJSDateFormat()}\", \"${ui.getLocale()}\") + \" \" + formatTime(new Date(drugDatetimeInUTC), \"${ui.getTimeFormat()}\", \"${ui.getLocale()}\") );\n+            });\n+        });\n+    });\n+</script>\n\\ No newline at end of file"
  },
  {
    "sha": "85d1085471ae257e9fe172de8df7484a83ab3e83",
    "filename": "omod/src/main/webapp/fragments/patientdashboard/encountertemplate/defaultEncounterTemplate.gsp",
    "status": "modified",
    "additions": 5,
    "deletions": 3,
    "changes": 8,
    "blob_url": "https://github.com/openmrs/openmrs-module-coreapps/blob/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/omod/src/main/webapp/fragments/patientdashboard/encountertemplate/defaultEncounterTemplate.gsp",
    "raw_url": "https://github.com/openmrs/openmrs-module-coreapps/raw/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/omod/src/main/webapp/fragments/patientdashboard/encountertemplate/defaultEncounterTemplate.gsp",
    "contents_url": "https://api.github.com/repos/openmrs/openmrs-module-coreapps/contents/omod/src/main/webapp/fragments/patientdashboard/encountertemplate/defaultEncounterTemplate.gsp?ref=acbad4bdfcd76a354fc4c6adce6548a1d033e5b0",
    "patch": "@@ -4,12 +4,14 @@\n \n <script type=\"text/template\" id=\"defaultEncounterTemplate\">\n <li>\n-\t<div class=\"encounter-date\">\n+\t<div class=\"encounter-date ${ui.handleTimeZones() ? 'rfc3339-date' : ''}\">\n \t    <i class=\"icon-time\"></i>\n-\t    <strong>\n+\t    <strong class=\"encounter-time\">\n \t        {{- encounter.encounterTime }}\n \t    </strong>\n-\t    {{- encounter.encounterDate }}\n+\t\t<spann class=\"encounter-datetime\">\n+\t    \t{{- encounter.encounterDate }}\n+\t\t</spann>\n \t</div>\n \t<ul class=\"encounter-details\">\n \t    <li> "
  },
  {
    "sha": "287727fa4dc2413077b0f40bb787b18fb971e385",
    "filename": "omod/src/main/webapp/fragments/patientdashboard/encountertemplate/noDetailsEncounterTemplate.gsp",
    "status": "modified",
    "additions": 8,
    "deletions": 6,
    "changes": 14,
    "blob_url": "https://github.com/openmrs/openmrs-module-coreapps/blob/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/omod/src/main/webapp/fragments/patientdashboard/encountertemplate/noDetailsEncounterTemplate.gsp",
    "raw_url": "https://github.com/openmrs/openmrs-module-coreapps/raw/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/omod/src/main/webapp/fragments/patientdashboard/encountertemplate/noDetailsEncounterTemplate.gsp",
    "contents_url": "https://api.github.com/repos/openmrs/openmrs-module-coreapps/contents/omod/src/main/webapp/fragments/patientdashboard/encountertemplate/noDetailsEncounterTemplate.gsp?ref=acbad4bdfcd76a354fc4c6adce6548a1d033e5b0",
    "patch": "@@ -1,11 +1,13 @@\n <script type=\"text/template\" id=\"noDetailsEncounterTemplate\">\n <li>\n-\t<div class=\"encounter-date\">\n-\t    <i class=\"icon-time\"></i>\n-\t    <strong>\n-\t        {{- encounter.encounterTime }}\n-\t    </strong>\n-\t    {{- encounter.encounterDate }}\n+\t<div class=\"encounter-date ${ui.handleTimeZones() ? 'rfc3339-date' : ''}\">\n+\t\t<i class=\"icon-time\"></i>\n+\t\t<strong class=\"encounter-time\">\n+\t\t\t{{- encounter.encounterTime }}\n+\t\t</strong>\n+\t\t<spann class=\"encounter-datetime\">\n+\t\t\t{{- encounter.encounterDate }}\n+\t\t</spann>\n \t</div>\n \t<ul class=\"encounter-details\">\n \t    <li> "
  },
  {
    "sha": "1c965d41d6f31f1c051328f436b7614293cf1ca9",
    "filename": "omod/src/main/webapp/fragments/patientdashboard/visitDetailsTemplate.gsp",
    "status": "modified",
    "additions": 31,
    "deletions": 5,
    "changes": 36,
    "blob_url": "https://github.com/openmrs/openmrs-module-coreapps/blob/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/omod/src/main/webapp/fragments/patientdashboard/visitDetailsTemplate.gsp",
    "raw_url": "https://github.com/openmrs/openmrs-module-coreapps/raw/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/omod/src/main/webapp/fragments/patientdashboard/visitDetailsTemplate.gsp",
    "contents_url": "https://api.github.com/repos/openmrs/openmrs-module-coreapps/contents/omod/src/main/webapp/fragments/patientdashboard/visitDetailsTemplate.gsp?ref=acbad4bdfcd76a354fc4c6adce6548a1d033e5b0",
    "patch": "@@ -1,10 +1,15 @@\n+<%\n+    ui.includeJavascript(\"coreapps\", \"custom/utilsTimezone.js\")\n+    ui.includeJavascript(\"uicommons\", \"moment-with-locales.min.js\")\n+%>\n+\n <div class=\"status-container\">\n     [[ if (stopDatetime) { ]]\n-        <i class=\"icon-time small\"></i> ${ ui.message(\"coreapps.visitDetails\", '[[- startDatetime ]]', '[[- stopDatetime ]]') }\n-    [[ } else { ]]\n-        <span class=\"status active\"></span> ${ ui.message(\"coreapps.activeVisit\") }\n-        <i class=\"icon-time small\"></i>\n-        ${ ui.message(\"coreapps.activeVisit.time\", '[[- startDatetime ]]') }\n+    <i class=\"icon-time small\"></i> <span class=\"visit-date\"> ${ ui.message(\"coreapps.visitDetails\", '[[- startDatetime ]]', '[[- stopDatetime ]]') } </span>\n+[[ } else { ]]\n+    <span class=\"status active\"></span> ${ ui.message(\"coreapps.activeVisit\") }\n+    <i class=\"icon-time small\"></i>\n+    <span class=\"visit-date\" > ${ ui.message(\"coreapps.activeVisit.time\", '[[- startDatetime ]]') } </span>\n     [[ } ]]\n     [[ if (canDeleteVisit) { ]]\n         <a class=\"right\" id=\"deleteVisitLink\" href=\"#\" data-visit-id=\"[[= id]]\">${ ui.message(\"coreapps.task.deleteVisit.label\")}</a>\n@@ -48,3 +53,24 @@\n         [[= encounterTemplates.displayEncounter(encounter, patient) ]]\n     [[ }); ]]\n </ul>\n+\n+<script type=\"text/javascript\">\n+    jq(document).ready(function () {\n+\n+        //Convert dates to client timezone\n+        if (${ui.handleTimeZones()}) {\n+            if ('[[- startDatetime ]]' && '[[- stopDatetime ]]'){\n+                jq(\".visit-date\").text(function () {\n+                    return jq(this).text().replace('[[- startDatetime ]]', formatDate(new Date('[[- startDatetime ]]'), \"${ui.getJSDateFormat()}\", \"${ui.getLocale()}\"));\n+                });\n+                    jq(\".visit-date\").text(function () {\n+                        return jq(this).text().replace('[[- stopDatetime ]]', formatDatetime(new Date('[[- stopDatetime ]]'), \"${ui.getJSDatetimeFormat()}\",  \"${ui.getLocale()}\"));\n+                    });\n+            }else if ('[[- startDatetime ]]') {\n+                jq(\".visit-date\").text(function () {\n+                   return jq(this).text().replace('[[- startDatetime ]]', formatDatetime(new Date('[[- startDatetime ]]'), \"${ui.getJSDatetimeFormat()}\", \"${ui.getLocale()}\"));\n+                });\n+            }\n+        }\n+    })\n+</script>\n\\ No newline at end of file"
  },
  {
    "sha": "020b4db9234f612f12730a537a113e0d91c7befc",
    "filename": "omod/src/main/webapp/fragments/patientdashboard/visitIncludes.gsp",
    "status": "modified",
    "additions": 13,
    "deletions": 5,
    "changes": 18,
    "blob_url": "https://github.com/openmrs/openmrs-module-coreapps/blob/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/omod/src/main/webapp/fragments/patientdashboard/visitIncludes.gsp",
    "raw_url": "https://github.com/openmrs/openmrs-module-coreapps/raw/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/omod/src/main/webapp/fragments/patientdashboard/visitIncludes.gsp",
    "contents_url": "https://api.github.com/repos/openmrs/openmrs-module-coreapps/contents/omod/src/main/webapp/fragments/patientdashboard/visitIncludes.gsp?ref=acbad4bdfcd76a354fc4c6adce6548a1d033e5b0",
    "patch": "@@ -2,11 +2,15 @@\n     ui.includeJavascript(\"coreapps\", \"custom/visits.js\")\n     def editDateFormat = new java.text.SimpleDateFormat(\"dd-MM-yyyy\")\n     ui.includeCss(\"coreapps\", \"visit/visits.css\")\n+    ui.includeJavascript(\"coreapps\", \"custom/utilsTimezone.js\")\n %>\n \n <script type=\"text/javascript\">\n     jq(function() {\n-\n+        window.visitinclude = {\n+            dateFormat: \"${dateFormat}\",\n+            locale: \"${ui.getLocale()}\",\n+        };\n         // initialize the dialogs used when creating a retrospective visit\n         visit.createRetrospectiveVisitDialog(${patient.id});\n         visit.createRetrospectiveVisitExistingVisitsDialog();\n@@ -47,7 +51,7 @@\n     </div>\n </div>\n \n-<div id=\"retrospective-visit-creation-dialog\" class=\"dialog\" style=\"display: none\">\n+<div id=\"retrospective-visit-creation-dialog\" class=\"dialog ${ui.handleTimeZones() ? 'rfc3339-date' : ''}\" style=\"display: none\">\n     <div class=\"dialog-header\">\n         <i class=\"icon-plus\"></i>\n         <h3>${ ui.message(\"coreapps.task.createRetrospectiveVisit.label\") }</h3>\n@@ -61,14 +65,18 @@\n                 if (patient.patient.deathDate) {\n                   visitEndTime = patient.patient.deathDate\n                 }\n+            def endDate =editDateFormat.format(visitEndTime);\n+            if(ui.handleTimeZones()){\n+                    endDate =visitEndTime;\n+                }\n             %>\n \n             ${ ui.includeFragment(\"uicommons\", \"field/datetimepicker\", [\n                     id: \"retrospectiveVisitStartDate\",\n                     formFieldName: \"retrospectiveVisitStartDate\",\n                     label:\"\",\n                     defaultDate: visitEndTime,\n-                    endDate: editDateFormat.format(visitEndTime),\n+                    endDate: endDate,\n                     useTime: false,\n             ])}\n         </p>\n@@ -83,7 +91,7 @@\n                     formFieldName: \"retrospectiveVisitStopDate\",\n                     label:\"\",\n                     defaultDate: visitEndTime,\n-                    endDate: editDateFormat.format(visitEndTime),\n+                    endDate: endDate,\n                     useTime: false,\n             ])}\n         </p>\n@@ -110,7 +118,7 @@\n             </li>\n         </ul>\n \n-        <ul class=\"select\" id=\"past-visit-dates\">\n+        <ul class=\"select  ${  ui.handleTimeZones() ? 'rfc3339-date' : ''}\" id=\"past-visit-dates\">\n \n         </ul>\n "
  },
  {
    "sha": "b067b3348f3d40067d7b1ec5fef73fbd79418116",
    "filename": "omod/src/main/webapp/fragments/patientdashboard/visits.gsp",
    "status": "modified",
    "additions": 18,
    "deletions": 4,
    "changes": 22,
    "blob_url": "https://github.com/openmrs/openmrs-module-coreapps/blob/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/omod/src/main/webapp/fragments/patientdashboard/visits.gsp",
    "raw_url": "https://github.com/openmrs/openmrs-module-coreapps/raw/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/omod/src/main/webapp/fragments/patientdashboard/visits.gsp",
    "contents_url": "https://api.github.com/repos/openmrs/openmrs-module-coreapps/contents/omod/src/main/webapp/fragments/patientdashboard/visits.gsp?ref=acbad4bdfcd76a354fc4c6adce6548a1d033e5b0",
    "patch": "@@ -74,13 +74,27 @@\n                 def primaryDiagnoses = wrapper.getUniqueDiagnoses(true, false)\n         %>\n         <li class=\"menu-item viewVisitDetails\" data-visit-id=\"${wrapper.visit.visitId}\">\n-            <span class=\"menu-date\">\n+            <span class=\"menu-date ${  ui.handleTimeZones() ? 'rfc3339-date' : ''}\">\n                 <i class=\"icon-time\"></i>\n-                ${ui.format(wrapper.startDate)}\n+                <span class=\"visit-start-date\">\n+                    <% if(ui.handleTimeZones()) { %>\n+                ${ui.format(wrapper.visit.startDatetime)}\n+                <% } else { %>\n+                    ${ui.format(wrapper.startDate)}\n+                <% } %>\n+                </span>\n                 <% if(wrapper.stopDate != null) { %>\n-                    - ${ui.format(wrapper.stopDate)}\n+                    <% if(ui.handleTimeZones()) { %>\n+                        - <span class=\"visit-stop-date\">${ui.format(wrapper.visit.stopDatetime)}</span>\n+                    <% } else { %>\n+                        - <span class=\"visit-stop-date\">${ui.format(wrapper.stopDate)}</span>\n+                    <% } %>\n                 <% } else { %>\n-                    (${ ui.message(\"coreapps.patientDashBoard.activeSince\")} ${timeFormat.format(wrapper.visit.startDatetime)})\n+                    <% if(ui.handleTimeZones()) { %>\n+                        (${ ui.message(\"coreapps.patientDashBoard.activeSince\")}<span class=\"visit-start-datetime\"> ${ui.format(wrapper.visit.startDatetime)}</span>)\n+                    <% } else { %>\n+                        (${ ui.message(\"coreapps.patientDashBoard.activeSince\")}<span class=\"visit-start-datetime\"> ${timeFormat.format(wrapper.visit.startDatetime)}</span>)\n+                    <% } %>\n                 <% } %>\n             </span>\n             <% if (primaryDiagnoses != null) { %>  <!-- if primary diagnosis is null, don't display box at all, if empty, display \"no diagnosis\" message -->"
  },
  {
    "sha": "9aea7323f7f002221c4d29b941ad706acb692eb2",
    "filename": "omod/src/main/webapp/fragments/patientheader/activeVisitStatus.gsp",
    "status": "modified",
    "additions": 13,
    "deletions": 1,
    "changes": 14,
    "blob_url": "https://github.com/openmrs/openmrs-module-coreapps/blob/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/omod/src/main/webapp/fragments/patientheader/activeVisitStatus.gsp",
    "raw_url": "https://github.com/openmrs/openmrs-module-coreapps/raw/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/omod/src/main/webapp/fragments/patientheader/activeVisitStatus.gsp",
    "contents_url": "https://api.github.com/repos/openmrs/openmrs-module-coreapps/contents/omod/src/main/webapp/fragments/patientheader/activeVisitStatus.gsp?ref=acbad4bdfcd76a354fc4c6adce6548a1d033e5b0",
    "patch": "@@ -1,10 +1,22 @@\n <% if (config.activeVisit) { %>\n     <% def visit = config.activeVisit.visit %>\n-\n+<%\n+        ui.includeJavascript(\"coreapps\", \"custom/utilsTimezone.js\")\n+%>\n     <div class=\"active-visit-started-at-message\">\n         ${ui.message(\"coreapps.patientHeader.activeVisit.at\", config.activeVisitStartDatetime)}\n     </div>\n+<script type=\"text/javascript\">\n+    jq(document).ready(function () {\n \n+        //Convert dates to client timezone\n+        if(${ui.handleTimeZones()}){\n+             jq(\".active-visit-started-at-message\").text(function () {\n+             return jq(this).text().replace(\"${config.activeVisitStartDatetime}\", formatDatetime(new Date(\"${config.activeVisitStartDatetime}\") , \"${ui.getJSDatetimeFormat()}\",  \"${ui.getLocale()}\"));\n+             });\n+        }\n+    })\n+</script>\n     <% if (config.showVisitTypeOnPatientHeaderSection == false) { %>\n         <% if (config.activeVisit.admitted) { %>\n         <div class=\"active-visit-message\">"
  },
  {
    "sha": "5f8683ef3eeecdb5872a19ba3bb37976494023fd",
    "filename": "omod/src/main/webapp/fragments/stickyNote.gsp",
    "status": "modified",
    "additions": 2,
    "deletions": 2,
    "changes": 4,
    "blob_url": "https://github.com/openmrs/openmrs-module-coreapps/blob/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/omod/src/main/webapp/fragments/stickyNote.gsp",
    "raw_url": "https://github.com/openmrs/openmrs-module-coreapps/raw/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/omod/src/main/webapp/fragments/stickyNote.gsp",
    "contents_url": "https://api.github.com/repos/openmrs/openmrs-module-coreapps/contents/omod/src/main/webapp/fragments/stickyNote.gsp?ref=acbad4bdfcd76a354fc4c6adce6548a1d033e5b0",
    "patch": "@@ -9,8 +9,8 @@\n \t\n \tui.includeJavascript(\"uicommons\", \"ngDialog/ngDialog.js\")\n \tui.includeCss(\"uicommons\", \"ngDialog/ngDialog.min.css\")\n-\t\n-\tui.includeJavascript(\"uicommons\", \"moment.min.js\")\n+\n+\tui.includeJavascript(\"uicommons\", \"moment-with-locales.min.js\")\n \t\n %>\n "
  },
  {
    "sha": "83202d5bd0f7834b55a82ff8735c94becc9e04b2",
    "filename": "omod/src/main/webapp/pages/activeVisits.gsp",
    "status": "modified",
    "additions": 14,
    "deletions": 3,
    "changes": 17,
    "blob_url": "https://github.com/openmrs/openmrs-module-coreapps/blob/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/omod/src/main/webapp/pages/activeVisits.gsp",
    "raw_url": "https://github.com/openmrs/openmrs-module-coreapps/raw/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/omod/src/main/webapp/pages/activeVisits.gsp",
    "contents_url": "https://api.github.com/repos/openmrs/openmrs-module-coreapps/contents/omod/src/main/webapp/pages/activeVisits.gsp?ref=acbad4bdfcd76a354fc4c6adce6548a1d033e5b0",
    "patch": "@@ -3,6 +3,8 @@\n     ui.includeJavascript(\"coreapps\", \"visit/jquery.dataTables.js\")\n     ui.includeJavascript(\"coreapps\", \"visit/filterTable.js\")\n     ui.includeCss(\"coreapps\", \"visit/visits.css\")\n+    ui.includeJavascript(\"coreapps\", \"custom/utilsTimezone.js\")\n+    ui.includeJavascript(\"uicommons\", \"moment-with-locales.min.js\")\n %>\n <script type=\"text/javascript\">\n     var breadcrumbs = [\n@@ -30,7 +32,7 @@\n     <% } %>\n </p>\n \n-<table class=\"table table-sm table-responsive-sm table-responsive-md table-responsive-lg table-responsive-xl\" id=\"active-visits\" width=\"100%\" border=\"1\" cellspacing=\"0\" cellpadding=\"2\">\n+<table class=\"table table-sm table-responsive-sm table-responsive-md table-responsive-lg table-responsive-xl ${ui.handleTimeZones() ? 'rfc3339-date' : ''}\" id=\"active-visits\" width=\"100%\" border=\"1\" cellspacing=\"0\" cellpadding=\"2\">\n \t<thead>\n \t\t<tr>\n \t\t\t<th>${ ui.message(\"coreapps.patient.identifier\") }</th>\n@@ -68,7 +70,7 @@\n \t\t\t\t<td>\n                     <% if (checkIn) { %>\n                         <small>\n-                            ${ ui.encodeHtmlContent(ui.format(checkIn.location)) } @ ${ ui.format(checkIn.encounterDatetime) }\n+                            ${ ui.encodeHtmlContent(ui.format(checkIn.location)) } @ <span class=\"check-in-date\">${ ui.format(checkIn.encounterDatetime) }</span>\n                         </small>\n                     <% } %>\n \t\t\t\t</td>\n@@ -77,7 +79,7 @@\n                         ${ ui.encodeHtmlContent(ui.format(latest.encounterType)) }\n                         <br/>\n                         <small>\n-                            ${ ui.encodeHtmlContent(ui.format(latest.location)) } @ ${ ui.format(latest.encounterDatetime) }\n+                            ${ ui.encodeHtmlContent(ui.format(latest.location)) } @  <span class=\"check-in-date\">${ ui.format(latest.encounterDatetime) }</span>\n                         </small>\n \n                     <% } %>\n@@ -109,3 +111,12 @@ ${ ui.includeFragment(\"uicommons\", \"widget/dataTable\", [ object: \"#active-visits\n                                                                   ]\n                                                         ]) }\n <% } %>\n+<script type=\"text/javascript\">\n+\n+    //Convert dates to client timezone\n+    if(jq(\"#active-visits.rfc3339-date\").length){\n+        jq(\"#active-visits.rfc3339-date .check-in-date\").each(function() {\n+            return jq(this).text(jq(this).text().replace(jq(this).text(), formatDatetime(new Date(jq(this).text().trim()), \"${ui.getJSDatetimeFormat()}\",  \"${ui.getLocale()}\")));\n+        });\n+    }\n+</script>\n\\ No newline at end of file"
  },
  {
    "sha": "7255c29f5ea7d1787d1bbf6c0b9aa12799dbe6a2",
    "filename": "omod/src/main/webapp/pages/markPatientDead.gsp",
    "status": "modified",
    "additions": 4,
    "deletions": 0,
    "changes": 4,
    "blob_url": "https://github.com/openmrs/openmrs-module-coreapps/blob/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/omod/src/main/webapp/pages/markPatientDead.gsp",
    "raw_url": "https://github.com/openmrs/openmrs-module-coreapps/raw/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/omod/src/main/webapp/pages/markPatientDead.gsp",
    "contents_url": "https://api.github.com/repos/openmrs/openmrs-module-coreapps/contents/omod/src/main/webapp/pages/markPatientDead.gsp?ref=acbad4bdfcd76a354fc4c6adce6548a1d033e5b0",
    "patch": "@@ -58,6 +58,10 @@\n                     jq(\"#cause-of-death-container > .field-error\").append(\"${ui.message(\"coreapps.markPatientDead.causeOfDeath.errorMessage\")}\").show();\n                     hasError = true;\n                 }\n+                if(!hasError && ${ui.handleTimeZones()}){\n+                    var inputDate = new Date(jq(\"#death-date-field\").val());\n+                    jq(\"#death-date-field\").val(inputDate.toISOString())\n+                }\n             }\n             return !hasError;\n         });"
  },
  {
    "sha": "6c531083545987441245fb1064a30facb9c48411",
    "filename": "omod/src/main/webapp/pages/mergeVisits.gsp",
    "status": "modified",
    "additions": 23,
    "deletions": 3,
    "changes": 26,
    "blob_url": "https://github.com/openmrs/openmrs-module-coreapps/blob/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/omod/src/main/webapp/pages/mergeVisits.gsp",
    "raw_url": "https://github.com/openmrs/openmrs-module-coreapps/raw/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/omod/src/main/webapp/pages/mergeVisits.gsp",
    "contents_url": "https://api.github.com/repos/openmrs/openmrs-module-coreapps/contents/omod/src/main/webapp/pages/mergeVisits.gsp?ref=acbad4bdfcd76a354fc4c6adce6548a1d033e5b0",
    "patch": "@@ -96,7 +96,7 @@ ${ ui.includeFragment(\"coreapps\", \"patientHeader\", [ patient: patient.patient, a\n ${ ui.message(\"coreapps.task.mergeVisits.instructions\") }\n \n <form method=\"post\" action=\"${ ui.pageLink(\"coreapps\", \"mergeVisits\") }\">\n-    <table class=\"table table-sm table-responsive-sm table-responsive-md table-responsive-lg table-responsive-xl\" id=\"active-visits\" width=\"100%\" border=\"1\" cellspacing=\"0\" cellpadding=\"2\">\n+    <table class=\"table table-sm table-responsive-sm table-responsive-md table-responsive-lg table-responsive-xl ${  ui.handleTimeZones() ? 'rfc3339-date' : ''}\" id=\"active-visits\" width=\"100%\" border=\"1\" cellspacing=\"0\" cellpadding=\"2\">\n         <thead>\n         <tr>\n             <th>${ ui.message(\"coreapps.merge\") }</th>\n@@ -112,10 +112,10 @@ ${ ui.message(\"coreapps.task.mergeVisits.instructions\") }\n         %>\n         <tr id=\"visit-${ visitId }\">\n             <td width=\"8%\"><input type=\"checkbox\" name=\"mergeVisits\" value=\"${ visitId }\" id=\"mergeVisit-${ visitId }\" class=\"selectVisit\" data-visit-id=\"${ visitId }\"/></td>\n-            <td width=\"14%\">\n+            <td width=\"14%\" class=\"start-date\">\n                 ${ui.format(wrapper.startDate)}\n             </td>\n-            <td width=\"14%\">\n+            <td width=\"14%\" class=\"stop-date\">\n                 <% if(wrapper.stopDate != null) { %>\n                     ${ui.format(wrapper.stopDate)}\n                 <% } %>\n@@ -135,3 +135,23 @@ ${ ui.message(\"coreapps.task.mergeVisits.instructions\") }\n         <input type=\"submit\" id=\"mergeVisitsBtn\" class=\"confirm\" value=\"${ ui.message(\"coreapps.task.mergeVisits.mergeSelectedVisits\") }\" />\n     </div>\n </form>\n+<script type=\"text/javascript\">\n+    jq(document).ready(function () {\n+        //Convert dates to client timezone\n+        jq(\".table.table-sm.rfc3339-date .start-date\").each(function(){\n+            if(jq(this).text().trim() != ''){\n+                jq(this).text(function () {\n+                    return jq(this).text().replace(jq(this).text().trim(), formatDatetime(new Date(jq(this).text().trim()), \"${ui.getJSDateFormat()}\",  \"${ui.getLocale()}\"));\n+                });\n+            }\n+        });\n+        //Convert dates to client timezone\n+        jq(\".table.table-sm.rfc3339-date .stop-date\").each(function(){\n+            if(jq(this).text().trim() != ''){\n+                jq(this).text(function () {\n+                    return jq(this).text().replace(jq(this).text().trim(), formatDatetime(new Date(jq(this).text().trim()), \"${ui.getJSDateFormat()}\",  \"${ui.getLocale()}\"));\n+                });\n+            }\n+        });\n+    });\n+</script>\n\\ No newline at end of file"
  },
  {
    "sha": "5d3ea63d53032034d8a8024c1fb420175a049fc0",
    "filename": "omod/src/main/webapp/pages/patientdashboard/patientDashboard.gsp",
    "status": "modified",
    "additions": 30,
    "deletions": 0,
    "changes": 30,
    "blob_url": "https://github.com/openmrs/openmrs-module-coreapps/blob/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/omod/src/main/webapp/pages/patientdashboard/patientDashboard.gsp",
    "raw_url": "https://github.com/openmrs/openmrs-module-coreapps/raw/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/omod/src/main/webapp/pages/patientdashboard/patientDashboard.gsp",
    "contents_url": "https://api.github.com/repos/openmrs/openmrs-module-coreapps/contents/omod/src/main/webapp/pages/patientdashboard/patientDashboard.gsp?ref=acbad4bdfcd76a354fc4c6adce6548a1d033e5b0",
    "patch": "@@ -7,6 +7,9 @@\n \n     ui.includeJavascript(\"appui\", \"jquery-3.4.1.min.js\")\n \n+    ui.includeJavascript(\"coreapps\", \"custom/utilsTimezone.js\")\n+\n+    ui.includeJavascript(\"uicommons\", \"moment-with-locales.min.js\")\n \n     def tabs = [\n         [ id: \"visits\", label: ui.message(\"coreapps.patientDashBoard.visits\"), provider: \"coreapps\", fragment: \"patientdashboard/visits\" ],\n@@ -19,6 +22,12 @@\n \n %>\n <script type=\"text/javascript\">\n+    window.patientDashboard = {\n+        dateFormat: \"${dateFormat}\",\n+        datetimeFormat: \"${datetimeFormat}\",\n+        timeFormat: \"${timeFormat}\"\n+\n+    };\n     var breadcrumbs = [\n         { icon: \"icon-home\", link: '/' + OPENMRS_CONTEXT_PATH + '/index.htm' },\n         { label: \"${ ui.escapeJs(ui.encodeHtmlContent(ui.format(patient.patient))) }\" ,\n@@ -88,3 +97,24 @@ ${ ui.includeFragment(\"coreapps\", \"patientHeader\", [ patient: patient.patient, a\n         <% } %>\n     </div>\n </div>\n+<script type=\"text/javascript\">\n+\n+//If find rfc3339-date class, convert from UTC to client Timezone\n+jq(\".menu-date.rfc3339-date\").each(function() {\n+    var visitStartDateInUTC = (jq(this).find(\".visit-start-date\").text()).trim();\n+    jq(this).find(\".visit-start-date\").text(function () {\n+        return jq(this).text().replace(visitStartDateInUTC, formatDate(new Date(visitStartDateInUTC), \"${ui.getJSDateFormat()}\",  \"${ui.getLocale()}\"));\n+    });\n+    if(jq(this).find(\".visit-stop-date\").text() != ''){\n+        var visitStopDateInUTC = (jq(this).find(\".visit-stop-date\").text()).trim();\n+        jq(this).find(\".visit-stop-date\").text(function () {\n+            return jq(this).text().replace(visitStopDateInUTC, formatDate(new Date(visitStopDateInUTC), \"${ui.getJSDateFormat()}\",  \"${ui.getLocale()}\"));\n+        })};\n+\n+    if(jq(this).find(\".visit-start-datetime\").text() != ''){\n+        var visitStartDatetimeInUTC = (jq(this).find(\".visit-start-datetime\").text()).trim();\n+        jq(this).find(\".visit-start-datetime\").text(function () {\n+            return jq(this).text().replace(visitStartDatetimeInUTC, formatTime(new Date(visitStartDatetimeInUTC), \"${ui.getTimeFormat()}\",  \"${ui.getLocale()}\"));\n+        } )};\n+});\n+</script>\n\\ No newline at end of file"
  },
  {
    "sha": "86cd177e0849505a41084dcd53585ecc41909d38",
    "filename": "omod/src/main/webapp/resources/scripts/custom/utilsTimezone.js",
    "status": "added",
    "additions": 46,
    "deletions": 0,
    "changes": 46,
    "blob_url": "https://github.com/openmrs/openmrs-module-coreapps/blob/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/omod/src/main/webapp/resources/scripts/custom/utilsTimezone.js",
    "raw_url": "https://github.com/openmrs/openmrs-module-coreapps/raw/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/omod/src/main/webapp/resources/scripts/custom/utilsTimezone.js",
    "contents_url": "https://api.github.com/repos/openmrs/openmrs-module-coreapps/contents/omod/src/main/webapp/resources/scripts/custom/utilsTimezone.js?ref=acbad4bdfcd76a354fc4c6adce6548a1d033e5b0",
    "patch": "@@ -0,0 +1,46 @@\n+/**\n+ * Returns date translated according to preferred locale when Date Format displays the month as an abbreviation (MMM).\n+ * Ex: Date: 02-Jan-2021 Format: DD-MMM-YYYY Locale: fr_FR --> Return: 02-janv.-2021\n+ * @param {object} date Input Date\n+ * @param {string} format Date Format\n+ * @param {string} locale The preferred locale\n+ */\n+\n+function formatDatetime(date, format, locale) {\n+    var defaultFormat = 'DD.MMM.YYYY, HH:mm:ss';\n+    if(locale == undefined) {\n+        locale= 'en'\n+    }\n+    try {\n+       // alert(date)\n+        moment.locale(locale);\n+        return moment(date).format(format);\n+    } catch (err) {\n+        return moment(date).format(defaultFormat);\n+    }\n+}\n+\n+function formatDate(date, format, locale) {\n+    var defaultFormat = 'YYYY-MMM-DD';\n+    if(locale == undefined) {\n+        locale= 'en'\n+    }\n+    try {\n+     //   alert(\"core\")\n+        moment.locale(locale);\n+        return moment(date).format(format);\n+    } catch (err) {\n+        return moment(date).format(defaultFormat);\n+    }\n+}\n+\n+\n+function formatTime(date, format) {\n+    var defaultFormat = 'HH:mm';\n+    try {\n+        return moment(date).format(format);\n+    } catch (err) {\n+        return moment(date).format(defaultFormat);\n+    }\n+}\n+"
  },
  {
    "sha": "f5f724c8e1c9be51b66a8de172ccbdb96bca7cc3",
    "filename": "omod/src/main/webapp/resources/scripts/custom/visits.js",
    "status": "modified",
    "additions": 18,
    "deletions": 0,
    "changes": 18,
    "blob_url": "https://github.com/openmrs/openmrs-module-coreapps/blob/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/omod/src/main/webapp/resources/scripts/custom/visits.js",
    "raw_url": "https://github.com/openmrs/openmrs-module-coreapps/raw/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/omod/src/main/webapp/resources/scripts/custom/visits.js",
    "contents_url": "https://api.github.com/repos/openmrs/openmrs-module-coreapps/contents/omod/src/main/webapp/resources/scripts/custom/visits.js?ref=acbad4bdfcd76a354fc4c6adce6548a1d033e5b0",
    "patch": "@@ -54,6 +54,19 @@ visit.createRetrospectiveVisitDialog = function(patientId) {\n         selector: '#retrospective-visit-creation-dialog',\n         actions: {\n             confirm: function() {\n+                var startVal= jq(\"#retrospectiveVisitStartDate-field\").val();\n+                var stopVal=jq(\"#retrospectiveVisitStopDate-field\").val();\n+                startDate=new Date(new Date(moment(startVal)).setHours(0, 0, 0, 0));\n+                stopDate=new Date(new Date(moment(stopVal)).setHours(23, 59, 59, 999));\n+\n+                //If using timezones class .rfc3339-date then convert the date to ISO8601, if not, convert to a date without timezones associated with moment.\n+                if(jq(\"#retrospective-visit-creation-dialog.rfc3339-date\").length){\n+                    jq(\"#retrospectiveVisitStartDate-field\").val(startDate.toISOString());\n+                    jq(\"#retrospectiveVisitStopDate-field\").val(stopDate.toISOString());\n+                }else if(jq(\"#retrospective-visit-creation-dialog\").length){\n+                    jq(\"#retrospectiveVisitStartDate-field\").val(moment(startDate).format(\"YYYY-MM-DD HH:mm:ss\"));\n+                    jq(\"#retrospectiveVisitStopDate-field\").val(moment(stopDate).format(\"YYYY-MM-DD HH:mm:ss\"));\n+                }\n                 emr.getFragmentActionWithCallback('coreapps', 'visit/retrospectiveVisit', 'create',\n                     { patientId: patientId, locationId: sessionLocationModel.id(),\n                         startDate: jq('[name=retrospectiveVisitStartDate]').val(),\n@@ -71,6 +84,11 @@ visit.createRetrospectiveVisitDialog = function(patientId) {\n                             // TODO: I trigger a certain visit by triggering a click on property visit details item\n                             // TODO: might be something we want to do with angularJS going forward?\n                             data.forEach(function (v) {\n+                                //Convert dates to client timezone\n+                                if(jq(\"#retrospective-visit-existing-visits-dialog .select.rfc3339-date\").length){\n+                                    v.startDate=formatDatetime(new Date(v.startDate),  window.visitinclude.dateFormat, window.visitinclude.locale)\n+                                    v.stopDate=formatDatetime(new Date(v.stopDate),  window.visitinclude.dateFormat, window.visitinclude.locale)\n+                                }\n                                 var listItem = jq(\"<li class=\\\"menu-item past-visit-date-item\\\" visitId=\\\"visit.id\\\">\" + v.startDate + \" - \" + v.stopDate + \"</li>\");\n \n                                 listItem.click(function() {"
  },
  {
    "sha": "49c15acfe3b5dbd9ed3e379b34110a6f4c1b45eb",
    "filename": "omod/src/main/webapp/resources/scripts/fragments/visitDetails.js",
    "status": "modified",
    "additions": 9,
    "deletions": 1,
    "changes": 10,
    "blob_url": "https://github.com/openmrs/openmrs-module-coreapps/blob/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/omod/src/main/webapp/resources/scripts/fragments/visitDetails.js",
    "raw_url": "https://github.com/openmrs/openmrs-module-coreapps/raw/acbad4bdfcd76a354fc4c6adce6548a1d033e5b0/omod/src/main/webapp/resources/scripts/fragments/visitDetails.js",
    "contents_url": "https://api.github.com/repos/openmrs/openmrs-module-coreapps/contents/omod/src/main/webapp/resources/scripts/fragments/visitDetails.js?ref=acbad4bdfcd76a354fc4c6adce6548a1d033e5b0",
    "patch": "@@ -62,7 +62,15 @@ function loadTemplates (visitId, patientId, fromEncounter, encounterCount, curre\n                         });\n                     });\n                 }\n-                \n+\n+            //If find rfc3339-date class, convert from UTC to client Timezone\n+            jq(\".encounter-date.rfc3339-date\").each(function() {\n+                var datetimeInUTC = (jq(this).find(\".encounter-datetime\").text()).trim();\n+                jq(this).find(\".encounter-time\").text(formatTime(new Date(datetimeInUTC), window.patientDashboard.timeFormat));\n+                jq(this).find(\".encounter-datetime\").text(function () {\n+                    return jq(this).text().replace(datetimeInUTC, formatDatetime(new Date(datetimeInUTC), window.patientDashboard.datetimeFormat, window.visitinclude.locale));\n+                });\n+            });\n             }).fail(function(err) {\n                 emr.errorMessage(err);\n             });"
  }
]

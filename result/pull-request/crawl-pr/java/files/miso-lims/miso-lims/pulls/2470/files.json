[
  {
    "sha": "d7b247bc7a7eb6d9db44c42d489d756caccca89e",
    "filename": "RELEASE_NOTES.md",
    "status": "modified",
    "additions": 1,
    "deletions": 1,
    "changes": 2,
    "blob_url": "https://github.com/miso-lims/miso-lims/blob/d06f5f5a40f7e312e861bd34887b6641958791fc/RELEASE_NOTES.md",
    "raw_url": "https://github.com/miso-lims/miso-lims/raw/d06f5f5a40f7e312e861bd34887b6641958791fc/RELEASE_NOTES.md",
    "contents_url": "https://api.github.com/repos/miso-lims/miso-lims/contents/RELEASE_NOTES.md?ref=d06f5f5a40f7e312e861bd34887b6641958791fc",
    "patch": "@@ -2,7 +2,7 @@\n \n Changes:\n \n-\n+* Record item volume and location at time of distribution\n \n # 1.25.0\n "
  },
  {
    "sha": "aa8d150a534148ff218341d25bdf338b3d28667c",
    "filename": "core/src/main/java/uk/ac/bbsrc/tgac/miso/core/data/impl/transfer/TransferItem.java",
    "status": "modified",
    "additions": 32,
    "deletions": 3,
    "changes": 35,
    "blob_url": "https://github.com/miso-lims/miso-lims/blob/d06f5f5a40f7e312e861bd34887b6641958791fc/core/src/main/java/uk/ac/bbsrc/tgac/miso/core/data/impl/transfer/TransferItem.java",
    "raw_url": "https://github.com/miso-lims/miso-lims/raw/d06f5f5a40f7e312e861bd34887b6641958791fc/core/src/main/java/uk/ac/bbsrc/tgac/miso/core/data/impl/transfer/TransferItem.java",
    "contents_url": "https://api.github.com/repos/miso-lims/miso-lims/contents/core/src/main/java/uk/ac/bbsrc/tgac/miso/core/data/impl/transfer/TransferItem.java?ref=d06f5f5a40f7e312e861bd34887b6641958791fc",
    "patch": "@@ -1,6 +1,7 @@\n package uk.ac.bbsrc.tgac.miso.core.data.impl.transfer;\n \n import java.io.Serializable;\n+import java.math.BigDecimal;\n import java.util.Objects;\n \n import javax.persistence.MappedSuperclass;\n@@ -14,10 +15,11 @@\n   private static final long serialVersionUID = 1L;\n \n   private Boolean received;\n-\n   private Boolean qcPassed;\n-\n   private String qcNote;\n+  private BigDecimal distributedVolume;\n+  private String distributedBoxAlias;\n+  private String distributedBoxPosition;\n \n   public abstract Transfer getTransfer();\n \n@@ -47,13 +49,37 @@ public void setQcNote(String qcNote) {\n     this.qcNote = qcNote;\n   }\n \n+  public BigDecimal getDistributedVolume() {\n+    return distributedVolume;\n+  }\n+\n+  public void setDistributedVolume(BigDecimal distributedVolume) {\n+    this.distributedVolume = distributedVolume;\n+  }\n+\n+  public String getDistributedBoxAlias() {\n+    return distributedBoxAlias;\n+  }\n+\n+  public void setDistributedBoxAlias(String distributedBoxAlias) {\n+    this.distributedBoxAlias = distributedBoxAlias;\n+  }\n+\n+  public String getDistributedBoxPosition() {\n+    return distributedBoxPosition;\n+  }\n+\n+  public void setDistributedBoxPosition(String distributedBoxPosition) {\n+    this.distributedBoxPosition = distributedBoxPosition;\n+  }\n+\n   public abstract T getItem();\n \n   public abstract void setItem(T item);\n \n   @Override\n   public int hashCode() {\n-    return Objects.hash(received, qcPassed, qcNote, getItem());\n+    return Objects.hash(received, qcPassed, qcNote, distributedVolume, distributedBoxAlias, distributedBoxPosition, getItem());\n   }\n \n   @Override\n@@ -62,6 +88,9 @@ public boolean equals(Object obj) {\n         TransferItem::isReceived,\n         TransferItem::isQcPassed,\n         TransferItem::getQcNote,\n+        TransferItem::getDistributedVolume,\n+        TransferItem::getDistributedBoxAlias,\n+        TransferItem::getDistributedBoxPosition,\n         TransferItem::getItem);\n   }\n "
  },
  {
    "sha": "e8dbcdc09e1379159bb063e8690365b551da2fb7",
    "filename": "miso-dto/src/main/java/uk/ac/bbsrc/tgac/miso/dto/Dtos.java",
    "status": "modified",
    "additions": 10,
    "deletions": 2,
    "changes": 12,
    "blob_url": "https://github.com/miso-lims/miso-lims/blob/d06f5f5a40f7e312e861bd34887b6641958791fc/miso-dto/src/main/java/uk/ac/bbsrc/tgac/miso/dto/Dtos.java",
    "raw_url": "https://github.com/miso-lims/miso-lims/raw/d06f5f5a40f7e312e861bd34887b6641958791fc/miso-dto/src/main/java/uk/ac/bbsrc/tgac/miso/dto/Dtos.java",
    "contents_url": "https://api.github.com/repos/miso-lims/miso-lims/contents/miso-dto/src/main/java/uk/ac/bbsrc/tgac/miso/dto/Dtos.java?ref=d06f5f5a40f7e312e861bd34887b6641958791fc",
    "patch": "@@ -4047,8 +4047,13 @@ private static TransferItemDto asDto(@Nonnull TransferItem<?> from) {\n     setBoolean(to::setQcPassed, from.isQcPassed(), true);\n     setString(to::setQcNote, from.getQcNote());\n     setLong(to::setBoxId, maybeGetProperty(maybeGetProperty(from.getItem(), Boxable::getBox), Box::getId), true);\n-    setString(to::setBoxAlias, maybeGetProperty(maybeGetProperty(from.getItem(), Boxable::getBox), Box::getAlias));\n-    setString(to::setBoxPosition, maybeGetProperty(from.getItem(), Boxable::getBoxPosition));\n+    if (from.getItem().getBox() != null) {\n+      setString(to::setBoxAlias, maybeGetProperty(maybeGetProperty(from.getItem(), Boxable::getBox), Box::getAlias));\n+      setString(to::setBoxPosition, maybeGetProperty(from.getItem(), Boxable::getBoxPosition));\n+    } else if (from.getDistributedBoxAlias() != null) {\n+      setString(to::setBoxAlias, \"DISTRIBUTED - \" + from.getDistributedBoxAlias());\n+      setString(to::setBoxPosition, from.getDistributedBoxPosition());\n+    }\n     return to;\n   }\n \n@@ -4069,6 +4074,9 @@ private static TransferItemDto asDto(@Nonnull TransferItem<?> from) {\n       boxPos.setBox(box);\n       boxPos.setPosition(from.getBoxPosition());\n       boxPositionSetter.accept(toItem, boxPos);\n+    } else {\n+      setString(to::setDistributedBoxAlias, from.getBoxAlias());\n+      setString(to::setDistributedBoxPosition, from.getBoxPosition());\n     }\n     return to;\n   }"
  },
  {
    "sha": "ed15a53d439baa00782276050ec140ec92866887",
    "filename": "miso-service/src/main/java/uk/ac/bbsrc/tgac/miso/service/impl/DefaultTransferService.java",
    "status": "modified",
    "additions": 15,
    "deletions": 1,
    "changes": 16,
    "blob_url": "https://github.com/miso-lims/miso-lims/blob/d06f5f5a40f7e312e861bd34887b6641958791fc/miso-service/src/main/java/uk/ac/bbsrc/tgac/miso/service/impl/DefaultTransferService.java",
    "raw_url": "https://github.com/miso-lims/miso-lims/raw/d06f5f5a40f7e312e861bd34887b6641958791fc/miso-service/src/main/java/uk/ac/bbsrc/tgac/miso/service/impl/DefaultTransferService.java",
    "contents_url": "https://api.github.com/repos/miso-lims/miso-lims/contents/miso-service/src/main/java/uk/ac/bbsrc/tgac/miso/service/impl/DefaultTransferService.java?ref=d06f5f5a40f7e312e861bd34887b6641958791fc",
    "patch": "@@ -1,6 +1,7 @@\n package uk.ac.bbsrc.tgac.miso.service.impl;\n \n import java.io.IOException;\n+import java.math.BigDecimal;\n import java.util.ArrayList;\n import java.util.Date;\n import java.util.HashSet;\n@@ -42,6 +43,7 @@\n import uk.ac.bbsrc.tgac.miso.core.data.impl.transfer.TransferPool;\n import uk.ac.bbsrc.tgac.miso.core.data.impl.transfer.TransferSample;\n import uk.ac.bbsrc.tgac.miso.core.security.AuthorizationManager;\n+import uk.ac.bbsrc.tgac.miso.core.service.BoxService;\n import uk.ac.bbsrc.tgac.miso.core.service.ChangeLogService;\n import uk.ac.bbsrc.tgac.miso.core.service.GroupService;\n import uk.ac.bbsrc.tgac.miso.core.service.LabService;\n@@ -91,6 +93,8 @@\n   @Autowired\n   private ChangeLogService changeLogService;\n   @Autowired\n+  private BoxService boxService;\n+  @Autowired\n   private AuthorizationManager authorizationManager;\n   @Autowired\n   private DeletionStore deletionStore;\n@@ -143,6 +147,9 @@ protected void loadChildEntities(Transfer object) throws IOException {\n   private <T extends Boxable, U extends TransferItem<T>, V extends AbstractBoxPosition> void loadItem(U item, Consumer<T> setter,\n       ProviderService<T> service, Supplier<V> positionConstructor, BiConsumer<T, V> positionSetter) throws IOException {\n     Box box = item.getItem().getBox();\n+    if (box != null) {\n+      box = boxService.get(box.getId());\n+    }\n     String position = item.getItem().getBoxPosition();\n     loadChildEntity(item.getItem(), setter, service);\n     transferStore.detachEntity(item.getItem());\n@@ -451,10 +458,17 @@ private void writeItemsChangeLog(Transfer transfer, String message) throws IOExc\n   protected void beforeValidate(Transfer transfer) throws IOException {\n     Consumer<TransferItem<?>> action = null;\n     if (transfer.isDistribution()) {\n-      // Mark all items received for distribution transfers\n+      // Mark all items received for distribution transfers; record distributed volume and location\n       action = item -> {\n         item.setTransfer(transfer);\n         item.setReceived(true);\n+        if (item.getItem().getVolume() != null && item.getItem().getVolume().compareTo(BigDecimal.ZERO) > 0) {\n+          item.setDistributedVolume(item.getItem().getVolume());\n+        }\n+        if (item.getItem().getBox() != null) {\n+          item.setDistributedBoxAlias(item.getItem().getBox().getAlias());\n+          item.setDistributedBoxPosition(item.getItem().getBoxPosition());\n+        }\n       };\n     } else {\n       action = item -> item.setTransfer(transfer);"
  },
  {
    "sha": "29fe76789057ac81c3002476f37d4cc49fa3c55c",
    "filename": "miso-web/src/main/java/uk/ac/bbsrc/tgac/miso/webapp/context/NotificationManager.java",
    "status": "modified",
    "additions": 28,
    "deletions": 11,
    "changes": 39,
    "blob_url": "https://github.com/miso-lims/miso-lims/blob/d06f5f5a40f7e312e861bd34887b6641958791fc/miso-web/src/main/java/uk/ac/bbsrc/tgac/miso/webapp/context/NotificationManager.java",
    "raw_url": "https://github.com/miso-lims/miso-lims/raw/d06f5f5a40f7e312e861bd34887b6641958791fc/miso-web/src/main/java/uk/ac/bbsrc/tgac/miso/webapp/context/NotificationManager.java",
    "contents_url": "https://api.github.com/repos/miso-lims/miso-lims/contents/miso-web/src/main/java/uk/ac/bbsrc/tgac/miso/webapp/context/NotificationManager.java?ref=d06f5f5a40f7e312e861bd34887b6641958791fc",
    "patch": "@@ -3,6 +3,7 @@\n import static j2html.TagCreator.*;\n \n import java.io.IOException;\n+import java.math.BigDecimal;\n import java.util.ArrayList;\n import java.util.Calendar;\n import java.util.Collection;\n@@ -34,6 +35,7 @@\n import uk.ac.bbsrc.tgac.miso.core.data.Sample;\n import uk.ac.bbsrc.tgac.miso.core.data.impl.LibraryAliquot;\n import uk.ac.bbsrc.tgac.miso.core.data.impl.transfer.Transfer;\n+import uk.ac.bbsrc.tgac.miso.core.data.impl.transfer.TransferItem;\n import uk.ac.bbsrc.tgac.miso.core.data.impl.transfer.TransferLibrary;\n import uk.ac.bbsrc.tgac.miso.core.data.impl.transfer.TransferLibraryAliquot;\n import uk.ac.bbsrc.tgac.miso.core.data.impl.transfer.TransferNotification;\n@@ -319,7 +321,7 @@ private static ContainerTag makeSampleTable(Collection<TransferSample> transferS\n     if (detailed) {\n       headerRow = headerRow.with(makeTh(\"Subproject\"), makeTh(\"Group ID\"), makeTh(\"Group Description\"));\n     }\n-    headerRow = headerRow.with(makeTh(\"Barcode\"));\n+    headerRow = headerRow.with(makeTh(\"Barcode\"), makeTh(\"Location\"));\n \n     List<ContainerTag> rows = new ArrayList<>();\n     for (TransferSample transferSample : transferSamples) {\n@@ -331,32 +333,45 @@ private static ContainerTag makeSampleTable(Collection<TransferSample> transferS\n         cells.add(makeTd(dnaOrRna(detailedSample)));\n         cells.add(makeTd(detailedSample.getIdentityAttributes().getExternalName()));\n       }\n-      cells.add(makeTd(LimsUtils.toNiceString(sample.getVolume())));\n+      BigDecimal volume = transferSample.getDistributedVolume() != null ? transferSample.getDistributedVolume() : sample.getVolume();\n+      cells.add(makeTd(LimsUtils.toNiceString(volume)));\n       cells.add(makeTd(LimsUtils.toNiceString(sample.getConcentration())));\n-      cells.add(makeTd(getYieldString(sample)));\n+      cells.add(makeTd(getYieldString(volume, sample.getConcentration())));\n       if (detailed) {\n         cells.add(makeTd(detailedSample.getSubproject() == null ? null : detailedSample.getSubproject().getAlias()));\n         GroupIdentifiable groupIdEntity = detailedSample.getEffectiveGroupIdEntity();\n         cells.add(makeTd(groupIdEntity == null ? null : groupIdEntity.getGroupId()));\n         cells.add(makeTd(groupIdEntity == null ? null : groupIdEntity.getGroupDescription()));\n       }\n       cells.add(makeTd(sample.getIdentificationBarcode()));\n+      cells.add(makeTd(makeLocationLabel(transferSample)));\n       rows.add(tr().with(cells));\n     }\n \n     return makeTable(headerRow, rows);\n   }\n \n+  private static String makeLocationLabel(TransferItem<?> item) {\n+    if (item.getDistributedBoxAlias() != null) {\n+      return item.getDistributedBoxAlias() + \" \" + item.getDistributedBoxPosition();\n+    } else if (item.getItem().getBox() != null) {\n+      return item.getItem().getBox().getAlias() + \" \" + item.getItem().getBoxPosition();\n+    } else {\n+      return \"Unknown\";\n+    }\n+  }\n+\n   private static ContainerTag makeLibraryTable(Collection<TransferLibrary> transferLibraries) {\n-    ContainerTag headerRow = tr(makeTh(\"Alias\"), makeTh(\"Barcode\"), makeTh(\"Platform\"), makeTh(\"Type\"), makeTh(\"i7 Index Name\"),\n-        makeTh(\"i7 Index\"), makeTh(\"i5 Index Name\"), makeTh(\"i5 Index\"));\n+    ContainerTag headerRow = tr(makeTh(\"Alias\"), makeTh(\"Barcode\"), makeTh(\"Location\"), makeTh(\"Platform\"), makeTh(\"Type\"),\n+        makeTh(\"i7 Index Name\"), makeTh(\"i7 Index\"), makeTh(\"i5 Index Name\"), makeTh(\"i5 Index\"));\n \n     List<ContainerTag> rows = new ArrayList<>();\n     for (TransferLibrary transferLibrary : transferLibraries) {\n       Library library = transferLibrary.getItem();\n       List<DomContent> cells = new ArrayList<>();\n       cells.add(makeTd(library.getAlias()));\n       cells.add(makeTd(library.getIdentificationBarcode()));\n+      cells.add(makeTd(makeLocationLabel(transferLibrary)));\n       cells.add(makeTd(library.getPlatformType().getKey()));\n       cells.add(makeTd(library.getLibraryType().getDescription()));\n       cells.add(makeTd(getIndexName(library, 1)));\n@@ -370,8 +385,8 @@ private static ContainerTag makeLibraryTable(Collection<TransferLibrary> transfe\n   }\n \n   private static ContainerTag makeLibraryAliquotTable(Collection<TransferLibraryAliquot> transferLibraryAliquots) {\n-    ContainerTag headerRow = tr(makeTh(\"Alias\"), makeTh(\"Barcode\"), makeTh(\"Platform\"), makeTh(\"Type\"), makeTh(\"i7 Index Name\"),\n-        makeTh(\"i7 Index\"), makeTh(\"i5 Index Name\"), makeTh(\"i5 Index\"), makeTh(\"Targeted Sequencing\"));\n+    ContainerTag headerRow = tr(makeTh(\"Alias\"), makeTh(\"Barcode\"), makeTh(\"Location\"), makeTh(\"Platform\"), makeTh(\"Type\"),\n+        makeTh(\"i7 Index Name\"), makeTh(\"i7 Index\"), makeTh(\"i5 Index Name\"), makeTh(\"i5 Index\"), makeTh(\"Targeted Sequencing\"));\n \n     List<ContainerTag> rows = new ArrayList<>();\n     for (TransferLibraryAliquot transferLibraryAliquot : transferLibraryAliquots) {\n@@ -380,6 +395,7 @@ private static ContainerTag makeLibraryAliquotTable(Collection<TransferLibraryAl\n       List<DomContent> cells = new ArrayList<>();\n       cells.add(makeTd(libraryAliquot.getAlias()));\n       cells.add(makeTd(libraryAliquot.getIdentificationBarcode()));\n+      cells.add(makeTd(makeLocationLabel(transferLibraryAliquot)));\n       cells.add(makeTd(library.getPlatformType().getKey()));\n       cells.add(makeTd(library.getLibraryType().getDescription()));\n       cells.add(makeTd(getIndexName(library, 1)));\n@@ -393,14 +409,15 @@ private static ContainerTag makeLibraryAliquotTable(Collection<TransferLibraryAl\n   }\n \n   private static ContainerTag makePoolTable(Collection<TransferPool> transferPools) {\n-    ContainerTag headerRow = tr(makeTh(\"Alias\"), makeTh(\"Barcode\"));\n+    ContainerTag headerRow = tr(makeTh(\"Alias\"), makeTh(\"Barcode\"), makeTh(\"Location\"));\n \n     List<ContainerTag> rows = new ArrayList<>();\n     for (TransferPool transferPool : transferPools) {\n       Pool pool = transferPool.getItem();\n       List<DomContent> cells = new ArrayList<>();\n       cells.add(makeTd(pool.getAlias()));\n       cells.add(makeTd(pool.getIdentificationBarcode()));\n+      cells.add(makeTd(makeLocationLabel(transferPool)));\n       rows.add(tr().with(cells));\n     }\n \n@@ -432,9 +449,9 @@ private static String dnaOrRna(DetailedSample sample) {\n     }\n   }\n \n-  private static String getYieldString(Sample sample) {\n-    if (sample.getVolume() != null && sample.getConcentration() != null) {\n-      return LimsUtils.toNiceString(sample.getVolume().multiply(sample.getConcentration()));\n+  private static String getYieldString(BigDecimal volume, BigDecimal concentration) {\n+    if (volume != null && concentration != null) {\n+      return LimsUtils.toNiceString(volume.multiply(concentration));\n     } else {\n       return null;\n     }"
  },
  {
    "sha": "cea0511b4d1bbb91ef051a268a899b8fc6a615ec",
    "filename": "miso-web/src/main/webapp/scripts/list_transferitem.js",
    "status": "modified",
    "additions": 7,
    "deletions": 1,
    "changes": 8,
    "blob_url": "https://github.com/miso-lims/miso-lims/blob/d06f5f5a40f7e312e861bd34887b6641958791fc/miso-web/src/main/webapp/scripts/list_transferitem.js",
    "raw_url": "https://github.com/miso-lims/miso-lims/raw/d06f5f5a40f7e312e861bd34887b6641958791fc/miso-web/src/main/webapp/scripts/list_transferitem.js",
    "contents_url": "https://api.github.com/repos/miso-lims/miso-lims/contents/miso-web/src/main/webapp/scripts/list_transferitem.js?ref=d06f5f5a40f7e312e861bd34887b6641958791fc",
    "patch": "@@ -142,7 +142,13 @@ ListTarget.transferitem = (function() {\n         mData: 'boxId',\n         mRender: function(data, type, full) {\n           if (type === 'display') {\n-            return data ? \"<a href='\" + Urls.ui.boxes.edit(data) + \"'>\" + full.boxAlias + ' ' + full.boxPosition + \"</a>\" : 'Unknown';\n+            if (data) {\n+              return \"<a href='\" + Urls.ui.boxes.edit(data) + \"'>\" + full.boxAlias + ' ' + full.boxPosition + \"</a>\"\n+            } else if (full.boxAlias) {\n+              return full.boxAlias + ' ' + full.boxPosition;\n+            } else {\n+              return 'Unknown';\n+            }\n           }\n           return data;\n         },"
  },
  {
    "sha": "76d1658397bff3c834877e40b2bd719c510c13f6",
    "filename": "sqlstore/src/main/resources/db/migration/V8501__transfer_volume.sql",
    "status": "added",
    "additions": 19,
    "deletions": 0,
    "changes": 19,
    "blob_url": "https://github.com/miso-lims/miso-lims/blob/d06f5f5a40f7e312e861bd34887b6641958791fc/sqlstore/src/main/resources/db/migration/V8501__transfer_volume.sql",
    "raw_url": "https://github.com/miso-lims/miso-lims/raw/d06f5f5a40f7e312e861bd34887b6641958791fc/sqlstore/src/main/resources/db/migration/V8501__transfer_volume.sql",
    "contents_url": "https://api.github.com/repos/miso-lims/miso-lims/contents/sqlstore/src/main/resources/db/migration/V8501__transfer_volume.sql?ref=d06f5f5a40f7e312e861bd34887b6641958791fc",
    "patch": "@@ -0,0 +1,19 @@\n+ALTER TABLE Transfer_Sample\n+  ADD COLUMN distributedVolume DECIMAL(16,10),\n+  ADD COLUMN distributedBoxAlias varchar(255),\n+  ADD COLUMN distributedBoxPosition varchar(3);\n+\n+ALTER TABLE Transfer_Library\n+  ADD COLUMN distributedVolume DECIMAL(16,10),\n+  ADD COLUMN distributedBoxAlias varchar(255),\n+  ADD COLUMN distributedBoxPosition varchar(3);\n+\n+ALTER TABLE Transfer_LibraryAliquot\n+  ADD COLUMN distributedVolume DECIMAL(16,10),\n+  ADD COLUMN distributedBoxAlias varchar(255),\n+  ADD COLUMN distributedBoxPosition varchar(3);\n+\n+ALTER TABLE Transfer_Pool\n+  ADD COLUMN distributedVolume DECIMAL(16,10),\n+  ADD COLUMN distributedBoxAlias varchar(255),\n+  ADD COLUMN distributedBoxPosition varchar(3);"
  }
]

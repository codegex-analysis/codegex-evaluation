[
  {
    "sha": "013dff9efe4a4a521713acb5f5c7db2c1ff3877f",
    "filename": "relay-java/src/main/java/com/genymobile/gnirehtet/Main.java",
    "status": "modified",
    "additions": 27,
    "deletions": 14,
    "changes": 41,
    "blob_url": "https://github.com/mythsman/gnirehtet/blob/57b0d3db29d9a61e1bb07df0147b477c1079ca8e/relay-java/src/main/java/com/genymobile/gnirehtet/Main.java",
    "raw_url": "https://github.com/mythsman/gnirehtet/raw/57b0d3db29d9a61e1bb07df0147b477c1079ca8e/relay-java/src/main/java/com/genymobile/gnirehtet/Main.java",
    "contents_url": "https://api.github.com/repos/mythsman/gnirehtet/contents/relay-java/src/main/java/com/genymobile/gnirehtet/Main.java?ref=57b0d3db29d9a61e1bb07df0147b477c1079ca8e",
    "patch": "@@ -20,12 +20,16 @@\n import com.genymobile.gnirehtet.relay.Log;\n import com.genymobile.gnirehtet.relay.Relay;\n \n+import java.io.FileInputStream;\n import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n import java.util.ArrayList;\n import java.util.Arrays;\n import java.util.Collections;\n import java.util.List;\n import java.util.Scanner;\n+import java.util.concurrent.TimeUnit;\n import java.util.regex.Matcher;\n import java.util.regex.Pattern;\n \n@@ -356,22 +360,31 @@ private static boolean mustInstallClient(String serial) throws InterruptedExcept\n         Log.i(TAG, \"Checking gnirehtet client...\");\n         List<String> command = createAdbCommand(serial, \"shell\", \"dumpsys\", \"package\", \"com.genymobile.gnirehtet\");\n         Log.d(TAG, \"Execute: \" + command);\n-        Process process = new ProcessBuilder(command).start();\n-        int exitCode = process.waitFor();\n-        if (exitCode != 0) {\n-            throw new CommandExecutionException(command, exitCode);\n-        }\n-        Scanner scanner = new Scanner(process.getInputStream());\n-        // read the versionCode of the installed package\n-        Pattern pattern = Pattern.compile(\"^    versionCode=(\\\\p{Digit}+).*\");\n-        while (scanner.hasNextLine()) {\n-            Matcher matcher = pattern.matcher(scanner.nextLine());\n-            if (matcher.matches()) {\n-                String installedVersionCode = matcher.group(1);\n-                return !REQUIRED_APK_VERSION_CODE.equals(installedVersionCode);\n+        Path tmpFile = null;\n+        try {\n+            tmpFile = Files.createTempFile(\"gnirehtet_\" + serial, \".log\");\n+            Process process = new ProcessBuilder(command).redirectOutput(tmpFile.toFile()).start();\n+            boolean exitCode = process.waitFor(10, TimeUnit.SECONDS);\n+            if (!exitCode) {\n+                throw new CommandExecutionException(command, -1);\n+            }\n+            try (Scanner scanner = new Scanner(new FileInputStream(tmpFile.toFile()))) {\n+                // read the versionCode of the installed package\n+                Pattern pattern = Pattern.compile(\"^    versionCode=(\\\\p{Digit}+).*\");\n+                while (scanner.hasNextLine()) {\n+                    Matcher matcher = pattern.matcher(scanner.nextLine());\n+                    if (matcher.matches()) {\n+                        String installedVersionCode = matcher.group(1);\n+                        return !REQUIRED_APK_VERSION_CODE.equals(installedVersionCode);\n+                    }\n+                }\n+            }\n+            return true;\n+        } finally {\n+            if (tmpFile != null) {\n+                tmpFile.toFile().delete();\n             }\n         }\n-        return true;\n     }\n \n "
  }
]

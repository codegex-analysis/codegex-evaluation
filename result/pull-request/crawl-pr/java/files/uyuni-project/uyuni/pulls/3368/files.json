[
  {
    "sha": "2073209e34688860cc0d044b189bf1d5e20182fb",
    "filename": "backend/rhn-conf/rhn_server_xmlrpc.conf",
    "status": "modified",
    "additions": 3,
    "deletions": 0,
    "changes": 3,
    "blob_url": "https://github.com/uyuni-project/uyuni/blob/7e623812fd22c7973e945e9a8d351552cb052888/backend/rhn-conf/rhn_server_xmlrpc.conf",
    "raw_url": "https://github.com/uyuni-project/uyuni/raw/7e623812fd22c7973e945e9a8d351552cb052888/backend/rhn-conf/rhn_server_xmlrpc.conf",
    "contents_url": "https://api.github.com/repos/uyuni-project/uyuni/contents/backend/rhn-conf/rhn_server_xmlrpc.conf?ref=7e623812fd22c7973e945e9a8d351552cb052888",
    "patch": "@@ -25,3 +25,6 @@ cache_package_headers = 1\n entitlement_service_url =\n regnum_service_url =\n user_service_url =\n+\n+# minimal required DB schema version\n+min_schema_version = 4.2.9"
  },
  {
    "sha": "1b5991f48688bdfc6489a4c05d3c6f76cd39002b",
    "filename": "backend/spacewalk-backend.changes",
    "status": "modified",
    "additions": 1,
    "deletions": 0,
    "changes": 1,
    "blob_url": "https://github.com/uyuni-project/uyuni/blob/7e623812fd22c7973e945e9a8d351552cb052888/backend/spacewalk-backend.changes",
    "raw_url": "https://github.com/uyuni-project/uyuni/raw/7e623812fd22c7973e945e9a8d351552cb052888/backend/spacewalk-backend.changes",
    "contents_url": "https://api.github.com/repos/uyuni-project/uyuni/contents/backend/spacewalk-backend.changes?ref=7e623812fd22c7973e945e9a8d351552cb052888",
    "patch": "@@ -1,3 +1,4 @@\n+- define dependency for DB schema version\n - add allow vendor change with patching via rhnstack \n - Fixed kickstart tree permissions to a+r.\n - Avoid race condition due multiple reposync import threads (bsc#1183151)"
  },
  {
    "sha": "e063440be3ba5e757d661582a90a9e942902c616",
    "filename": "backend/tito.props",
    "status": "added",
    "additions": 2,
    "deletions": 0,
    "changes": 2,
    "blob_url": "https://github.com/uyuni-project/uyuni/blob/7e623812fd22c7973e945e9a8d351552cb052888/backend/tito.props",
    "raw_url": "https://github.com/uyuni-project/uyuni/raw/7e623812fd22c7973e945e9a8d351552cb052888/backend/tito.props",
    "contents_url": "https://api.github.com/repos/uyuni-project/uyuni/contents/backend/tito.props?ref=7e623812fd22c7973e945e9a8d351552cb052888",
    "patch": "@@ -0,0 +1,2 @@\n+[dbschema]\n+rhn-conf/rhn_server_xmlrpc.conf=4.2.10"
  },
  {
    "sha": "991839ffa4dd9d11760226e754a81bb66d44fe50",
    "filename": "java/conf/rhn_java.conf",
    "status": "modified",
    "additions": 3,
    "deletions": 0,
    "changes": 3,
    "blob_url": "https://github.com/uyuni-project/uyuni/blob/7e623812fd22c7973e945e9a8d351552cb052888/java/conf/rhn_java.conf",
    "raw_url": "https://github.com/uyuni-project/uyuni/raw/7e623812fd22c7973e945e9a8d351552cb052888/java/conf/rhn_java.conf",
    "contents_url": "https://api.github.com/repos/uyuni-project/uyuni/contents/java/conf/rhn_java.conf?ref=7e623812fd22c7973e945e9a8d351552cb052888",
    "patch": "@@ -229,3 +229,6 @@ java.http_socket_timeout = 300\n \n # Maximum number of actions targetting Salt SSH minions executing at the same time\n taskomatic.com.redhat.rhn.taskomatic.task.SSHMinionActionExecutor.parallel_threads = 20\n+\n+# minimal required DB schema version\n+java.min_schema_version = 4.2.9"
  },
  {
    "sha": "4d981194fcc05a2ae770ad348863f5a83a2c1c78",
    "filename": "java/spacewalk-java.changes",
    "status": "modified",
    "additions": 1,
    "deletions": 0,
    "changes": 1,
    "blob_url": "https://github.com/uyuni-project/uyuni/blob/7e623812fd22c7973e945e9a8d351552cb052888/java/spacewalk-java.changes",
    "raw_url": "https://github.com/uyuni-project/uyuni/raw/7e623812fd22c7973e945e9a8d351552cb052888/java/spacewalk-java.changes",
    "contents_url": "https://api.github.com/repos/uyuni-project/uyuni/contents/java/spacewalk-java.changes?ref=7e623812fd22c7973e945e9a8d351552cb052888",
    "patch": "@@ -1,3 +1,4 @@\n+- define dependencies for salt-netapi-client and DB schema version\n - optionally allow vendor change when patching\n - Speed up the system groups page (bsc#1182132)\n - Log shell command output on failure when checking known_hosts file permissions"
  },
  {
    "sha": "98d8fea417bdf4c5a809c5f586cb3fd33478df46",
    "filename": "java/spacewalk-java.spec",
    "status": "modified",
    "additions": 2,
    "deletions": 2,
    "changes": 4,
    "blob_url": "https://github.com/uyuni-project/uyuni/blob/7e623812fd22c7973e945e9a8d351552cb052888/java/spacewalk-java.spec",
    "raw_url": "https://github.com/uyuni-project/uyuni/raw/7e623812fd22c7973e945e9a8d351552cb052888/java/spacewalk-java.spec",
    "contents_url": "https://api.github.com/repos/uyuni-project/uyuni/contents/java/spacewalk-java.spec?ref=7e623812fd22c7973e945e9a8d351552cb052888",
    "patch": "@@ -243,7 +243,7 @@ Requires:       sitemesh\n Requires:       spacewalk-branding\n Requires:       spacewalk-java-config\n Requires:       spacewalk-java-jdbc\n-Requires:       spacewalk-java-lib\n+Requires:       spacewalk-java-lib = %{version}\n Requires:       stringtree-json\n Requires:       struts >= 1.2.9\n Requires:       woodstox\n@@ -387,7 +387,7 @@ Requires:       quartz\n Requires:       simple-core\n Requires:       spacewalk-java-config\n Requires:       spacewalk-java-jdbc\n-Requires:       spacewalk-java-lib\n+Requires:       spacewalk-java-lib = %{version}\n Requires:       statistics\n Requires:       susemanager-frontend-libs >= 2.1.5\n Requires:       tomcat-taglibs-standard"
  },
  {
    "sha": "1d301973518f0581d74d4c8c7f4372c20d694dca",
    "filename": "java/tito.props",
    "status": "added",
    "additions": 8,
    "deletions": 0,
    "changes": 8,
    "blob_url": "https://github.com/uyuni-project/uyuni/blob/7e623812fd22c7973e945e9a8d351552cb052888/java/tito.props",
    "raw_url": "https://github.com/uyuni-project/uyuni/raw/7e623812fd22c7973e945e9a8d351552cb052888/java/tito.props",
    "contents_url": "https://api.github.com/repos/uyuni-project/uyuni/contents/java/tito.props?ref=7e623812fd22c7973e945e9a8d351552cb052888",
    "patch": "@@ -0,0 +1,8 @@\n+[requires]\n+salt-netapi-client=0.18\n+\n+[buildrequires]\n+salt-netapi-client=0.18\n+\n+[dbschema]\n+conf/rhn_java.conf=4.2.10"
  },
  {
    "sha": "d842e86ca43f78b7e114d45d29e4ca2c02232b1d",
    "filename": "schema/spacewalk/spacewalk-schema-upgrade",
    "status": "modified",
    "additions": 4,
    "deletions": 0,
    "changes": 4,
    "blob_url": "https://github.com/uyuni-project/uyuni/blob/7e623812fd22c7973e945e9a8d351552cb052888/schema/spacewalk/spacewalk-schema-upgrade",
    "raw_url": "https://github.com/uyuni-project/uyuni/raw/7e623812fd22c7973e945e9a8d351552cb052888/schema/spacewalk/spacewalk-schema-upgrade",
    "contents_url": "https://api.github.com/repos/uyuni-project/uyuni/contents/schema/spacewalk/spacewalk-schema-upgrade?ref=7e623812fd22c7973e945e9a8d351552cb052888",
    "patch": "@@ -134,6 +134,10 @@ my $start_schema = $schema_version;\n (my $start_schema_norm = $start_schema) =~ s!^(.+-\\d+(\\.\\d+)*-[a-zA-Z0-9]*)(\\..*)*$!$1!;\n \n print \"Schema upgrade: [$start_schema] -> [$target_schema]\\n\";\n+if ($start_schema eq $target_schema) {\n+    warn \"Your database schema already matches the schema package version [$target_schema].\\n\";\n+    exit;\n+}\n \n my $foundtarget = 0;\n my $retried = 0;"
  },
  {
    "sha": "5ba4f8c40d9f106414b10a2c13dfe4dc1fd1ea03",
    "filename": "spacewalk/admin/spacewalk-admin.changes",
    "status": "modified",
    "additions": 2,
    "deletions": 0,
    "changes": 2,
    "blob_url": "https://github.com/uyuni-project/uyuni/blob/7e623812fd22c7973e945e9a8d351552cb052888/spacewalk/admin/spacewalk-admin.changes",
    "raw_url": "https://github.com/uyuni-project/uyuni/raw/7e623812fd22c7973e945e9a8d351552cb052888/spacewalk/admin/spacewalk-admin.changes",
    "contents_url": "https://api.github.com/repos/uyuni-project/uyuni/contents/spacewalk/admin/spacewalk-admin.changes?ref=7e623812fd22c7973e945e9a8d351552cb052888",
    "patch": "@@ -1,3 +1,5 @@\n+- check minimal required DB schema version during startup\n+\n -------------------------------------------------------------------\n Wed Jan 27 13:00:30 CET 2021 - jgonzalez@suse.com\n "
  },
  {
    "sha": "9a2e615dc32a829a72667b5abf3d22cc1f2cd96c",
    "filename": "spacewalk/admin/spacewalk-startup-helper",
    "status": "modified",
    "additions": 16,
    "deletions": 0,
    "changes": 16,
    "blob_url": "https://github.com/uyuni-project/uyuni/blob/7e623812fd22c7973e945e9a8d351552cb052888/spacewalk/admin/spacewalk-startup-helper",
    "raw_url": "https://github.com/uyuni-project/uyuni/raw/7e623812fd22c7973e945e9a8d351552cb052888/spacewalk/admin/spacewalk-startup-helper",
    "contents_url": "https://api.github.com/repos/uyuni-project/uyuni/contents/spacewalk/admin/spacewalk-startup-helper?ref=7e623812fd22c7973e945e9a8d351552cb052888",
    "patch": "@@ -14,6 +14,21 @@ perform_db_schema_upgrade() {\n     fi\n }\n \n+check_schema_version() {\n+    MIN_JAVA_SCHEMA=$( egrep -m1 \"^java.min_schema_version[[:space:]]*=\" /usr/share/rhn/config-defaults/rhn_java.conf | sed 's/^java.min_schema_version[[:space:]]*=[[:space:]]*\\(.*\\)/\\1/' || echo \"\" )\n+    CMP=$(echo \"select evr_t_compare(X.evr, evr_t('0', '$MIN_JAVA_SCHEMA', '0', 'rpm')) from (select PE.evr from rhnVersionInfo vi join rhnPackageEVR pe on vi.evr_id = pe.id) X;\" | spacewalk-sql --select-mode - | sed -n 3p | xargs)\n+    if [ $CMP -lt 0 ]; then\n+        echo \"Incompatible database schema version detected! Minimal schema version required by Java: $MIN_JAVA_SCHEMA\"\n+        exit 1\n+    fi\n+    MIN_BACK_SCHEMA=$( egrep -m1 \"^min_schema_version[[:space:]]*=\" /usr/share/rhn/config-defaults/rhn_server_xmlrpc.conf | sed 's/^min_schema_version[[:space:]]*=[[:space:]]*\\(.*\\)/\\1/' || echo \"\" )\n+    CMP=$(echo \"select evr_t_compare(X.evr, evr_t('0', '$MIN_BACK_SCHEMA', '0', 'rpm')) from (select PE.evr from rhnVersionInfo vi join rhnPackageEVR pe on vi.evr_id = pe.id) X;\" | spacewalk-sql --select-mode - | sed -n 3p | xargs)\n+    if [ $CMP -lt 0 ]; then\n+        echo \"Incompatible database schema version detected! Minimal schema version required by Backend: $MIN_BACK_SCHEMA\"\n+        exit 1\n+    fi\n+}\n+\n check_database() {\n     RETRIES=10;\n     source /etc/os-release\n@@ -27,6 +42,7 @@ check_database() {\n                 exit 1\n             fi\n             perform_db_schema_upgrade\n+            check_schema_version\n             exit 0 # db is running\n         fi\n "
  }
]

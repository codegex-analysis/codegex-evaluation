[
  {
    "sha": "8643e9330ee79c16fa822c350301726483a6010c",
    "filename": "navigation-extender-runtime/src/main/java/com/foursoft/xml/io/write/XMLWriter.java",
    "status": "modified",
    "additions": 2,
    "deletions": 2,
    "changes": 4,
    "blob_url": "https://github.com/4Soft-de/jaxb-enhanced-navigation/blob/45096e4340a24079f67cfedd70e26081a079c969/navigation-extender-runtime/src/main/java/com/foursoft/xml/io/write/XMLWriter.java",
    "raw_url": "https://github.com/4Soft-de/jaxb-enhanced-navigation/raw/45096e4340a24079f67cfedd70e26081a079c969/navigation-extender-runtime/src/main/java/com/foursoft/xml/io/write/XMLWriter.java",
    "contents_url": "https://api.github.com/repos/4Soft-de/jaxb-enhanced-navigation/contents/navigation-extender-runtime/src/main/java/com/foursoft/xml/io/write/XMLWriter.java?ref=45096e4340a24079f67cfedd70e26081a079c969",
    "patch": "@@ -168,13 +168,13 @@ private void write(final T container, final XMLMeta meta, final Writer output) {\n         final XMLOutputFactory xof = XMLOutputFactory.newFactory();\r\n         try {\r\n             final XMLStreamWriter xmlStreamWriter = xof.createXMLStreamWriter(output);\r\n-            final XMLMetaAwareXMLStreamWriter xsw = new XMLMetaAwareXMLStreamWriter(xmlStreamWriter);\r\n+            final XMLMetaAwareXMLStreamWriter xsw = new XMLMetaAwareXMLStreamWriter(xmlStreamWriter, baseType);\r\n \r\n             final MarshallerListener marshallerListener = new MarshallerListener();\r\n             marshaller.setListener(marshallerListener);\r\n             meta.getComments().ifPresent(c -> marshallerListener.addListener(new CommentAdderListener(xsw, c)));\r\n             meta.getProcessingInstructions()\r\n-                    .ifPresent(c -> marshallerListener.addListener(new ProcessingInstructionAdderListener(xmlStreamWriter, c)));\r\n+                    .ifPresent(c -> marshallerListener.addListener(new ProcessingInstructionAdderListener(xsw, c)));\r\n \r\n             marshaller.marshal(container, xsw);\r\n             xsw.close();\r"
  },
  {
    "sha": "55f693c56729d188fcfedbba7be9d0d1ba12a065",
    "filename": "navigation-extender-runtime/src/main/java/com/foursoft/xml/io/write/xmlmeta/XMLMetaAwareXMLStreamWriter.java",
    "status": "modified",
    "additions": 39,
    "deletions": 4,
    "changes": 43,
    "blob_url": "https://github.com/4Soft-de/jaxb-enhanced-navigation/blob/45096e4340a24079f67cfedd70e26081a079c969/navigation-extender-runtime/src/main/java/com/foursoft/xml/io/write/xmlmeta/XMLMetaAwareXMLStreamWriter.java",
    "raw_url": "https://github.com/4Soft-de/jaxb-enhanced-navigation/raw/45096e4340a24079f67cfedd70e26081a079c969/navigation-extender-runtime/src/main/java/com/foursoft/xml/io/write/xmlmeta/XMLMetaAwareXMLStreamWriter.java",
    "contents_url": "https://api.github.com/repos/4Soft-de/jaxb-enhanced-navigation/contents/navigation-extender-runtime/src/main/java/com/foursoft/xml/io/write/xmlmeta/XMLMetaAwareXMLStreamWriter.java?ref=45096e4340a24079f67cfedd70e26081a079c969",
    "patch": "@@ -33,16 +33,51 @@\n  */\r\n public class XMLMetaAwareXMLStreamWriter extends com.sun.xml.txw2.output.IndentingXMLStreamWriter {\r\n \r\n-    public XMLMetaAwareXMLStreamWriter(final XMLStreamWriter xmlStreamWriter) {\r\n+    private final Class<?> baseType;\r\n+\r\n+    public XMLMetaAwareXMLStreamWriter(final XMLStreamWriter xmlStreamWriter, final Class<?> baseType) {\r\n         super(xmlStreamWriter);\r\n+        this.baseType = baseType;\r\n+    }\r\n+\r\n+    @Override\r\n+    public void writeComment(final String data) throws XMLStreamException {\r\n+        writeComment(data, null);\r\n+    }\r\n+\r\n+    public void writeComment(String data, Object source) throws XMLStreamException {\r\n+        boolean rootElement = isRootElement(source);\r\n+        if (rootElement)  {\r\n+            super.writeComment(data);\r\n+            writeNewline();\r\n+        }  else  {\r\n+            writeNewline();\r\n+            super.writeComment(data);\r\n+        }\r\n     }\r\n \r\n     @Override\r\n-    public void writeComment(final String data)\r\n-            throws XMLStreamException {\r\n+    public void writeProcessingInstruction(String target, String data) throws XMLStreamException {\r\n+        writeProcessingInstruction(target, data, null);\r\n+    }\r\n+\r\n+    public void writeProcessingInstruction(String target, String data, Object source) throws XMLStreamException {\r\n+        boolean rootElement = isRootElement(source);\r\n+        if (rootElement) {\r\n+            super.writeProcessingInstruction(target, data);\r\n+            writeNewline();\r\n+        }  else  {\r\n+            writeNewline();\r\n+            super.writeProcessingInstruction(target, data);\r\n+        }\r\n+    }\r\n+\r\n+    private void writeNewline() throws XMLStreamException {\r\n         writeCharacters(\"\\n\"); // IndentingXMLStreamWriter uses \\n\r\n-        super.writeComment(data);\r\n     }\r\n \r\n+    private boolean isRootElement(Object source)  {\r\n+        return source != null && baseType == source.getClass();\r\n+    }\r\n \r\n }\r"
  },
  {
    "sha": "d8184e8ea81c55304c1ceb645fabf08bd7135f2e",
    "filename": "navigation-extender-runtime/src/main/java/com/foursoft/xml/io/write/xmlmeta/comments/CommentAdderListener.java",
    "status": "modified",
    "additions": 4,
    "deletions": 4,
    "changes": 8,
    "blob_url": "https://github.com/4Soft-de/jaxb-enhanced-navigation/blob/45096e4340a24079f67cfedd70e26081a079c969/navigation-extender-runtime/src/main/java/com/foursoft/xml/io/write/xmlmeta/comments/CommentAdderListener.java",
    "raw_url": "https://github.com/4Soft-de/jaxb-enhanced-navigation/raw/45096e4340a24079f67cfedd70e26081a079c969/navigation-extender-runtime/src/main/java/com/foursoft/xml/io/write/xmlmeta/comments/CommentAdderListener.java",
    "contents_url": "https://api.github.com/repos/4Soft-de/jaxb-enhanced-navigation/contents/navigation-extender-runtime/src/main/java/com/foursoft/xml/io/write/xmlmeta/comments/CommentAdderListener.java?ref=45096e4340a24079f67cfedd70e26081a079c969",
    "patch": "@@ -25,24 +25,24 @@\n  */\r\n package com.foursoft.xml.io.write.xmlmeta.comments;\r\n \r\n+import com.foursoft.xml.io.write.xmlmeta.XMLMetaAwareXMLStreamWriter;\r\n import org.slf4j.Logger;\r\n import org.slf4j.LoggerFactory;\r\n \r\n import javax.xml.bind.Marshaller.Listener;\r\n import javax.xml.stream.XMLStreamException;\r\n-import javax.xml.stream.XMLStreamWriter;\r\n import java.util.Optional;\r\n \r\n public class CommentAdderListener extends Listener {\r\n     private static final Logger LOGGER = LoggerFactory.getLogger(CommentAdderListener.class);\r\n-    private final XMLStreamWriter xsw;\r\n+    private final XMLMetaAwareXMLStreamWriter xsw;\r\n     private final Comments comments;\r\n \r\n     /**\r\n      * @param xsw      the xml stream writer\r\n      * @param comments map of xjc objects and comment strings\r\n      */\r\n-    public CommentAdderListener(final XMLStreamWriter xsw, final Comments comments) {\r\n+    public CommentAdderListener(final XMLMetaAwareXMLStreamWriter xsw, final Comments comments) {\r\n         this.xsw = xsw;\r\n         this.comments = comments;\r\n     }\r\n@@ -52,7 +52,7 @@ public void beforeMarshal(final Object source) {\n         final Optional<String> comment = comments.get(source);\r\n         if (comment.isPresent()) {\r\n             try {\r\n-                xsw.writeComment(comment.get());\r\n+                xsw.writeComment(comment.get(), source);\r\n             } catch (final XMLStreamException e) {\r\n                 LOGGER.warn(\"Ignored Exception while writing comments:\", e);\r\n             }\r"
  },
  {
    "sha": "9863a24c9fc34e1dc66165550eb4ed752c8bbcfb",
    "filename": "navigation-extender-runtime/src/main/java/com/foursoft/xml/io/write/xmlmeta/processinginstructions/ProcessingInstructionAdderListener.java",
    "status": "modified",
    "additions": 4,
    "deletions": 4,
    "changes": 8,
    "blob_url": "https://github.com/4Soft-de/jaxb-enhanced-navigation/blob/45096e4340a24079f67cfedd70e26081a079c969/navigation-extender-runtime/src/main/java/com/foursoft/xml/io/write/xmlmeta/processinginstructions/ProcessingInstructionAdderListener.java",
    "raw_url": "https://github.com/4Soft-de/jaxb-enhanced-navigation/raw/45096e4340a24079f67cfedd70e26081a079c969/navigation-extender-runtime/src/main/java/com/foursoft/xml/io/write/xmlmeta/processinginstructions/ProcessingInstructionAdderListener.java",
    "contents_url": "https://api.github.com/repos/4Soft-de/jaxb-enhanced-navigation/contents/navigation-extender-runtime/src/main/java/com/foursoft/xml/io/write/xmlmeta/processinginstructions/ProcessingInstructionAdderListener.java?ref=45096e4340a24079f67cfedd70e26081a079c969",
    "patch": "@@ -24,23 +24,23 @@\n  * =========================LICENSE_END==================================\r\n  */\r\n \r\n+import com.foursoft.xml.io.write.xmlmeta.XMLMetaAwareXMLStreamWriter;\r\n import org.slf4j.Logger;\r\n import org.slf4j.LoggerFactory;\r\n \r\n import javax.xml.bind.Marshaller.Listener;\r\n import javax.xml.stream.XMLStreamException;\r\n-import javax.xml.stream.XMLStreamWriter;\r\n \r\n public class ProcessingInstructionAdderListener extends Listener {\r\n     private static final Logger LOGGER = LoggerFactory.getLogger(ProcessingInstructionAdderListener.class);\r\n-    private final XMLStreamWriter xsw;\r\n+    private final XMLMetaAwareXMLStreamWriter xsw;\r\n     private final ProcessingInstructions processingInstructions;\r\n \r\n     /**\r\n      * @param xsw                    the xml stream writer\r\n      * @param processingInstructions list of xjc objects and comment strings\r\n      */\r\n-    public ProcessingInstructionAdderListener(final XMLStreamWriter xsw, final ProcessingInstructions processingInstructions) {\r\n+    public ProcessingInstructionAdderListener(final XMLMetaAwareXMLStreamWriter xsw, final ProcessingInstructions processingInstructions) {\r\n         this.xsw = xsw;\r\n         this.processingInstructions = processingInstructions;\r\n     }\r\n@@ -52,7 +52,7 @@ public void beforeMarshal(final Object source) {\n             final String data = processingInstruction.getData();\r\n \r\n             try {\r\n-                xsw.writeProcessingInstruction(target, data);\r\n+                xsw.writeProcessingInstruction(target, data, source);\r\n             } catch (final XMLStreamException e) {\r\n                 LOGGER.warn(\"Ignored Exception while writing processingInstruction:\", e);\r\n             }\r"
  },
  {
    "sha": "da48fc2f99dd5db0a9a98b8c82c2c687d816f2bb",
    "filename": "navigation-extender-runtime/src/test/java/com/foursoft/xml/io/write/XMLWriterTest.java",
    "status": "modified",
    "additions": 16,
    "deletions": 1,
    "changes": 17,
    "blob_url": "https://github.com/4Soft-de/jaxb-enhanced-navigation/blob/45096e4340a24079f67cfedd70e26081a079c969/navigation-extender-runtime/src/test/java/com/foursoft/xml/io/write/XMLWriterTest.java",
    "raw_url": "https://github.com/4Soft-de/jaxb-enhanced-navigation/raw/45096e4340a24079f67cfedd70e26081a079c969/navigation-extender-runtime/src/test/java/com/foursoft/xml/io/write/XMLWriterTest.java",
    "contents_url": "https://api.github.com/repos/4Soft-de/jaxb-enhanced-navigation/contents/navigation-extender-runtime/src/test/java/com/foursoft/xml/io/write/XMLWriterTest.java?ref=45096e4340a24079f67cfedd70e26081a079c969",
    "patch": "@@ -63,11 +63,26 @@ void writeToStringWithComments() {\n         final Comments comments = new Comments();\r\n         final String expectedComment = \"Blafasel\";\r\n         comments.put(root.getChildA().get(0), expectedComment);\r\n+        comments.put(root, \"Hello World\");\r\n         final XMLMeta xmlMeta = new XMLMeta();\r\n         xmlMeta.setComments(comments);\r\n+        final ProcessingInstructions processingInstructions = new ProcessingInstructions();\r\n+        processingInstructions.put(root, new ProcessingInstruction(\"pc\", \"pc test\"));\r\n+        processingInstructions.put(root.getChildA().get(1), new ProcessingInstruction(\"pc\", \"pc test 2\"));\r\n+        xmlMeta.setProcessingInstructions(processingInstructions);\r\n         final String result = xmlWriter.writeToString(root, xmlMeta);\r\n         assertFalse(validationEventCollector.hasEvents(), \"Should produce no errors!\");\r\n-        Assertions.assertThat(result).contains(expectedComment);\r\n+        Assertions.assertThat(result)\r\n+                .contains(expectedComment)\r\n+        // check for correct new lines\r\n+                .startsWith(\"<?xml version=\\\"1.0\\\" ?>\\n\" +\r\n+                        \"<!--Hello World-->\\n\" +\r\n+                        \"<?pc pc test?>\\n\" +\r\n+                        \"<Root id=\\\"id_1\\\">\")\r\n+                .contains(\">\\n\" +\r\n+                        \"<?pc pc test 2?>\\n\" +\r\n+                        \"  <\")\r\n+                .doesNotContain(\"\\n\\n\");\r\n     }\r\n \r\n     @Test\r"
  }
]
